---
title: "SGG - Manuscript Figures - Pond Update"
author: "André Soares"
date: "6 March 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r initial loadings, message=FALSE, warning=FALSE, include=FALSE}
library(dada2); packageVersion("dada2")
library(ggplot2); packageVersion("ggplot2")
library(phyloseq); packageVersion("phyloseq")
library(data.table); packageVersion("data.table")
library(dplyr)
library(plyr)
library(magrittr)
library(RColorBrewer)
library(picante)
library(igraph)
library(cowplot)
library(plotly)
library(lemon)
library(GGally)
library(randomcoloR)
library(knitr)
library(kableExtra)
library(ggpmisc)
library(ggpubr)
library(decontam)
library(speedyseq)
```

```{r load SV data, echo=FALSE, message=FALSE, warning=FALSE}
SGG_SVt = readRDS("seqtab_final.rds")
sgg_metadata<-read.csv("SGG_hydro_and_geochemistry_v3_tidy_mM_wctls.csv", header=TRUE)
#update to SILVA_132
# tax_final_s132 <- assignTaxonomy(SGG_SVt, "silva_nr_v132_train_set.fa.gz", multithread=12)
# saveRDS(tax_final_s132, "tax_final_s132.rds")
SGG_Tax = readRDS("tax_final_s132.rds")
order<-rownames(SGG_SVt)
sgg_metadata_ord<-sgg_metadata[match(order, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord) <- sgg_metadata_ord$Sample_Code
ps <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord), 
               tax_table(SGG_Tax))

ps.a = subset_samples(ps, Site.name != "Taff's Well PUMPED")
#removing contaminants
sample_data(ps.a)$is.neg <- sample_data(ps.a)$Sample_type == "Control"
contamdf.prev <- isContaminant(ps.a, method="prevalence", threshold = 0.5,
                               neg="is.neg")
ps.noncontam <- prune_taxa(!contamdf.prev$contaminant, ps.a)
ps.b = subset_samples(ps.noncontam, Sample_type != "Control")
ps.b <- prune_taxa(taxa_sums(ps.b) > 0, ps.b)
#order months
sample_data(ps.b)$Month = factor(sample_data(ps.b)$Month, 
                                 levels = c("April","August","December"))
#to relative abundances
ps.b = subset_taxa(ps.b, Kingdom %in% c("Archaea", "Bacteria"))
ps.b = subset_samples(ps.b, Site.name != "Taff's Well PUMPED")
ps.b.r <-  transform_sample_counts(ps.b, function(x) {x/sum(x)} )
ps.b.r.f = filter_taxa(ps.b.r, function(x) sum(x) > .001, TRUE)

ps.b = subset_samples(ps.a, Sample_type != "Control")
ps.b <- prune_taxa(taxa_sums(ps.b) > 0, ps.b)
#order months
sample_data(ps.b)$Month = factor(sample_data(ps.b)$Month, 
                                 levels = c("April","August","December"))

nmds_ps.b.r_colors_by_name = c("Celynen North" = "#440a31",
                               "Crumlin Navigation" = "#aa4455",
                               "Six Bells" = "#ef7ac8",
                               "Blaenavon" = "#08243f",
                               "Cefn Hengoed" = "#4488aa",
                               "Dinas" = "#8cc5ff",
                               "Glyncastle" = "#0c4c2c",
                               "Morlais" = "#03a353",
                               "Mountain Gate" = "#89d6af",
                               "Taff Bargoed" = "#774411",
                               "Ynysarwed" = "#ff9430",
                               "Lindsay" = "#DDAA77",
                               "Taff's Well" = "#cec400")
nmds_ps.b.r_shapes_by_name = c(15,
                               16,
                               17)
```

###**Figure 1:** Site map w/ regional geology highlighted.

###**Figure 2a:** High-level taxonomic view of the dataset:

```{r general proteobacterial taxonomy, echo=FALSE}
ps.b.r.glom <- speedyseq::tax_glom(ps.b.r, taxrank = 'Phylum', NArm = FALSE)
# saveRDS(ps.b.r.glom, "/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_R/ps.b.r.glom.rds")
# ps.b.r.glom = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_R/ps.b.r.glom.rds")
ps.b.r.glom.psdf <- data.table(speedyseq::psmelt(ps.b.r.glom))
ps.b.r.glom.psdf$Phylum <- as.character(ps.b.r.glom.psdf$Phylum)

ps.b.r.glom.psdf[, median := median(Abundance, na.rm = TRUE), 
                 by = "Phylum"]
ps.b.r.glom.psdf[(median <= 0.01), Phylum := "Other (<1%)"]
ps.b.r.glom.psdf[(median <= 0.01), Class := "Other"]
ps.b.r.glom.psdf$Phylum[is.na(ps.b.r.glom.psdf$Phylum)] <- "Other (<1%)"
# ps.b.r.glom.psdf$Class[is.na(ps.b.r.glom.psdf$Class)] <- "Other"
ps.b.r.glom.psdf$Phylum[is.na(ps.b.r.glom.psdf$Phylum) & ps.b.r.glom.psdf$Kingdom=="Bacteria"] <- "Unc. Bacteria"
ps.b.r.glom.psdf$Phylum[is.na(ps.b.r.glom.psdf$Phylum) & ps.b.r.glom.psdf$Kingdom=="Archaea"] <- "Unc. Archaea"
#Removing Proteobacteria from previous table
ps.b.r.glom.psdf.noProteo<-ps.b.r.glom.psdf[!grepl("Proteobacteria", ps.b.r.glom.psdf$Phylum),]
#New table, with Proteobacterial classes only
ps.b.r.ProtCl = subset_taxa(ps.b.r, Phylum == "Proteobacteria")
ps.b.r.ProtClglom <- speedyseq::tax_glom(ps.b.r.ProtCl, taxrank = 'Class', NArm = FALSE)
ps.b.r.ProtClglom.psdf <- data.table(speedyseq::psmelt(ps.b.r.ProtClglom))
ps.b.r.ProtClglom.psdf$Class <- as.character(ps.b.r.ProtClglom.psdf$Class)

ps.b.r.ProtClglom.psdf[, median := median(Abundance, na.rm = TRUE), 
                        by = "Class"]
ps.b.r.ProtClglom.psdf[(median <= 0.01), Class := "Other Proteobacteria"]
ps.b.r.ProtClglom.psdf.noP <- subset(ps.b.r.ProtClglom.psdf, select = -Phylum)

#Removing Gammaproteobacteria from previous table
ps.b.r.ProtClglom.psdf.noP<-ps.b.r.ProtClglom.psdf.noP[!grepl("Gammaproteobacteria",
                                                               ps.b.r.ProtClglom.psdf.noP$Class),]
#New table, with Proteobacterial classes only
ps.b.r.GProtCl = subset_taxa(ps.b.r, Class == "Gammaproteobacteria")
ps.b.r.GProtClglom <- speedyseq::tax_glom(ps.b.r.GProtCl, taxrank = 'Order', NArm = FALSE)
ps.b.r.GProtClglom.psdf <- data.table(speedyseq::psmelt(ps.b.r.GProtClglom))
ps.b.r.GProtClglom.psdf$Order <- as.character(ps.b.r.GProtClglom.psdf$Order)

ps.b.r.GProtClglom.psdf[, median := median(Abundance, na.rm = TRUE), 
                        by = "Order"]
ps.b.r.GProtClglom.psdf[(median <= 0.01), Order := "Other Gammaproteobacteria"]
ps.b.r.GProtClglom.psdf.noP <- subset(ps.b.r.GProtClglom.psdf, select = -Phylum)
ps.b.r.GProtClglom.psdf.noP <- subset(ps.b.r.GProtClglom.psdf.noP, select = -Class)

names(ps.b.r.glom.psdf.noProteo)[names(ps.b.r.glom.psdf.noProteo) == 'Phylum'] <- 'Taxa'
names(ps.b.r.ProtClglom.psdf.noP)[names(ps.b.r.ProtClglom.psdf.noP) == 'Class'] <- 'Taxa'
names(ps.b.r.GProtClglom.psdf.noP)[names(ps.b.r.GProtClglom.psdf.noP) == 'Order'] <- 'Taxa'

ps.b.r.ProteoClAllPhy <- rbind(ps.b.r.glom.psdf.noProteo, 
                               ps.b.r.ProtClglom.psdf.noP,
                               ps.b.r.GProtClglom.psdf.noP,
                               fill=TRUE)
ps.b.r.ProteoClAllPhy$Taxa[is.na(ps.b.r.ProteoClAllPhy$Taxa)] <- "Other (<1%)"
ps.b.r.ProteoClAllPhy$Site.name = factor(ps.b.r.ProteoClAllPhy$Site.name, 
                                    levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                               "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                               "Morlais","Mountain Gate","Taff Bargoed",
                                               "Ynysarwed","Lindsay","Taff's Well"))

ps.b.r.ProteoClAllPhy$Taxa = factor(ps.b.r.ProteoClAllPhy$Taxa, 
            levels = c("Epsilonbacteraeota",
                       "Deltaproteobacteria", 
                       "Betaproteobacteriales","Other Gammaproteobacteria",
                       "Other Proteobacteria",
                       "Actinobacteria",
                       "Nitrospirae",
                       "Bacteroidetes",
                       "Omnitrophicaeota",
                       "Patescibacteria",
                       "Other (<1%)"))
ps.b.r.ProteoClAllPhy.plot<-ggplot(ps.b.r.ProteoClAllPhy, 
                                    aes(x = Site.name, y = Abundance/3, fill = Taxa)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity", colour="black") +
  scale_fill_manual(values = brewer.pal(11, "Paired"),
                     na.value = "gray40") +
  scale_y_continuous(expand = c(0,0),
                     labels = scales::percent,
                     breaks = c(0.25,0.5,0.75,1)) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size=16,
                                   angle = 35, hjust = 1),
        axis.title.y = element_text(size=18, face = "bold"),
        axis.text.y = element_text(size=17),
        strip.text.x = element_text(face = "bold",
                                    size = 18),
        strip.text.y = element_text(face = "bold",
                                    size = 18),
        strip.background = element_rect(size=1),
        legend.text = element_text(size= 16),
        legend.title = element_text(size=18, face="bold")) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance (%)\n")
```
```{r echo=FALSE, fig.height=14, fig.width=20}
ps.b.r.ProteoClAllPhy.plot
```

###**Figure 2b:** CAP with normalised metadata variables, groups highlighted.

Which metadata variables explains the most microbial community structure in this dataset?
adonis ~ PERMANOVA (http://cc.oulu.fi/~jarioksa/softhelp/vegan/html/adonis.html)
(Working only with variables measured for all samples)

```{r echo=FALSE, message=FALSE, warning=FALSE}
ps_jsd <- phyloseq::distance(ps.b.r, method = "jsd")
sampledf <- as(sample_data(ps.b.r), "data.frame")
sampledf$DO[is.na(sampledf$DO)] <- 44.1
sampledf$pH[is.na(sampledf$pH)] <- 7.29

adonis(ps_jsd ~ Pond_L + Month + Batch + Temp.C + pH + EC.uS.cm + Ca + DO + Mg + K + Na + Cl + NO3 + X6_Li + X7_Li + X7_Li_He + X9_Be + X11_B + X27_Al + X45_Sc + X47_Ti_ + X51_V_He + X52_Cr_He + X55_Mn +   X56_Fe_He +  X59_Co +   X60_Ni +   X63_Cu +   X68_Zn +   X65_Ga +   X75_As_He +  X78_Se +  X85_Rb +   X88_Sr +   X89_Y +    X90_Zr +  X93_Nb +   X97_Mo +   X98_Mo +   X111_Cd +  X114_Cd +  X115_In +  X123_Sb +  X125_Te +  X133_Cs +  X135_Ba +  X139_La +  X140_Ce +  X141_Pr + X146_Nd +  X147_Sm +  X153_Eu +  X157_Gd +  X159_Tb +  X163_Dy +  X165_Ho + X166_Er +  X169_Tm +  X172_Yb +  X175_Lu +  X181_Ta +  X182_W +  X200_Hg +  X201_Hg +  X202_Hg +  X205_Tl +  X206_Pb +  X207_Pb +  X209_Bi + X232_Th +  X238_U,
       data = sampledf,
       strata = sampledf$Time_point,
       permutations=1e3)
```

i.e. 82.99% of the variation in the dataset is explained by site (p<0.001).

Keeping all variables with p <0.01 for the CAP: ```Site.name```,```Month```,```Temp.C```,```Cl```,```SO4```,```X27_Al```,```X47_Ti_```,```X55_Mn```,```X74_Ge```,```X89_Y```, but also others that are known to explain the Beta/Epsilonproteobacteria ratio, ```Ca```, ```Na```, ```X11_B```.

```{r include=FALSE, message=FALSE, warning=FALSE}
metadata<-as(sample_data(ps.b.r),"data.frame")
metadata$DO[is.na(metadata$DO)] <- 44.1
metadata<-metadata[!(metadata$Sample_Code=="73"),]
metadata<-metadata[!(metadata$Sample_Code=="74"),]
metadata<-metadata[!(metadata$Sample_Code=="75"),]

metadata_noNA = metadata[ , colSums(is.na(metadata)) == 0]

ps_sig <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
                   sample_data(metadata_noNA),
                   tax_table(SGG_Tax))
sample_data(ps_sig)$Month = factor(sample_data(ps_sig)$Month,
                                   levels = c("April","August","December","Control"))
ps_sig_ntf = subset_samples(ps_sig, Site.name != "Taff's Well PUMPED")
ps_sig_ntf_nc = subset_samples(ps_sig_ntf, Sample_type != "Control")
ps_sig_ntf_nc_noab = subset_taxa(ps_sig_ntf_nc, Kingdom %in% c("Archaea", "Bacteria"))
ps_cap_r = transform_sample_counts(ps_sig_ntf_nc_noab, function(x) x/sum(x))

set.seed(1)
# Calculate Jensen-Shannon distance matrix
ps_cap_r_jsd <- phyloseq::distance(ps_cap_r, method = "jsd")
# make a data frame from the sample_data
sampledf_cap <- data.frame(sample_data(ps_cap_r))

sample_data(ps.b.r)$Site.name = factor(sample_data(ps.b.r)$Site.name,
                                          levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taff's Well"))
norm_metadata<-sgg_metadata
order_2<-rownames(otu_table(ps_cap_r))
sgg_metadata_ord_norm<-norm_metadata[match(order_2, norm_metadata$Sample_Code),]
rownames(sgg_metadata_ord_norm) <- sgg_metadata_ord_norm$Sample_Code

sgg_metadata_ord_norm$DO[is.na(sgg_metadata_ord_norm$DO)] <- 44.1

ps_cap_r_norm <- phyloseq(otu_table(ps_cap_r),
                       tax_table(ps_cap_r),
                       sample_data(sgg_metadata_ord_norm))

#CAP with significant normalised variables
CAP_ps_cap_r_norm <- ordinate(ps_cap_r_norm,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                           formula = ~ Pond_L + Month + Temp.C + DO + Cl + Na + Ca + Mg + X47_Ti_)

CAP_cols = nmds_ps.b.r_colors_by_name

sample_data(ps_cap_r_norm)$Month = as.character(sample_data(ps_cap_r_norm)$Month)

CAP_norm_sig_plot_a12 <- plot_ordination(ps_cap_r_norm,
                                    ordination = CAP_ps_cap_r_norm, 
                                    color = "Site.name", axes = c(1,2)) +
  geom_point(aes(colour = Site.name,shape = Month), alpha = 0.7, size = 4) +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(aes(colour = Site.name), size = 1.5)+
  scale_color_manual(values = CAP_cols) +
  scale_fill_manual(values = CAP_cols)

arrowmat_CAP_norm <- vegan::scores(CAP_ps_cap_r_norm, display = "bp")
arrowmat_CAP_norm<-subset(arrowmat_CAP_norm,
                           rownames(arrowmat_CAP_norm) %in% c("Pond_Ltwelve","Pond_Leleven","Pond_Ltwo","Temp.C","Cl","DO","Na","Ca","Mg","X47_Ti_"))
arrowdf_CAP_norm <- data.frame(labels = rownames(arrowmat_CAP_norm), arrowmat_CAP_norm)
rownames(arrowdf_CAP_norm) <- c("Pond 12","Pond 11","Pond 2","Temp","DO","Cl","Na","Ca","Mg","Ti")
arrowdf_CAP_norm$labels <- c("Pond 11","Pond 12","Pond 2","Temp","DO","Cl","Na","Ca","Mg","Ti")

arrow_map_CAP_norm <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP_norm <- aes(x = 1.1 * CAP1, y = 1.3 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP_norm = arrow(length = unit(0.02, "npc"))

CAP_norm_sig_plot_a12 = CAP_norm_sig_plot_a12 +
  geom_segment(mapping = arrow_map_CAP_norm, size = .5,
               data = arrowdf_CAP_norm, color = "gray", arrow = arrowhead_CAP_norm) +
  geom_text(mapping = label_map_CAP_norm,
            fill = "white", alpha=.7,
            size = 4, fontface="bold",
            data = arrowdf_CAP_norm, show.legend = FALSE)

arrowmat_CAP_norm_13 <- vegan::scores(CAP_ps_cap_r_norm, display = "bp", choices=c(1,3))
arrowmat_CAP_norm_13<-subset(arrowmat_CAP_norm_13,
                           rownames(arrowmat_CAP_norm_13) %in% c("Pond_Ltwelve","Pond_Leleven","Pond_Ltwo","Temp.C","Cl","DO","Na","Ca","Mg","X47_Ti_"))
arrowdf_CAP_norm_13 <- data.frame(labels = rownames(arrowmat_CAP_norm_13), arrowmat_CAP_norm_13)
rownames(arrowdf_CAP_norm_13) <- c("Pond 12","Pond 11","Pond 2","Temp","DO","Cl","Na","Ca","Mg","Ti")
arrowdf_CAP_norm_13$labels <-c("Pond 11","Pond 12","Pond 2","Temp","DO","Cl","Na","Ca","Mg","Ti")

arrow_map_CAP_norm_13 <- aes(xend = CAP1, yend = CAP3,
                        x = 0, y = 0,
                        shape = NULL, color = NULL,
                        label = labels)
label_map_CAP_norm_13 <- aes(x = 1.1 * CAP1, y = 1.3 * CAP3,
                        shape = NULL, color = NULL,
                        label = labels)
arrowhead_CAP_norm_13 = arrow(length = unit(0.02, "npc"))

CAP_norm_sig_plot_a13 <- plot_ordination(ps_cap_r_norm,
                                    ordination = CAP_ps_cap_r_norm, color = "Site.name",axes = c(1,3)) +
  geom_point(aes(colour = Site.name,shape = Month), alpha = 0.7, size = 4) +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(aes(colour = Site.name), size = 1.5) +
  geom_segment(mapping = arrow_map_CAP_norm_13, size = .5,
               data = arrowdf_CAP_norm_13, color = "gray", arrow = arrowhead_CAP_norm_13) +
  geom_text(mapping = label_map_CAP_norm_13, 
            size = 4, fontface="bold",
            fill = "white", alpha=.7,
            data = arrowdf_CAP_norm_13, show.legend = FALSE)+
  scale_color_manual(values = CAP_cols) +
  scale_fill_manual(values = CAP_cols) +
  scale_shape_manual("Month",
                     values = nmds_ps.b.r_shapes_by_name,
                     labels = c("April","August","December"))

ps.b.r.CAP_norm_sig.plot<-plot_grid(
  CAP_norm_sig_plot_a12+
    theme_bw() +
    theme(legend.position = "none"), 
  CAP_norm_sig_plot_a13+
    theme_bw() +
    theme(legend.position = "none"),
                               labels=c("A","B"), ncol = 2)
legend <- get_legend(CAP_norm_sig_plot_a13 + 
                       guides(shape = guide_legend(nrow = 3,
                                                   title.theme = element_text(face="bold")),
                              color = guide_legend(nrow = 4, 
                                                   title = "Sites",
                                                   title.theme = element_text(face="bold"),
                                                   override.aes=list(fill=NA)),
                              fill = F) +
                       theme(legend.position = "bottom"))
ps.b.r.CAP_norm_sig.plot.legend = plot_grid(ps.b.r.CAP_norm_sig.plot,
                                            legend,
                                            ncol = 1, rel_heights = c(1, .3))
```
```{r echo=FALSE, fig.height=6, fig.width=10}
ps.b.r.CAP_norm_sig.plot.legend
```

```{r echo=FALSE}
CAP_ps_cap_r_norm
screeplot(CAP_ps_cap_r_norm)
anova(CAP_ps_cap_r_norm, by="axis", perm.max=1e3)
anova(CAP_ps_cap_r_norm, by="terms", perm.max=1e3)
```

###**Figure 2c:** Beta- to Epsilonproteobacteria ratio vs. Boron, Na, Ca values (in mM):

```{r echo=FALSE, message=FALSE, warning=FALSE}
ps.b.r.f.be = subset_taxa(ps.b.r.f, 
                            Order == "Betaproteobacteriales" | Phylum == "Epsilonbacteraeota")
phyloGlom = speedyseq::tax_glom(ps.b.r.f.be, "Class")
glomTax = tax_table(phyloGlom)[,"Class"]
glomOTU = otu_table(phyloGlom)
glomTable = merge(glomOTU,glomTax,by=0,all=TRUE)
colnames(glomTable) = c("SGG_ID","Betaproteobacteria", "Epsilonproteobacteria","bah")
glomTable$bah = NULL
remove = c("TGGGGAATATTACACAATGGAGGAAACTCTGATGTAGCAACGCCGCGTGGAGGATGACACATTTCGGTGCGTAAACTCCTTTTATTAGGGAAGATAATGACGGTACCTAATGAATAAGCACCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGTGCAAGCGTTACTCGGAATCACTGGGCGTAAAGCGCATGTAGGCGGTCTTGTAAGTTGGGTGTGAAAGCCTATGGCTCAACCATAGAACTGCACCCAAAACTACTAGACTAGAGTCTGGGAGAGGAAAATGGAATTAGTTGTGTAGGGGTAAAATCCGTAGAGATAACTAGGAATACCAAAAGCGAAGGCAATTTTCTGGAACAGTACTGACGCTCAGATGCGAAAGCGTGGGTAGCAAACA",
           "TGGGGAATTTTGGACAATGGGCGCAAGCCTGATCCAGCCATGCCGCGTGAGTGAAGAAGGCCTTCGGGTTGTAAAGCTCTTTCGGACAGAAAGAAATCGCACAGGCTAATACTCTGTGTGGATGACGGTACTGTAAGAAGAAGCACCGGCTAACTACGTGCCAGCAGCCGCGGTAATACGTAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGTGCGCAGGCGGCTTTTTAAGACAGATGTGAAATCCCCGGGCTCAACCTGGGAACTGCATTTGTGACTGGAAGGCTAGAGTGTAGCAGAGGGGGGTAGAATTCCACGTGTAGCAGTGAAATGCGTAGAGATGTGGAGGAATACCGATGGCGAAGGCAGCCCCCTGGGCTAACACTGACGCTCATGCACGAAAGCGTGGGGAGCAAACA")
glomTablefinal = glomTable[-which(glomTable$SGG_ID %in% remove), ]
glomTablefinal$EpsBetRatio = (glomTablefinal$Epsilonproteobacteria/(glomTablefinal$Epsilonproteobacteria + glomTablefinal$Betaproteobacteria))

glomTablefinal=glomTablefinal[-c(73, 74, 75), ]
order_3<-glomTablefinal$SGG_ID
# colnames(sgg_metadata)
# colnames(sgg_metadata) <- c("Case","Sample_ID","Sample_Code","Site_ID","Batch",
#                                  "Sample_type","Site.name","Site_name_plot","Site_type","Time_point",
#                                  "Month","Date", "Time","Temperature","pH","EC",
#                                  "DO","Ca","K","Mg","Na",
#                                  "F","Cl","NO3","SO4","6_Li",
#                                  "7_Li","7_Li_He","Be",
#                                  "11_B","Al","Sc","Ti","V_He",
#                                  "Cr","Cr_He","Mn","Fe_He","Co",
#                                  "Ni","Cu","Zn","Ga","Ge",
#                                  "As","Se","Rb","Sr","Y",
#                                  "Zr","Nb","97_Mo","98_Mo","111_Cd",
#                                  "114_Cd","In","Sn","Sb","Te",
#                                  "Cs","Ba","La","Ce","Pr",
#                                  "Nd","Sm","Eu","Gd","Tb",
#                                  "Dy","Ho","Er","Tm","Yb",
#                                  "Lu","Hf","Ta","W","200_Hg",
#                                  "201_Hg","202_Hg","Tl","206_Pb","207_Pb",
#                                  "Bi","Th","U")
# head(sgg_metadata)
# sgg_metadata$X11_B
sgg_metadata_ord_2<-sgg_metadata[match(order_3, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord_2) <- sgg_metadata_ord_2$Sample_Code
# names(sgg_metadata_ord_2)
# sgg_metadata_ord_2$`11_B`
sgg_metadata_ord_2_final = sgg_metadata_ord_2[, c("Site.name","Na","Ca","X11_B")]

geochem_com_table = cbind(glomTablefinal,sgg_metadata_ord_2_final)

geochem_com_table$NaCaRatio = (geochem_com_table$Na/(geochem_com_table$Na + geochem_com_table$Ca))
geochem_com_table$X11_B_uM = geochem_com_table$X11_B*1000
geochem_com_table_naca_b_epsbet=ggplot(geochem_com_table, aes(x=X11_B_uM, y=NaCaRatio,
                              color=Site.name, size=EpsBetRatio)) +
  geom_point(shape = 1, stroke = 2) +
  scale_color_manual("Sites",values = nmds_ps.b.r_colors_by_name, guide = 'none') +
  scale_size_continuous("Beta-/Epsilonprot. \nratio") +
  ylab("Na/Na+Ca ratio (μM)") +
  xlab(expression({}^11*"B (μM)")) +
  theme(legend.box = "horizontal")
# head(geochem_com_table_naca_b_epsbet$data)
```

```{r echo=FALSE, fig.align="center", fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
geochem_com_table_naca_b_epsbet
```

###**Figure 3:** Genus-level view of the dataset per month and site:

```{r include=FALSE}
ps.b.r.top_genera.glom <- speedyseq::tax_glom(ps.b.r, taxrank = 'Genus', NArm = FALSE)
ps.b.r.top_genera.glom.psdf <- data.table(speedyseq::psmelt(ps.b.r.top_genera.glom))
ps.b.r.top_genera.glom.psdf$Genus <- as.character(ps.b.r.top_genera.glom.psdf$Genus)

ps.b.r.top_genera.glom.psdf[, mean := mean(Abundance, na.rm = FALSE),
                 by = "Genus"]

ps.b.r.top_genera.glom.psdf[(mean <= 0.01), Genus := "Other (<1%)"]

ps.b.r.top_genera.glom.psdf$Site.name = factor(ps.b.r.top_genera.glom.psdf$Site.name,
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taff's Well"))
ps.b.r.top_genera.glom.psdf$Genus = factor(ps.b.r.top_genera.glom.psdf$Genus,
                                                       levels = c("Gallionella","Sideroxydans","Ferriphaselus",
                                                                  "Sulfuricurvum","Sulfurovum","Thiothrix","Rhodoferax","Other (<1%)"))

tol18rainbow=c("#771155", "#AA4488", "#CC99BB", "#114477", "#4477AA", "#77AADD", 
               "#117777", "azure3")

new.labs <- c("Celynen\nNorth","Crumlin\nNavigation","Six Bells",
              "Blaenavon","Cefn\nHengoed","Dinas","Glyncastle",
              "Morlais","Mountain\nGate","Taff\nBargoed","Ynysarwed","Lindsay",
              "Taff's Well")
names(new.labs) <- c("Celynen North","Crumlin Navigation","Six Bells",
              "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
              "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
              "Taff's Well")

ps.b.r.top_genera.glom.psdf.plot<-ggplot(ps.b.r.top_genera.glom.psdf,
                                    aes(x = Month, y = Abundance/3, fill = Genus)) +
  geom_bar(stat = "identity", position = "fill",
           colour = "black", size = 0.05) +
  scale_fill_manual(values = tol18rainbow,
                     na.value = "gray40") +
  scale_y_continuous(labels = scales::percent,
                     expand = c(0,0),
                     limits = c(0,1.01)) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size = 14,
                                   angle = 35, hjust = 1),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 14),
        legend.title = element_text(size = 16),
        legend.text = element_text(size = 14),
        legend.position = "bottom",
        strip.background = element_blank(),
        strip.text = element_text(size = 16,
                                  face = "bold")) +
  guides(fill = guide_legend(nrow = 1,
                             keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance (%)\n") +
  facet_wrap(~Site.name, nrow = 1,
             labeller = labeller(Site.name=new.labs))
```
```{r echo=FALSE, fig.height=8, fig.width=20}
ps.b.r.top_genera.glom.psdf.plot
```
