---
title: "OTUs vs SVs in the SGG dataset"
author: "Andr√© Soares"
date: "8 January 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r initial loadings, include=FALSE}
library(dada2); packageVersion("dada2")
library(ggplot2); packageVersion("ggplot2")
library(phyloseq); packageVersion("phyloseq")
library(data.table); packageVersion("data.table")
library(DESeq2); packageVersion("DESeq2")
library(dplyr)
library(plyr)
library(magrittr)
library(RColorBrewer)
library(phangorn)
library(DECIPHER)
library("structSSI")
library(ips)
library(msa)
library(picante)
library(igraph)
library(cowplot)
library(plotly)
```
```{r load OTU data, echo=FALSE}
SGG_otu_tab = "/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_OTU/SGG_OTU_m.txt"
SGG_otu_tab_imp<-read.csv(SGG_otu_tab, sep="\t", header = TRUE, row.names = 1, check.names = FALSE)
OTU = otu_table(SGG_otu_tab_imp, taxa_are_rows = TRUE)
OTU_t = t(OTU)
SGG_otu_tax = "/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_OTU/SGG_OTU_tax_c.txt"
SGG_otu_tax_imp<-read.csv(SGG_otu_tax, sep="\t", header = TRUE, row.names = 1)
SGG_OTU_tax<-as.matrix(SGG_otu_tax_imp)
sgg_metadata<-read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/SGG_metadata.csv", header=TRUE)
order<-rownames(OTU_t)
sgg_metadata_ord<-sgg_metadata[match(order, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord) <- sgg_metadata_ord$Sample_Code
ps_otu<-phyloseq(otu_table(OTU), 
                 tax_table(SGG_OTU_tax), 
                 sample_data(sgg_metadata_ord))
```
```{r load SV data, echo=FALSE}
SGG_SVt = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/seqtab_final.rds")
SGG_Tax = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/tax_final.rds")
ps_sv <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord), 
               tax_table(SGG_Tax))
```


##1 - Basic information about each dataset


```{r}
ps_sv
#total numbers of SVs
ntaxa(ps_sv)
#total numbers of reads
sum(taxa_sums(ps_sv))
```
```{r}
ps_otu
#total numbers of OTUs
ntaxa(ps_otu)
#total numbers of reads
sum(taxa_sums(ps_otu))
```


Happy days, both datasets were properly loaded and match the number of taxa advertised.


How many phyla and in what proportions?


```{r phyla numbers}
sv.phyl<-as.data.frame(table(tax_table(ps_sv)[, "Phylum"], exclude = NULL))
sv.phyl.ord <- sv.phyl[order(-sv.phyl$Freq),]
head(sv.phyl.ord, n=10)

otu.phyl<-as.data.frame(table(tax_table(ps_otu)[, "Phylum"], exclude = NULL))
otu.phyl.ord <- otu.phyl[order(-otu.phyl$Freq),]
head(otu.phyl.ord, n=10)
```


Seems OTUs have less taxonomic resolution, ~35% of OTUs weren't classified to phylum level as compared to ~8.8% with SVs.


Before proceeding, some quick alterations to the dataset, to make downstream analyses easier:


```{r custom datasets}
#now without Controls and Taffs Well PUMPED
ps_sv.a = subset_samples(ps_sv, Site.name != "Taffs Well PUMPED")
ps_sv.b = subset_samples(ps_sv.a, Sample_type != "Control")
#making sure no 'empty' taxa are left
ps_sv.b <- prune_taxa(taxa_sums(ps_sv.b) > 0, ps_sv.b)
#order months
sample_data(ps_sv.b)$Month = factor(sample_data(ps_sv.b)$Month, 
                                         levels = c("April","August","December"))
#to relative abundances
ps_sv.b.r <-  transform_sample_counts(ps_sv.b, function(x) {x/sum(x)})

#now for the OTUs
#now without Controls and Taffs Well PUMPED
ps_otu.a = subset_samples(ps_otu, Site.name != "Taffs Well PUMPED")
ps_otu.b = subset_samples(ps_otu.a, Sample_type != "Control")
#making sure no 'empty' taxa are left
ps_otu.b <- prune_taxa(taxa_sums(ps_otu.b) > 0, ps_otu.b)
#order months
sample_data(ps_otu.b)$Month = factor(sample_data(ps_otu.b)$Month, 
                                         levels = c("April","August","December"))
#to relative abundances
ps_otu.b.r <-  transform_sample_counts(ps_otu.b, function(x) {x/sum(x)})
```


##2 - General phylum-level taxonomy


```{r SVs and OTUs general phylum-level taxonomy}
# agglomerate taxa
#DON'T FORGET NArm = FALSE
ps_sv.b.r.glom <- tax_glom(ps_sv.b.r, taxrank = 'Phylum',NArm = FALSE)
# create dataframe from phyloseq object
ps_sv.b.r.glom.ps_svdf <- data.table(psmelt(ps_sv.b.r.glom))
# convert Phylum to a character vector from a factor because R
ps_sv.b.r.glom.ps_svdf$Phylum <- as.character(ps_sv.b.r.glom.ps_svdf$Phylum)
# group dataframe by Phylum, calculate median rel. abundance
ps_sv.b.r.glom.ps_svdf[, median := median(Abundance, na.rm = TRUE), 
    by = "Phylum"]
# Change name to remainder of Phylum less than 1%
ps_sv.b.r.glom.ps_svdf[(median <= 0.01), Phylum := "Other"]

ps_sv.b.r.glom.ps_svdf.noProteo<-ps_sv.b.r.glom.ps_svdf[!grepl("Proteobacteria", ps_sv.b.r.glom.ps_svdf$Phylum),]
#New table, with Proteobacterial classes only
ps_sv.b.r.ProtCl = subset_taxa(ps_sv.b.r, Phylum == "Proteobacteria")
ps_sv.b.r.ProtCl.glom <- tax_glom(ps_sv.b.r.ProtCl, taxrank = 'Class')
# create dataframe from phyloseq object
ps_sv.b.r.ProtCl.glom.ps_svdf <- data.table(psmelt(ps_sv.b.r.ProtCl.glom))
# convert Class to a character vector from a factor because R
ps_sv.b.r.ProtCl.glom.ps_svdf$Class <- as.character(ps_sv.b.r.ProtCl.glom.ps_svdf$Class)
# group dataframe by Phylum, calculate median rel. abundance
ps_sv.b.r.ProtCl.glom.ps_svdf[, median := median(Abundance, na.rm = TRUE), 
                 by = "Class"]
# Change name to remainder of Phylum less than 1%
ps_sv.b.r.ProtCl.glom.ps_svdf[(median <= 0.01), Class := "Other Proteobacteria"]
#join the two data frames
ps_sv.b.r.ProtCl.glom.ps_svdf.noP <- subset(ps_sv.b.r.ProtCl.glom.ps_svdf, select = -Phylum)
#same name= allows merging
names(ps_sv.b.r.glom.ps_svdf.noProteo)[names(ps_sv.b.r.glom.ps_svdf.noProteo) == 'Phylum'] <- 'Taxa'
names(ps_sv.b.r.ProtCl.glom.ps_svdf.noP)[names(ps_sv.b.r.ProtCl.glom.ps_svdf.noP) == 'Class'] <- 'Taxa'
#join the two
ps_sv.b.r.ProteoCl.AllPhy <- rbind(ps_sv.b.r.glom.ps_svdf.noProteo, ps_sv.b.r.ProtCl.glom.ps_svdf.noP)

ps_sv.b.r.ProteoCl.AllPhy.plot<-ggplot(ps_sv.b.r.ProteoCl.AllPhy[Abundance > 0], 
                              aes(x = Site.name, y = Abundance/3, fill = Taxa)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ggtitle("SVs") +
  ylab("Relative Abundance\n")
#totals vary because the bars = medians

#Same thing for OTUs
ps_otu.b.r.glom <- tax_glom(ps_otu.b.r, taxrank = 'Phylum',NArm = FALSE)
ps_otu.b.r.glom.ps_otudf <- data.table(psmelt(ps_otu.b.r.glom))
ps_otu.b.r.glom.ps_otudf$Phylum <- as.character(ps_otu.b.r.glom.ps_otudf$Phylum)
ps_otu.b.r.glom.ps_otudf[, median := median(Abundance, na.rm = TRUE), 
    by = "Phylum"]
ps_otu.b.r.glom.ps_otudf[(median <= 0.01), Phylum := "Other"]
ps_otu.b.r.glom.ps_otudf.noProteo<-ps_otu.b.r.glom.ps_otudf[!grepl("Proteobacteria", ps_otu.b.r.glom.ps_otudf$Phylum),]
ps_otu.b.r.ProtCl = subset_taxa(ps_otu.b.r, Phylum == "Proteobacteria")
ps_otu.b.r.ProtCl.glom <- tax_glom(ps_otu.b.r.ProtCl, taxrank = 'Class')
ps_otu.b.r.ProtCl.glom.ps_otudf <- data.table(psmelt(ps_otu.b.r.ProtCl.glom))
ps_otu.b.r.ProtCl.glom.ps_otudf$Class <- as.character(ps_otu.b.r.ProtCl.glom.ps_otudf$Class)
ps_otu.b.r.ProtCl.glom.ps_otudf[, median := median(Abundance, na.rm = TRUE), 
                 by = "Class"]
ps_otu.b.r.ProtCl.glom.ps_otudf[(median <= 0.01), Class := "Other Proteobacteria"]
ps_otu.b.r.ProtCl.glom.ps_otudf.noP <- subset(ps_otu.b.r.ProtCl.glom.ps_otudf, select = -Phylum)
names(ps_otu.b.r.glom.ps_otudf.noProteo)[names(ps_otu.b.r.glom.ps_otudf.noProteo) == 'Phylum'] <- 'Taxa'
names(ps_otu.b.r.ProtCl.glom.ps_otudf.noP)[names(ps_otu.b.r.ProtCl.glom.ps_otudf.noP) == 'Class'] <- 'Taxa'
ps_otu.b.r.ProteoCl.AllPhy <- rbind(ps_otu.b.r.glom.ps_otudf.noProteo, ps_otu.b.r.ProtCl.glom.ps_otudf.noP)
ps_otu.b.r.ProteoCl.AllPhy.plot<-ggplot(ps_otu.b.r.ProteoCl.AllPhy[Abundance > 0], 
                              aes(x = Site.name, y = Abundance/3, fill = Taxa)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ggtitle("OTUs") +
  ylab("Relative Abundance\n")

ps_otu_sv_phyla_profiles<-plot_grid(ps_sv.b.r.ProteoCl.AllPhy.plot, ps_otu.b.r.ProteoCl.AllPhy.plot, 
                             ncol = 1, align = 'v')
ps_otu_sv_phyla_profiles
ggsave("sgg_otu-sv-Phyla-ProtClasses-R-Month-Site.plot.png",
       width = 18,
       height = 12)
```
```{r plot SVs and OTUs general phylum-level taxonomy, fig.width=18, fig.height=12}
ps_otu_sv_phyla_profiles
```


Basically the same crap!


##3 - Genus-level trends


```{r SV genus-level relabunds for important taxa}
ps_sv.b.r.HelicobGall = subset_taxa(ps_sv.b.r, Family=="Helicobacteraceae" | Family=="Gallionellaceae")
ps_sv.b.r.HelicobGall.glom <- tax_glom(ps_sv.b.r.HelicobGall, taxrank = 'Genus')
ps_sv.b.r.HelicobGall.glom.ps_svdf <- data.table(psmelt(ps_sv.b.r.HelicobGall.glom))
ps_sv.b.r.HelicobGall.glom.ps_svdf$Genus <- as.character(ps_sv.b.r.HelicobGall.glom.ps_svdf$Genus)
ps_sv.b.r.HelicobGall.glom.ps_svdf.plot<-ggplot(ps_sv.b.r.HelicobGall.glom.ps_svdf,
                                         aes(x=Genus,y=Abundance,fill=Genus)) + 
  geom_point(aes(color=Genus, fill=Genus,
                 size=Abundance)) + 
  facet_grid(Month~Site.name)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```
```{r plot SV genus-level relabunds for important taxa, fig.width=18, fig.height=8}
ps_sv.b.r.HelicobGall.glom.ps_svdf.plot
```


In the SV dataset, genera Gallionella, Sideroxydans, Ferriphaselus (Gallionellaceae) and genera Sulfuricurvum Sulfurimonas and Sulfurovum (Campylobacterales) explain most of the Betaproteobacteria and Epsilonproteobacteria dominance across the dataset.


Now for OTUs, check how much diversity is within family Gallionellaceae and if Gallionella and Sideroxydans can be detected.


```{r gallionellaceae in OTU}
ps_otu.b.gallionelac = subset_taxa(ps_otu.b.r, Family=="Gallionellaceae")
ps_otu.b.gallionelac.plot<-plot_bar(ps_otu.b.gallionelac, 
                                fill="Genus", facet_grid=~Month, x="Site.name") + 
  geom_bar(aes(color=Genus, fill=Genus), 
           stat="identity", position="stack")
```
```{r plot allionellaceae in OTU, fig.width=18, fig.height=8}
ps_otu.b.gallionelac.plot
```


Less genera detected, and most importantly, Gallionella comes out as the major player in defining Betaproteobacterial dominances in the dataset.

```{r campylobacterales in OTU}
ps_otu.b.campylobac = subset_taxa(ps_otu.b.r, Family=="Helicobacteraceae")
ps_otu.b.campylobac.plot<-plot_bar(ps_otu.b.campylobac, 
                                fill="Genus", facet_grid=~Month, x="Site.name") + 
  geom_bar(aes(color=Genus, fill=Genus), 
           stat="identity", position="stack")
```
```{r plot Helicobacteraceae in OTU, fig.width=18, fig.height=8}
ps_otu.b.campylobac.plot
```

```{r OTUs genus-level relabunds for important taxa}
ps_otu.b.r.HelicobGall = subset_taxa(ps_otu.b.r, Family=="Helicobacteraceae" | Family=="Gallionellaceae")
ps_otu.b.r.HelicobGall.glom <- tax_glom(ps_otu.b.r.HelicobGall, taxrank = 'Genus', NArm = FALSE)
ps_otu.b.r.HelicobGall.glom.ps_otudf_otu <- data.table(psmelt(ps_otu.b.r.HelicobGall.glom))
ps_otu.b.r.HelicobGall.glom.ps_otudf_otu$Genus <- as.character(ps_otu.b.r.HelicobGall.glom.ps_otudf_otu$Genus)
ps_otu.b.r.HelicobGall.glom.ps_otudf_otu.plot<-ggplot(ps_otu.b.r.HelicobGall.glom.ps_otudf_otu[Abundance > 0],
                                          aes(x=Genus,y=Abundance,fill=Genus)) + 
  geom_point(aes(color=Genus, fill=Genus,
                 size=Abundance)) + 
  facet_grid(Month~Site.name)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```
```{r plot OTU genus-level relabunds for important taxa, fig.width=18, fig.height=8}
ps_otu.b.r.HelicobGall.glom.ps_otudf_otu.plot
```


In the OTU dataset, however, less taxonomic resolution means the abovementioned genera can't be discerned as they are in the SV dataset. Within family Gallionellaceae, only genus Gallionella is present.


##4 - Ordination time!


```{r SV OTU ordinations}
# Calculate ordination
ps_sv.b.r.pcoa  <- ordinate(ps_sv.b.r, "PCoA", distance="jsd", 
                         k=3, trymax=1e3, weighted=TRUE)
evals_sv<-ps_sv.b.r.pcoa$values$Eigenvalues
#Axis 1 and 2
pcoa.a12_sv<-sum(evals_sv[1:2])/sum(evals_sv)
pcoa.a12.r_sv<-round(pcoa.a12_sv, digits=4)*100
#Axis 1 and 3
pcoa.a13_sv<-sum(evals_sv[c(1,3)])/sum(evals_sv)
pcoa.a13.r_sv<-round(pcoa.a13_sv, digits=4)*100

ps_sv.b.r.pcoa.plot.a1 <- plot_ordination(ps_sv.b.r, ps_sv.b.r.pcoa, axes = c(1,2),
                                       color="Site.name", shape="Month") +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(alpha=0.5, size=5)+
  scale_alpha(guide = 'none') +
  theme(legend.position = "none") +
  annotate("text", y= 0.3, x =0.25,label=paste("Axes 1 and 2:\n",pcoa.a12.r_sv,"% variation")
           ,hjust=0.5, size=5)

ps_sv.b.r.pcoa.plot.a2 <- plot_ordination(ps_sv.b.r, ps_sv.b.r.pcoa, axes = c(1,3),
                                       color="Site.name", shape="Month")+
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(alpha=0.5, size=5) +
  scale_alpha(guide = 'none')+
  annotate("text", y= 0.2, x =0.25,label=paste("Axes 1 and 3:\n",pcoa.a13.r_sv,"% variation")
           ,hjust=0.5, size=5)

ps_sv.b.r.pcoa.plot<-plot_grid(ps_sv.b.r.pcoa.plot.a1, ps_sv.b.r.pcoa.plot.a2, 
                            labels=c("A","B"))

# OTUs now
ps_otu.b.r.pcoa  <- ordinate(ps_otu.b.r, "PCoA", distance="jsd", 
                         k=3, trymax=1e3, weighted=TRUE)
evals_otu<-ps_otu.b.r.pcoa$values$Eigenvalues
#Axis 1 and 2
pcoa.a12_otu<-sum(evals_otu[1:2])/sum(evals_otu)
pcoa.a12.r_otu<-round(pcoa.a12_otu, digits=4)*100
#Axis 1 and 3
pcoa.a13_otu<-sum(evals_otu[c(1,3)])/sum(evals_otu)
pcoa.a13.r_otu<-round(pcoa.a13_otu, digits=4)*100
ps_otu.b.r.pcoa.plot.a1 <- plot_ordination(ps_otu.b.r, ps_otu.b.r.pcoa, axes = c(1,2),
                                       color="Site.name", shape="Month") +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(alpha=0.5, size=5)+
  scale_alpha(guide = 'none') +
  theme(legend.position = "none") +
  annotate("text", y= 0.3, x =-0.25,label=paste("Axes 1 and 2:\n",pcoa.a12.r_otu,"% variation")
           ,hjust=0.5, size=5)
ps_otu.b.r.pcoa.plot.a2 <- plot_ordination(ps_otu.b.r, ps_otu.b.r.pcoa, axes = c(1,3),
                                       color="Site.name", shape="Month")+
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(alpha=0.5, size=5) +
  scale_alpha(guide = 'none')+
  annotate("text", y= 0.15, x =-0.25,label=paste("Axes 1 and 3:\n",pcoa.a13.r_otu,"% variation")
           ,hjust=0.5, size=5)

ps_otu.b.r.pcoa.plot<-plot_grid(ps_otu.b.r.pcoa.plot.a1, ps_otu.b.r.pcoa.plot.a2, 
                            labels=c("A","B"))
```
```{r plot SV OTU ordinations, fig.width=18, fig.height=9}
ps_sv.b.r.pcoa.plot
ps_otu.b.r.pcoa.plot
```


With OTUs, more variation is explained by the first two axes of the PCoA - 48.43% as opposed to 35.88% with SVs.
