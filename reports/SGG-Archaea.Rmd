---
title: "SGG - How do Archaea do?"
author: "Andr√© Soares"
date: "8 January 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r initial loadings, include=FALSE}
library(dada2); packageVersion("dada2")
library(ggplot2); packageVersion("ggplot2")
library(phyloseq); packageVersion("phyloseq")
library(data.table); packageVersion("data.table")
library(DESeq2); packageVersion("DESeq2")
library(dplyr)
library(plyr)
library(magrittr)
library(RColorBrewer)
library(phangorn)
library(DECIPHER)
library("structSSI")
library(ips)
library(msa)
library(picante)
library(igraph)
library(cowplot)
library(plotly)
library(lemon)
library(ggcorrplot)
library(GGally)
```

```{r load SV data, echo=FALSE}
SGG_SVt = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/seqtab_final.rds")
SGG_Tax = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/tax_final.rds")
sgg_metadata<-read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/SGG_metadata.csv", header=TRUE)
order<-rownames(SGG_SVt)
sgg_metadata_ord<-sgg_metadata[match(order, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord) <- sgg_metadata_ord$Sample_Code
ps <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord), 
               tax_table(SGG_Tax))
ps.a = subset_samples(ps, Site.name != "Taffs Well PUMPED")
ps.b = subset_samples(ps.a, Sample_type != "Control")
ps.b <- prune_taxa(taxa_sums(ps.b) > 0, ps.b)
#order months
sample_data(ps.b)$Month = factor(sample_data(ps.b)$Month, 
                                 levels = c("April","August","December"))
#to relative abundances
ps.b = subset_taxa(ps.b, Kingdom %in% c("Archaea", "Bacteria"))
ps.b.r <-  transform_sample_counts(ps.b, function(x) {x/sum(x)} ) 
```

##1 - Main Archaea phyla across the dataset

Have in account these primers aren't necessarily the best for this lol

```{r omniparcu uncs}
ps.b.r.arc = subset_taxa(ps.b.r, Kingdom %in% c("Archaea"))

ps.b.r.arc.c<-as.data.frame(table(tax_table(ps.b.r.arc)[, "Phylum"], exclude = NULL))
ps.b.r.arc.c.ord <- ps.b.r.arc.c[order(-ps.b.r.arc.c$Freq),] 
ps.b.r.arc.c.ord
```

Mostly Woesearchaeota and unidentified phyla.

Do these play important roles in the whole dataset though?

```{r general cpr taxonomy}
ps.b.r.arc.glom <- tax_glom(ps.b.r.arc, taxrank = 'Phylum', NArm = FALSE)
ps.b.r.arc.glom.psdf <- data.table(psmelt(ps.b.r.arc.glom))
ps.b.r.arc.glom.psdf$Phylum <- as.character(ps.b.r.arc.glom.psdf$Phylum)
ps.b.r.arc.glom.psdf.plot<-ggplot(ps.b.r.arc.glom.psdf[Abundance > 0], 
                                    aes(x = Site.name, y = Abundance/3, fill = Phylum)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance\n")
```
```{r , fig.height=8, fig.width=10}
ps.b.r.arc.glom.psdf.plot
```

Nah.

So it's basically Woesarchaeota and some Euryarchaeota that don't relate to 'Fe/S' groups or metadata. Taff's Well for a change shows a bit more of a different profile with Bathyarchaeota occupying just a tad more of it.