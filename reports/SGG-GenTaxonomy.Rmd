---
title: "SGG - Who are the main players?"
author: "Andr√© Soares"
date: "8 January 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r initial loadings, include=FALSE}
library(dada2); packageVersion("dada2")
library(ggplot2); packageVersion("ggplot2")
library(phyloseq); packageVersion("phyloseq")
library(data.table); packageVersion("data.table")
library(DESeq2); packageVersion("DESeq2")
library(dplyr)
library(plyr)
library(magrittr)
library(RColorBrewer)
library(phangorn)
library(DECIPHER)
library("structSSI")
library(ips)
library(msa)
library(picante)
library(igraph)
library(cowplot)
library(plotly)
library(lemon)
library(randomcoloR)
library(scales)
```

```{r load SV data, echo=FALSE}
SGG_SVt = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/seqtab_final.rds")
SGG_Tax = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/tax_final.rds")
sgg_metadata<-read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/SGG_metadata.csv", header=TRUE)
order<-rownames(SGG_SVt)
sgg_metadata_ord<-sgg_metadata[match(order, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord) <- sgg_metadata_ord$Sample_Code
ps <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord), 
               tax_table(SGG_Tax))
ps.a = subset_samples(ps, Site.name != "Taffs Well PUMPED")
ps.b = subset_samples(ps.a, Sample_type != "Control")
ps.b <- prune_taxa(taxa_sums(ps.b) > 0, ps.b)
#order months
sample_data(ps.b)$Month = factor(sample_data(ps.b)$Month, 
                                 levels = c("April","August","December"))
#to relative abundances
ps.b = subset_taxa(ps.b, Kingdom %in% c("Archaea", "Bacteria"))
ps.b.r <-  transform_sample_counts(ps.b, function(x) {x/sum(x)} ) 
```

##1 - General view of taxonomic profiles across the dataset

```{r general proteobacterial taxonomy}
# agglomerate taxa
ps.b.r.glom <- tax_glom(ps.b.r, taxrank = 'Phylum', NArm = FALSE)
# create dataframe from phyloseq object
ps.b.r.glom.psdf <- data.table(psmelt(ps.b.r.glom))
# convert Phylum to a character vector from a factor because R
ps.b.r.glom.psdf$Phylum <- as.character(ps.b.r.glom.psdf$Phylum)
# group dataframe by Phylum, calculate median rel. abundance
ps.b.r.glom.psdf[, median := median(Abundance, na.rm = TRUE), 
                 by = "Phylum"]
# Change name to remainder of Phylum less than 1%
ps.b.r.glom.psdf[(median <= 0.01), Phylum := "Other"]
#Removing Proteobacteria from previous table
ps.b.r.glom.psdf.noProteo<-ps.b.r.glom.psdf[!grepl("Proteobacteria", ps.b.r.glom.psdf$Phylum),]
#New table, with Proteobacterial classes only
ps.b.r.ProtCl = subset_taxa(ps.b.r, Phylum == "Proteobacteria")
ps.b.r.ProtCl.glom <- tax_glom(ps.b.r.ProtCl, taxrank = 'Class', NArm = FALSE)
# create dataframe from phyloseq object
ps.b.r.ProtCl.glom.psdf <- data.table(psmelt(ps.b.r.ProtCl.glom))
# convert Class to a character vector from a factor because R
ps.b.r.ProtCl.glom.psdf$Class <- as.character(ps.b.r.ProtCl.glom.psdf$Class)
# group dataframe by Phylum, calculate median rel. abundance
ps.b.r.ProtCl.glom.psdf[, median := median(Abundance, na.rm = TRUE), 
                        by = "Class"]
# Change name to remainder of Phylum less than 1%
ps.b.r.ProtCl.glom.psdf[(median <= 0.01), Class := "Other Proteobacteria"]
ps.b.r.ProtCl.glom.psdf.noP <- subset(ps.b.r.ProtCl.glom.psdf, select = -Phylum)
#same name= allows merging
names(ps.b.r.glom.psdf.noProteo)[names(ps.b.r.glom.psdf.noProteo) == 'Phylum'] <- 'Taxa'
names(ps.b.r.ProtCl.glom.psdf.noP)[names(ps.b.r.ProtCl.glom.psdf.noP) == 'Class'] <- 'Taxa'
#join the two
ps.b.r.ProteoCl.AllPhy <- rbind(ps.b.r.glom.psdf.noProteo, ps.b.r.ProtCl.glom.psdf.noP)

ps.b.r.ProteoCl.AllPhy$Site.name = factor(ps.b.r.ProteoCl.AllPhy$Site.name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))

ps.b.r.ProteoCl.AllPhy.plot<-ggplot(ps.b.r.ProteoCl.AllPhy[Abundance > 0], 
                                    aes(x = Site.name, y = Abundance/3, fill = Taxa)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance\n")
#totals vary because the bars = medians
```
```{r , fig.height=14, fig.width=20}
ps.b.r.ProteoCl.AllPhy.plot
```

Clearly, the dataset is mostly populated by Beta- and Epsilonproteobacteria, which seem to correspond to iron- and sulphur-rich sites, respectively. However, certain sites like Lindsay, Cefn Hengoed and Mountain Gate have large percentages of either 'Other' less abundant phyla or have ~30-50% of their profiles dominated by Parcubacteria and Omnitrophica.

No obvious temporal trends arise from this, aside from indications that Betaproteobacterial presence decreases across the year in Blaenavon, cefn Hengoed and Morlais. The opposite happens in Taff Bargoed and Taffs Well. The Epsilonproteobacterial dominance in Crumlin Navigation and Celynen North seems to be opposed only be Gammaproteobacteria.

Is this dominance explain by particular genera? Yep, seems like so. Also, some temporal trends seem to pop up. We'll take a look at that later.

```{r genera plot}
ps.b.deep_128 = subset_taxa(ps.b.r, 
                            Family=="Gallionellaceae" | Family=="Helicobacteraceae" | Family=="Pseudomonadaceae" | Family=="Thiotrichaceae" | Family=="Hydrogenophilaceae" | Phylum=="Omnitrophica" | Phylum=="Parcubacteria")
ps.b.deep_128.glom <- tax_glom(ps.b.deep_128, taxrank = 'Genus', NArm = FALSE)
ps.b.deep_128.glom.df <- data.table(psmelt(ps.b.deep_128.glom))
levels(ps.b.deep_128.glom.df$Genus)<-c(levels(ps.b.deep_128.glom.df$Genus),
                                     c("Unc. Gallionellaceae","Unc. Helicobacteraceae", 
                                       "Omnitrophica","Parcubacteria","Unc. Omnitrophica","Unc. Parcubacteria",
                                       "Unc. Pseudomonadaceae","Unc. Thiotrichaceae","Unc. Hydrogenophilaceae"))
ps.b.deep_128.glom.df$Genus[is.na(ps.b.deep_128.glom.df$Genus) & ps.b.deep_128.glom.df$Family=="Gallionellaceae"] <- "Unc. Gallionellaceae"
ps.b.deep_128.glom.df$Genus[is.na(ps.b.deep_128.glom.df$Genus) & ps.b.deep_128.glom.df$Family=="Helicobacteraceae"] <- "Unc. Helicobacteraceae"
ps.b.deep_128.glom.df$Genus[is.na(ps.b.deep_128.glom.df$Genus) & ps.b.deep_128.glom.df$Family=="Pseudomonadaceae"] <- "Unc. Pseudomonadaceae"
ps.b.deep_128.glom.df$Genus[is.na(ps.b.deep_128.glom.df$Genus) & ps.b.deep_128.glom.df$Family=="Thiotrichaceae"] <- "Unc. Thiotrichaceae"
ps.b.deep_128.glom.df$Genus[is.na(ps.b.deep_128.glom.df$Genus) & ps.b.deep_128.glom.df$Family=="Hydrogenophilaceae"] <- "Unc. Hydrogenophilaceae"
ps.b.deep_128.glom.df$Genus[ps.b.deep_128.glom.df$Phylum=="Omnitrophica"] <- "Omnitrophica"
ps.b.deep_128.glom.df$Genus[ps.b.deep_128.glom.df$Phylum=="Parcubacteria"] <- "Parcubacteria"
ps.b.deep_128.glom.df$Site.name = factor(ps.b.deep_128.glom.df$Site.name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
ps.b.r.glom.psdf.unk.glom <- tax_glom(ps.b.r, taxrank = 'Genus', NArm = FALSE)
ps.b.r.glom.psdf.unk <- data.table(psmelt(ps.b.r.glom.psdf.unk.glom))
levels(ps.b.r.glom.psdf.unk$Phylum)<-c(levels(ps.b.r.glom.psdf.unk$Phylum),
                                     c("Unknown Phyla"))
levels(ps.b.r.glom.psdf.unk$Genus)<-c(levels(ps.b.r.glom.psdf.unk$Genus),
                                     c("Unknown Phyla"))
ps.b.r.glom.psdf.unk$Phylum[is.na(ps.b.r.glom.psdf.unk$Phylum)]="Unknown Phyla"
ps.b.r.glom.psdf.unk$Genus[ ps.b.r.glom.psdf.unk$Phylum=="Unknown Phyla"] <- "Unknown Phyla"
ps.b.r.glom.psdf.unkonly<-subset(ps.b.r.glom.psdf.unk, 
                                                  Phylum %in% c("Unknown Phyla"))
ps.b.deep_128.glom.df.unkonly <- rbind(ps.b.deep_128.glom.df, ps.b.r.glom.psdf.unkonly)

gen_cols = colorRampPalette(brewer.pal(8, "Accent"))(15)
gen_cols_c = gsub("#DD2456", "#9c183c", gen_cols)
gen_cols_c = gsub("#A0BAAC", "#749a85", gen_cols_c)
gen_cols_c = gsub("#E4B9A3", "#489fca", gen_cols_c)
gen_cols_c = gsub("#FEEB93", "#f58e03", gen_cols_c)
gen_cols_c = gsub("#FDC988", "#c988fd", gen_cols_c)
gen_cols_c = gsub("#D1DD9E", "#b6c965", gen_cols_c)
gen_cols_c = gsub("#FDC086", "#fc993b", gen_cols_c)
gen_cols_c = gsub("#FFFF99", "springgreen4", gen_cols_c)
gen_cols_c = gsub("#BEAED4", "violet", gen_cols_c)

ps.b.deep_128.glom.df.unkonly.f<-subset(ps.b.deep_128.glom.df.unkonly, 
                                                  Abundance > 0.03)
ps.b.deep_128.glom.df.unkonly.f$Genus = factor(ps.b.deep_128.glom.df.unkonly.f$Genus, 
                                                       levels = c("Gallionella","Sideroxydans","Ferriphaselus","Unc. Gallionellaceae",
                                                                  "Sulfurovum","Sulfurimonas","Sulfuricurvum","Sulfuricella","Sulfuriferula",
                                                                  "Pseudomonas","Thiothrix","Unc. Hydrogenophilaceae",
                                                                  "Parcubacteria","Omnitrophica",
                                                                  "Unknown Phyla"))

ps.b.deep_128.glom.df.plot <- ggplot(ps.b.deep_128.glom.df.unkonly.f, 
                                     aes(x = Genus, y = Abundance, fill = Genus)) + 
  facet_grid(Site.name~Month)+
  geom_hline(yintercept = 0.5,
           color="white",
           linetype="solid") +
  geom_point(aes(color=Genus, fill=Genus,
                 size=Abundance), alpha = 0.8) +
  scale_y_continuous(breaks = c(0.25,0.75),
                     limits = c(0,1),
                     labels = scales::percent) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text.y = element_text(angle = 0),
        strip.placement = "outside",
        strip.background = element_rect(colour = "gray88",
                                        fill = "gray88"),
        panel.background = element_rect(colour = "gray91",
                                       fill = "gray91"),
        panel.grid.major.y = element_line(color = "white"),
        legend.title = element_text(face = "bold")) + 
  guides(fill = guide_legend(nrow = 16),
         shape = NULL,
         size = NULL,
         alpha = NULL) +
  ylab("Relative Abundance\n") +
  scale_fill_manual(values = gen_cols_c,
                    na.value = "gray48") +
  scale_color_manual(values = gen_cols_c,
                    na.value = "gray48")
```
```{r fig.width=14, message=FALSE, warning=FALSE, fig.height=11}
ps.b.deep_128.glom.df.plot
```

A Gallionella-dominated profile comes up, where an interplay with Sideroxydans creates an interesting intra-Gallionellaceae dynamic. Taffs Well again shows an interesting profile as Ferriphaselus, not present in the rest of the dataset, comes up as a main player but only in this site. Sulphur-rich sites show profiles dominated by Sulfurovum and Sulfuricurvum, with other sulphur-related genera come up briefly. Finally, high amounts of genera-unclassified SV's show up.

Quickly, it seems from the phylum-level graph that Lindsay has a much more diverse profile i.e. more than 40% of the profile is made up of 'Other' phyla. Let's take a closer look at that.

```{r lindsay}
ps.b.r.LindsayCHen = subset_samples(ps.b.r, Site.name=="Lindsay")
ps.b.r.glom.phy <- tax_glom(ps.b.r.LindsayCHen, taxrank = 'Phylum', NArm = FALSE )
ps.b.r.glom.phy.psdf <- data.table(psmelt(ps.b.r.glom.phy))
ps.b.r.glom.phy.psdf.f <- ps.b.r.glom.phy.psdf[ , c("Abundance","Phylum")]
ps.b.r.glom.phy.psdf.f.s<-ps.b.r.glom.phy.psdf.f[, .(count=.N, var=mean(Abundance)), by = Phylum]

ps.b.r.glom.phy.psdf.f.s <- transform(ps.b.r.glom.phy.psdf.f.s, Phylum=reorder(Phylum, -var)) 
ps.b.r.glom.phy.psdf.f.s.plot=ggplot(ps.b.r.glom.phy.psdf.f.s, aes(x=Phylum, y=var, color=Phylum)) +
  geom_point() +
  geom_hline(yintercept = 0.01,
             color="gray",
             linetype="dashed") +
  ylab("Relative abundance") +
  theme(axis.text.x = element_text(angle=40, hjust = 1, vjust = 1),
        axis.title.x = element_blank(),
        legend.position = "none")
```
```{r ,fig.width=14}
ps.b.r.glom.phy.psdf.f.s.plot
```

This site is clearly populated by a microbial community where a number of phyla co-exist in relatively low (between 25 and 5%) proportions.

What does this reflect? Is this a matter of just one or two bacterial species in Lindsay or is this highly diverse even within each phylum?

```{r}
ps.b.r.glom.gen <- tax_glom(ps.b.r.LindsayCHen, taxrank = 'Genus', NArm = FALSE )
ps.b.r.glom.gen.psdf <- data.table(psmelt(ps.b.r.glom.gen))
# ps.b.r.glom.gen.psdf[, median := median(Abundance, na.rm = TRUE),
#                         by = "Genus"]
# ps.b.r.glom.gen.psdf[(median <= 0.0001), Genus := "Other"]
levels(ps.b.r.glom.gen.psdf$Genus)<-c(levels(ps.b.r.glom.gen.psdf$Genus),
                                     c("Unc. Omnitrophica","Unc. Omnitrophica",
                                       "Unc. Gallionellaceae","Unc. Helicobacteraceae",
                                       "Unc. Pseudomonadaceae","Unc. Thiotrichaceae","Unc. Hydrogenophilaceae"))
ps.b.r.glom.gen.psdf$Genus[is.na(ps.b.r.glom.gen.psdf$Class) & ps.b.r.glom.gen.psdf$Phylum=="Omnitrophica"] <- "Unc. Omnitrophica"
ps.b.r.glom.gen.psdf$Genus[is.na(ps.b.r.glom.gen.psdf$Class) & ps.b.r.glom.gen.psdf$Phylum=="Parcubacteria"] <- "Unc. Omnitrophica"
ps.b.r.glom.gen.psdf$Genus[is.na(ps.b.r.glom.gen.psdf$Genus) & ps.b.r.glom.gen.psdf$Family=="Gallionellaceae"] <- "Unc. Gallionellaceae"
ps.b.r.glom.gen.psdf$Genus[is.na(ps.b.r.glom.gen.psdf$Genus) & ps.b.r.glom.gen.psdf$Family=="Helicobacteraceae"] <- "Unc. Helicobacteraceae"
ps.b.r.glom.gen.psdf$Genus[is.na(ps.b.r.glom.gen.psdf$Genus) & ps.b.r.glom.gen.psdf$Family=="Pseudomonadaceae"] <- "Unc. Pseudomonadaceae"
ps.b.r.glom.gen.psdf$Genus[is.na(ps.b.r.glom.gen.psdf$Genus) & ps.b.r.glom.gen.psdf$Family=="Thiotrichaceae"] <- "Unc. Thiotrichaceae"
ps.b.r.glom.gen.psdf$Genus[is.na(ps.b.r.glom.gen.psdf$Genus) & ps.b.r.glom.gen.psdf$Family=="Hydrogenophilaceae"] <- "Unc. Hydrogenophilaceae"

ps.b.r.glom.gen.psdf.plot=ggplot(ps.b.r.glom.gen.psdf[Abundance > 0.005], 
                                 aes(x=Month, y=Abundance/3, 
                                     color=Genus, fill=Genus)) +
  geom_bar(stat = "identity",
           width = 0.6) +
  ylab("Relative abundance") +
  theme(axis.text.x = element_text(angle=40, hjust = 1, vjust = 1),
        axis.title.x = element_blank()) +
  guides(fill = guide_legend(nrow = 20),
         color = guide_legend(nrow = 20)) +
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(19), 
                    na.value = "gray48") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(19), 
                    na.value = "gray48")
ps.b.r.glom.gen.psdf.plot
```

##2 - Are there temporal effects to the taxonomic profiles of the dataset?

```{r temporal taxonomy, message=FALSE, warning=FALSE}
#phylum-level, interesting
ps.b.r = prune_taxa(taxa_sums(ps.b.r) > 0, ps.b.r)

ps.b.r.ProteoCl.AllPhy.temp<-ps.b.r.ProteoCl.AllPhy[!grepl("Other", ps.b.r.ProteoCl.AllPhy$Taxa),]
ps.b.r.ProteoCl.AllPhy.temp<-ps.b.r.ProteoCl.AllPhy.temp[!grepl("Other Proteobacteria", ps.b.r.ProteoCl.AllPhy.temp$Taxa),]
ps.b.r.ProteoCl.AllPhy.temp<-na.omit(ps.b.r.ProteoCl.AllPhy.temp, cols=c("Taxa"))
ps.b.r.ProteoCl.AllPhy.temp$Taxa = factor(ps.b.r.ProteoCl.AllPhy.temp$Taxa, 
                                                       levels = c("Betaproteobacteria","Epsilonproteobacteria","Gammaproteobacteria",
                                                                  "Parcubacteria","Omnitrophica","Actinobacteria","Deltaproteobacteria"))
ps.b.r.ProteoCl.AllPhy.temp$Month = factor(ps.b.r.ProteoCl.AllPhy.temp$Month,
                                           levels=c("December", "August", "April"))
taxa_number_pl<-length(unique(ps.b.r.ProteoCl.AllPhy.temp$Site.name)) +1

ps.b.r.ProteoCl.AllPhy.temp.plot <- ggplot(subset(ps.b.r.ProteoCl.AllPhy.temp, 
                                                  Taxa %in% c("Betaproteobacteria","Epsilonproteobacteria","Gammaproteobacteria",
                                                                  "Parcubacteria","Omnitrophica","Actinobacteria","Deltaproteobacteria")), 
       aes(x=Month, y=Abundance, color=Site.name)) +
  geom_point(aes(fill=Site.name, 
                 color=Site.name)) +
  geom_smooth(aes(group=Site.name),
              method="loess", se = FALSE) +
  facet_wrap(~Taxa, 
             ncol=4, nrow=2)+
  theme(axis.title.y = element_blank()) +
  coord_flip() +
  scale_x_discrete(expand=c(0.05, 0.05)) +
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13))

#genus-level, very interesting
ps.b.deep_128.glom.df.g<-na.omit(ps.b.deep_128.glom.df, cols=c("Genus"))
ps.b.deep_128.glom.df.g<-subset(ps.b.deep_128.glom.df.g, 
                                                  Genus %in% c("Sideroxydans","Gallionella","Ferriphaselus",
                                                               "Sulfurimonas","Sulfurovum","Sulfuricurvum"))
ps.b.deep_128.glom.df.g$Genus = factor(ps.b.deep_128.glom.df.g$Genus, 
                                                       levels = c("Gallionella","Sideroxydans","Ferriphaselus",
                                                               "Sulfuricurvum","Sulfurovum","Sulfurimonas"))
ps.b.deep_128.glom.df.g$Month = factor(ps.b.deep_128.glom.df.g$Month,
                                           levels=c("December", "August", "April"))
ps.b.deep_128.glom.df.g.plot <- ggplot(ps.b.deep_128.glom.df.g, 
       aes(x=Month, y=Abundance, color=Site.name)) +
  geom_point(aes(fill=Site.name, 
                 color=Site.name)) +
  geom_smooth(aes(group=Site.name),
              method="loess", se = FALSE) +
  facet_wrap(~Genus)+
  theme(axis.title.y = element_blank()) +
  coord_flip() +
  scale_x_discrete(expand=c(0.05, 0.05)) +
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13)) +
  scale_y_sqrt(breaks = c(0.01,0.05,0.15,0.25,0.5,0.75,1),
               labels = scales::percent)
```
```{r message=FALSE, warning=FALSE, ,fig.width=14}
ps.b.r.ProteoCl.AllPhy.temp.plot
ps.b.deep_128.glom.df.g.plot
```

Interestingly, seasonality seems to have a strong effect on the dataset. Specifically, at the genus-level, it seems most of the spikes in relative abundance are due to the Summmer, and only a few sites show effects that correlate with the year passing by. However, lest us not forget only 20% of the genera were classified with SILVA_128 and SILVA_132 didn't really improve on that.
The contradicting trends between Crumlin and Celynen at class-level abundance of Epsilonproteobacteria seem to be explained by the higher abundances of genus Sulfurovum, albeit Sulfuricurvum shows the opposite trends.

This lack of proper strong relations between month and genera might have to do with the fact that only ~19% of all SVs were classified at genus-level:

```{r}
sv.phyl.g<-as.data.frame(table(tax_table(ps.b.r)[, "Genus"], exclude = NULL))
sv.phyl.ord.g <- sv.phyl.g[order(-sv.phyl.g$Freq),] 
head(sv.phyl.ord.g, n=10)
1-56551/sum(sv.phyl.ord.g$Freq)
```

Further on this, seasonality should have a strong effect on the dataset, right?

```{r}
set.seed(1)
ps_jsd <- phyloseq::distance(ps.b.r, method = "jsd")
sampledf <- data.frame(sample_data(ps.b.r))
adonis(ps_jsd ~ Month, data = sampledf, strata = sampledf$Time_point, permutations=1e3)
beta_m <- betadisper(ps_jsd, sampledf$Month)
permutest(beta_m)
```

Seems it doesn't! It seems Month doesn't explain significantly variation in the dataset (other variables do), but at least (permutest on betadisper) different month don't have the same dispersions. This can mean that adonis() results then aren't that good but who cares, I'm looking at only a number of genera in the dataset and this takes in account the whole thing irrespectively of taxonomy. #commonsense

A more visual representation of this could be the following:
```{r}
ps.b.r.pcoa  <- ordinate(ps.b.r, "PCoA", distance="jsd", 
                         k=2, trymax=1e3, weighted=TRUE)

ps.b.r.pcoa.plot.a1 <- plot_ordination(ps.b.r, ps.b.r.pcoa, axes = c(1,2),
                                       color="Site.name", shape="Month") +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(alpha=0.5, size=4)+
  facet_wrap(~Site.name, nrow = 4, ncol=4) +
  scale_alpha(guide = 'none') +
  theme(legend.position = "none")
```

```{r, fig.height=12, fig.width=14}
ps.b.r.pcoa.plot.a1
```

There we are, not a lot of variation beta-diversity-wise across the year aside from some exceptions.

And is alpha-diversity impacted by seasonality?

```{r alpha div}
ps.b.rich=plot_richness(ps.b, x="Month", measures="Shannon",
                        color="Site.name") + 
  geom_point(size = 5, alpha=0.4) +
  facet_wrap(~Site.name) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 25, vjust=1, hjust=1),
        axis.title.x = element_blank()) +
  ylab("Shannon Diversity")
```
```{r , fig.height=12, fig.width=14}
ps.b.rich
```

It seems like so. Specifically, Blaenavon and Celynen N seem to decrease along the year. On the other side, Cefn Hengoed, Glyncastle, Morlais seem to be positively correlated with the passing of the year. However, most indicate slight Summer-related changes in community composition. This coincides loosely with the genus-level plot.

## Conclusions:
1. Fe- and S-rich sites present distinct taxonomic profiles.
2. Fe-rich profiles are mainly populated by Betaproteobacterial taxa, namely genera Gallionella, Sideroxydans and only occuring in Taffs Well, Ferriphaselus.
3. S-rich sites are rich in Epsilonproteobacteria including genera Sulfuricurvum, Sulfurovum and Sulfurimonas.
4. Lindsay presents an unsual site in the dataset, where CPR phylum Parcubacteria and Proteobacteria amount to ~40% of the profile, the remainder phyla being present in very low proportions.
5, Beta-, Epsilon- and Gammaproteobacteria seem to be affected by seasonality in general by either peaking or bottoming in relative abundance in the Summer. In some sites, they seem to increase or decrease along the year.
6. At the genus-level, Gallionella relative presence in the dataset seems to markedly decrease across the year in Blaenavon. There's a steep decrease in Sideroxydans presence in Mountain Gate. Ferriphaselus increases in abundance across the year but only in Taffs Well.
7. Sulfuricurvum and Sulfurovum show a clear interplay in relative presence, with the first peaking in abundance in August, and the latter on April and December. This is clearly seen for Crumlin Navigation and Celynen North. In Six Bells, the opposite happen at a less obvious degree.
8. In spite of all this, Month doesn't significantly explain variation in the dataset. This is better seen through a PCoA where in spite of some variation in general, samples from a same site cluster in spite of season.
9. As expected, alpha-diversity is affected by season, reflecting the seen above genus-level trends.