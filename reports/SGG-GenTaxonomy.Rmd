---
title: "SGG - Who are the main players?"
author: "Andr√© Soares"
date: "8 January 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r initial loadings, include=FALSE}
library(dada2); packageVersion("dada2")
library(ggplot2); packageVersion("ggplot2")
library(phyloseq); packageVersion("phyloseq")
library(data.table); packageVersion("data.table")
library(DESeq2); packageVersion("DESeq2")
library(dplyr)
library(plyr)
library(magrittr)
library(RColorBrewer)
library(phangorn)
library(DECIPHER)
library("structSSI")
library(ips)
library(msa)
library(picante)
library(igraph)
library(cowplot)
library(plotly)
library(lemon)
```

```{r load SV data, echo=FALSE}
SGG_SVt = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/seqtab_final.rds")
SGG_Tax = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/tax_final.rds")
sgg_metadata<-read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/SGG_metadata.csv", header=TRUE)
order<-rownames(SGG_SVt)
sgg_metadata_ord<-sgg_metadata[match(order, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord) <- sgg_metadata_ord$Sample_Code
ps <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord), 
               tax_table(SGG_Tax))
ps.a = subset_samples(ps, Site.name != "Taffs Well PUMPED")
ps.b = subset_samples(ps.a, Sample_type != "Control")
ps.b <- prune_taxa(taxa_sums(ps.b) > 0, ps.b)
#order months
sample_data(ps.b)$Month = factor(sample_data(ps.b)$Month, 
                                 levels = c("April","August","December"))
#to relative abundances
ps.b = subset_taxa(ps.b, Kingdom %in% c("Archaea", "Bacteria"))
ps.b.r <-  transform_sample_counts(ps.b, function(x) {x/sum(x)} ) 
```

##1 - General view of taxonomic profiles across the dataset

```{r general proteobacterial taxonomy}
# agglomerate taxa
ps.b.r.glom <- tax_glom(ps.b.r, taxrank = 'Phylum', NArm = FALSE)
# create dataframe from phyloseq object
ps.b.r.glom.psdf <- data.table(psmelt(ps.b.r.glom))
# convert Phylum to a character vector from a factor because R
ps.b.r.glom.psdf$Phylum <- as.character(ps.b.r.glom.psdf$Phylum)
# group dataframe by Phylum, calculate median rel. abundance
ps.b.r.glom.psdf[, median := median(Abundance, na.rm = TRUE), 
                 by = "Phylum"]
# Change name to remainder of Phylum less than 1%
ps.b.r.glom.psdf[(median <= 0.01), Phylum := "Other"]
#Removing Proteobacteria from previous table
ps.b.r.glom.psdf.noProteo<-ps.b.r.glom.psdf[!grepl("Proteobacteria", ps.b.r.glom.psdf$Phylum),]
#New table, with Proteobacterial classes only
ps.b.r.ProtCl = subset_taxa(ps.b.r, Phylum == "Proteobacteria")
ps.b.r.ProtCl.glom <- tax_glom(ps.b.r.ProtCl, taxrank = 'Class', NArm = FALSE)
# create dataframe from phyloseq object
ps.b.r.ProtCl.glom.psdf <- data.table(psmelt(ps.b.r.ProtCl.glom))
# convert Class to a character vector from a factor because R
ps.b.r.ProtCl.glom.psdf$Class <- as.character(ps.b.r.ProtCl.glom.psdf$Class)
# group dataframe by Phylum, calculate median rel. abundance
ps.b.r.ProtCl.glom.psdf[, median := median(Abundance, na.rm = TRUE), 
                        by = "Class"]
# Change name to remainder of Phylum less than 1%
ps.b.r.ProtCl.glom.psdf[(median <= 0.01), Class := "Other Proteobacteria"]
ps.b.r.ProtCl.glom.psdf.noP <- subset(ps.b.r.ProtCl.glom.psdf, select = -Phylum)
#same name= allows merging
names(ps.b.r.glom.psdf.noProteo)[names(ps.b.r.glom.psdf.noProteo) == 'Phylum'] <- 'Taxa'
names(ps.b.r.ProtCl.glom.psdf.noP)[names(ps.b.r.ProtCl.glom.psdf.noP) == 'Class'] <- 'Taxa'
#join the two
ps.b.r.ProteoCl.AllPhy <- rbind(ps.b.r.glom.psdf.noProteo, ps.b.r.ProtCl.glom.psdf.noP)
ps.b.r.ProteoCl.AllPhy.plot<-ggplot(ps.b.r.ProteoCl.AllPhy[Abundance > 0], 
                                    aes(x = Site.name, y = Abundance/3, fill = Taxa)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance\n")
#totals vary because the bars = medians
```
```{r , fig.height=14, fig.width=20}
ps.b.r.ProteoCl.AllPhy.plot
```

Clearly, the dataset is mostly populated by Beta- and Epsilonproteobacteria, which seem to correspond to iron- and sulphur-rich sites, respectively. However, certain sites like Lindsay, Cefn Hengoed and Mountain Gate have large percentages of either 'Other' less abundant phyla or have ~30-50% of their profiles dominated by Parcubacteria and Omnitrophica.

No obvious temporal trends arise from this, aside from indications that Betaproteobacterial presence decreases across the year in Blaenavon, cefn Hengoed and Morlais. The opposite happens in Taff Bargoed and Taffs Well. The Epsilonproteobacterial dominance in Crumlin Navigation and Celynen North seems to be opposed only be Gammaproteobacteria.

Is this dominance explain by particular genera? Yep, seems like so. Also, some temporal trends seem to pop up. We'll take a look at that later.

```{r genera plot}
ps.b.deep_128 = subset_taxa(ps.b.r, 
                            Phylum=="Proteobacteria" | Phylum=="Parcubacteria" | Phylum=="Omnitrophica" | Phylum=="Woesearchaeota_(DHVEG-6)")
ps.b.deep_128.glom <- tax_glom(ps.b.deep_128, taxrank = 'Genus', NArm = FALSE)
ps.b.deep_128.glom.df <- data.table(psmelt(ps.b.deep_128.glom))
colourCount_128 = length(unique(ps.b.deep_128.glom.df[Abundance > 0.03]$Genus))+1
ps.b.deep_128.glom.df.plot<-ggplot(ps.b.deep_128.glom.df[Abundance > 0.03], 
                                        aes(x = Site.name, y = Abundance/3, fill = Genus)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 40, hjust = 1)) + 
  guides(fill = guide_legend(nrow = colourCount_128)) +
  ylab("Relative Abundance\n") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(colourCount_128), 
                    na.value = "gray48")
```
```{r , fig.height=20, fig.width=14}
ps.b.deep_128.glom.df.plot
```

A Gallionella-dominated profile comes up, where an interplay with Sideroxydans creates an interesting intra-Gallionellaceae dynamic. Taffs Well again shows an interesting profile as Ferriphaselus, not present in the rest of the dataset, comes up as a main player but only in this site. Sulphur-rich sites show profiles dominated by Sulfurovum and Sulfuricurvum, with other sulphur-related genera come up briefly. Finally, high amounts of genera-unclassified SV's show up.

Quickly, it seems from the phylum-level graph that Lindsay has a much more diverse profile i.e. more than 40% of the profile is made up of 'Other' phyla. Let's take a closer look at that.

```{r lindsay}
ps.b.r.LindsayCHen = subset_samples(ps.b.r, Site.name=="Lindsay")
ps.b.r.glom.phy <- tax_glom(ps.b.r.LindsayCHen, taxrank = 'Phylum', NArm = FALSE )
ps.b.r.glom.phy.psdf <- data.table(psmelt(ps.b.r.glom.phy))
ps.b.r.glom.phy.psdf.f <- ps.b.r.glom.phy.psdf[ , c("Abundance","Phylum")]
ps.b.r.glom.phy.psdf.f.s<-ps.b.r.glom.phy.psdf.f[, .(count=.N, var=mean(Abundance)), by = Phylum]

ps.b.r.glom.phy.psdf.f.s <- transform(ps.b.r.glom.phy.psdf.f.s, Phylum=reorder(Phylum, -var)) 
ps.b.r.glom.phy.psdf.f.s.plot=ggplot(ps.b.r.glom.phy.psdf.f.s, aes(x=Phylum, y=var, color=Phylum)) +
  geom_point() +
  geom_hline(yintercept = 0.01,
             color="gray",
             linetype="dashed") +
  ylab("Relative abundance") +
  theme(axis.text.x = element_text(angle=40, hjust = 1, vjust = 1),
        axis.title.x = element_blank(),
        legend.position = "none")
```
```{r ,fig.width=14}
ps.b.r.glom.phy.psdf.f.s.plot
```

This site is clearly populated by a microbial community where a number of phyla co-exist in relatively low (between 25 and 5%) proportions.

##2 - Are there temporal effects to the taxonomic profiles of the dataset?

```{r temporal taxonomy, message=FALSE, warning=FALSE}
#phylum-level, interesting
ps.b.r = prune_taxa(taxa_sums(ps.b.r) > 0, ps.b.r)

ps.b.r.ProteoCl.AllPhy.temp<-ps.b.r.ProteoCl.AllPhy[!grepl("Other", ps.b.r.ProteoCl.AllPhy$Taxa),]
ps.b.r.ProteoCl.AllPhy.temp<-ps.b.r.ProteoCl.AllPhy.temp[!grepl("Other Proteobacteria", ps.b.r.ProteoCl.AllPhy.temp$Taxa),]
ps.b.r.ProteoCl.AllPhy.temp<-na.omit(ps.b.r.ProteoCl.AllPhy.temp, cols=c("Taxa"))
ps.b.r.ProteoCl.AllPhy.temp$Taxa = factor(ps.b.r.ProteoCl.AllPhy.temp$Taxa, 
                                                       levels = c("Betaproteobacteria","Epsilonproteobacteria","Gammaproteobacteria",
                                                                  "Parcubacteria","Omnitrophica","Actinobacteria","Deltaproteobacteria"))

taxa_number_pl<-length(unique(ps.b.r.ProteoCl.AllPhy.temp$Site.name)) +1

ps.b.r.ProteoCl.AllPhy.temp.plot <- ggplot(subset(ps.b.r.ProteoCl.AllPhy.temp, 
                                                  Taxa %in% c("Betaproteobacteria","Epsilonproteobacteria","Gammaproteobacteria",
                                                                  "Parcubacteria","Omnitrophica","Actinobacteria","Deltaproteobacteria")), 
       aes(x=Month, y=Abundance, color=Site.name)) +
  geom_point(aes(fill=Site.name, 
                 color=Site.name)) +
  geom_smooth(aes(group=Site.name),
              method="loess", se = FALSE) +
  facet_wrap(~Taxa, 
             ncol=4, nrow=2)+
  theme(axis.title.y = element_blank()) +
  coord_flip() +
  scale_x_discrete(expand=c(0.05, 0.05))

#family-level, not much
ps.b.deep_128.glom.df.f<-na.omit(ps.b.deep_128.glom.df, cols=c("Family"))
ps.b.deep_128.glom.df.f<-subset(ps.b.deep_128.glom.df.f, 
                                                  Family %in% c("Helicobacteraceae","Gallionellaceae"))
ps.b.deep_128.glom.df.f$Family = factor(ps.b.deep_128.glom.df.f$Family, 
                                                       levels = c("Gallionellaceae","Helicobacteraceae"))
ps.b.deep_128.glom.df.f.plot <- ggplot(ps.b.deep_128.glom.df.f, 
       aes(x=Month, y=Abundance, color=Site.name)) +
  geom_point(aes(fill=Site.name, 
                 color=Site.name)) +
  geom_smooth(aes(group=Site.name),
              method="loess", se = FALSE) +
  facet_wrap(~Family)+
  theme(axis.title.y = element_blank()) +
  coord_flip() +
  scale_x_discrete(expand=c(0.05, 0.05))

#genus-level, very interesting
ps.b.deep_128.glom.df.g<-na.omit(ps.b.deep_128.glom.df, cols=c("Genus"))
ps.b.deep_128.glom.df.g<-subset(ps.b.deep_128.glom.df.g, 
                                                  Genus %in% c("Sideroxydans","Gallionella","Ferriphaselus",
                                                               "Sulfurimonas","Sulfurovum","Sulfuricurvum"))
ps.b.deep_128.glom.df.g$Genus = factor(ps.b.deep_128.glom.df.g$Genus, 
                                                       levels = c("Gallionella","Sideroxydans","Ferriphaselus",
                                                               "Sulfuricurvum","Sulfurovum","Sulfurimonas"))
ps.b.deep_128.glom.df.g.plot <- ggplot(ps.b.deep_128.glom.df.g, 
       aes(x=Month, y=Abundance, color=Site.name)) +
  geom_point(aes(fill=Site.name, 
                 color=Site.name)) +
  geom_smooth(aes(group=Site.name),
              method="loess", se = FALSE) +
  facet_wrap(~Genus)+
  theme(axis.title.y = element_blank()) +
  coord_flip() +
  scale_x_discrete(expand=c(0.05, 0.05))

```
```{r ,fig.width=14}
ps.b.r.ProteoCl.AllPhy.temp.plot
ps.b.deep_128.glom.df.g.plot
```

Interestingly, seasonality seems to have a strong effect on the dataset. Communities are clearly different in the Summer and even at genus level trends are noted.

So, how does this translate to beta-diversity?

##3 - Community structure

```{r pcoa}
ps.b.r.pcoa  <- ordinate(ps.b.r, "PCoA", distance="jsd", 
                         k=2, trymax=1e3, weighted=TRUE)

ps.b.r.pcoa.v = data.table(ps.b.r.pcoa$vectors, keep.rownames = TRUE)
sdt = data.table(as(sample_data(ps.b.r), "data.frame"), keep.rownames = TRUE)

setnames(ps.b.r.pcoa.v, "rn", "Sample.ID")
df <- subset(sdt, select = -c(Sample.ID) )
setnames(df, "rn", "Sample.ID")
setkey(ps.b.r.pcoa.v, Sample.ID)
setkey(df, Sample.ID)
ps.b.r.pcoa.v <- ps.b.r.pcoa.v[df]
# Axis 1
ps.b.r.pcoa.v.plot=ggplot(ps.b.r.pcoa.v, aes(Month, Axis.1, color = Site.name)) +
  geom_point(size = 3) +
  geom_point(size = 5, alpha=0.4) + 
  facet_wrap(~Site.name) +
  theme(axis.text.x = element_text(angle = 25, vjust=1, hjust=1)) +
  ylab("JSD PCoA Axis 1")
```
```{r , fig.height=12, fig.width=14}
ps.b.r.pcoa.v.plot
```

Meh. It seems that except for month-specific outliers, seasonality doesn't have much effect on the beta-diversity.

And is alpha-diversity impacted by seasonality?

```{r alpha div}
ps.b.rich=plot_richness(ps.b, x="Month", measures="Shannon",
                        color="Site.name") + 
  geom_point(size = 5, alpha=0.4) +
  facet_wrap(~Site.name) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 25, vjust=1, hjust=1),
        axis.title.x = element_blank()) +
  ylab("Shannon Diversity")
```
```{r , fig.height=12, fig.width=14}
ps.b.rich
```

It seems like so. Specifically, Blaenavon and Celynen N seem to decrease along the year. On the other side, Cefn Hengoed, Glyncastle, Morlais seem to be positively correlated with the passing of the year.

#####################################
### START FROM HERE ################
#####################################


```{r investigate neg pos cors month}
ps.b.r.posnegs = subset_samples(ps.b.r, Site.name=="Blaenavon" | Site.name=="Celynen North" | Site.name=="Cefn Hengoed" | Site.name=="Glyncastle" | Site.name=="Morlais")
ps.b.r.posnegs.class = subset_taxa(ps.b.r.posnegs, Class=="Betaproteobacteria" | Class=="Deltaproteobacteria" | Class=="Gammaproteobacteria" | Class=="Epsilonproteobacteria" | Class=="Elusimicrobia")
ps.b.r.posnegs.glom <- tax_glom(ps.b.r.posnegs.class, taxrank = 'Order', NArm = FALSE)
ps.b.r.posnegs.glom.psdf <- data.table(psmelt(ps.b.r.posnegs.glom))
ps.b.r.posnegs.glom.psdf$Order <- as.character(ps.b.r.posnegs.glom.psdf$Order)
ps.b.r.posnegs.glom.psdf$Abundance <- as.numeric(ps.b.r.posnegs.glom.psdf$Abundance)
ps.b.r.posnegs.glom.psdf.plot<-ggplot(ps.b.r.posnegs.glom.psdf[Abundance > 0.05],
                                          aes(x=Order,y=Abundance,
                                              fill=Order)) + 
  geom_point(aes(color=Order, fill=Order,
                 size=Abundance)) + 
  facet_rep_grid(Site.name~Month)+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  coord_fixed(ratio = 6)
```
```{r , fig.height=12, fig.width=14}
ps.b.r.posnegs.glom.psdf.plot
```

Ok then, some clear trends showing up, let's try and identify if this is a large-scale effort or the work of specific SVs.

```{r investigate neg pos cors month deeper}
ps.b.r.posnegs.genus.glom <- tax_glom(ps.b.r.posnegs.class, taxrank = 'Genus', NArm = FALSE)
ps.b.r.posnegs.genus.glom.psdf <- data.table(psmelt(ps.b.r.posnegs.genus.glom))
ps.b.r.posnegs.genus.glom.psdf$Genus <- as.character(ps.b.r.posnegs.genus.glom.psdf$Genus)
ps.b.r.posnegs.genus.glom.psdf$Abundance <- as.numeric(ps.b.r.posnegs.genus.glom.psdf$Abundance)
ps.b.r.posnegs.genus.glom.psdf.plot<-ggplot(ps.b.r.posnegs.genus.glom.psdf[Abundance > 0.01],
                                          aes(x=Genus,y=Abundance,
                                              fill=Genus)) + 
  geom_point(aes(color=Genus, fill=Genus,
                 size=Abundance)) +
  facet_rep_grid(Site.name~Month) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  guides(col = guide_legend(nrow = 22))
```
```{r , fig.height=12, fig.width=14}
ps.b.r.posnegs.genus.glom.psdf.plot
```

Interesting stuff, seems Rhodoferax was ignored as a significant contributor for Betaproteobacterial trends across the dataset. Revisit that.
