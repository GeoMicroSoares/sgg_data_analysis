---
title: "SILVA128 vs. 132: a quick comparison"
author: "Andr√© Soares"
date: "19 February 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r initial loadings, include=FALSE}
library(dada2); packageVersion("dada2")
library(ggplot2); packageVersion("ggplot2")
library(phyloseq); packageVersion("phyloseq")
library(data.table); packageVersion("data.table")
library(DESeq2); packageVersion("DESeq2")
library(dplyr)
library(plyr)
library(magrittr)
library(RColorBrewer)
library(phangorn)
library(DECIPHER)
library("structSSI")
library(ips)
library(msa)
library(picante)
library(igraph)
library(cowplot)
library(plotly)
```
```{r load SILVA_128 data, echo=FALSE}
SGG_SVt = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/seqtab_final.rds")
SILVA_132_tax <- readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/SILVA_132_tax_final.rds")
sgg_metadata<-read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/SGG_metadata.csv", header=TRUE)
order<-row.names(SGG_SVt)
sgg_metadata_ord<-sgg_metadata[match(order, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord) <- sgg_metadata_ord$Sample_Code
ps_132 <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord),
               tax_table(SILVA_132_tax))
```
```{r load SILVA_132 data, echo=FALSE}
SGG_SVt = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/seqtab_final.rds")
SILVA_128_tax = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/tax_final.rds")
ps_128 <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord), 
               tax_table(SILVA_128_tax))
```
```{r customize both datasets, echo=FALSE}
#128
ps_128.a = subset_samples(ps_128, Site.name != "Taffs Well PUMPED")
ps_128.b = subset_samples(ps_128.a, Sample_type != "Control")
ps_128.b <- prune_taxa(taxa_sums(ps_128.b) > 0, ps_128.b)
sample_data(ps_128.b)$Month = factor(sample_data(ps_128.b)$Month, 
                                 levels = c("April","August","December"))
ps_128.b = subset_taxa(ps_128.b, Kingdom %in% c("Archaea", "Bacteria"))
ps_128.b.r <-  transform_sample_counts(ps_128.b, function(x) {x/sum(x)} )
#132
ps_132.a = subset_samples(ps_132, Site.name != "Taffs Well PUMPED")
ps_132.b = subset_samples(ps_132.a, Sample_type != "Control")
ps_132.b <- prune_taxa(taxa_sums(ps_132.b) > 0, ps_132.b)
sample_data(ps_132.b)$Month = factor(sample_data(ps_132.b)$Month, 
                                 levels = c("April","August","December"))
ps_132.b = subset_taxa(ps_132.b, Kingdom %in% c("Archaea", "Bacteria"))
ps_132.b.r <-  transform_sample_counts(ps_132.b, function(x) {x/sum(x)} ) 
```

##1 - Phylum-level taxonomy

Both datasets have been processed the same way through DADA2. How many between datasets and in what abundances?

```{r phylum tables}
sv.phyl.128<-as.data.frame(table(tax_table(ps_128.b.r)[, "Phylum"], exclude = NULL))
#sheer phyla numbers
length(sv.phyl.128$Var1)
sv.phyl.128.ord <- sv.phyl.128[order(-sv.phyl.128$Freq),] 
head(sv.phyl.128.ord, n=10)
sv.phyl.132<-as.data.frame(table(tax_table(ps_132.b.r)[, "Phylum"], exclude = NULL))
#sheer phyla numbers
length(sv.phyl.132$Var1)
sv.phyl.132.ord <- sv.phyl.132[order(-sv.phyl.132$Freq),]
head(sv.phyl.132.ord, n=10)
```

So, SILVA_132 gives 7 phyla less than SILVA_128. Numbers for unclassified SVs decreased slightly, but not much.
However, the panorama changed slightly for the classified phyla, now that Patescibacteria includes Parcubacteria and others. Woesearchaeota disappeared now that it's been included within Nanoarchaeota. 
The number of Bacteroidetes-assigned SVs increased (by ~600 SVs), while Firmicutes SVs decreased by 300. Chloroflexi and Actinobacteria maintained their previous numbers.

Did this decrease unclassified taxa numbers?
```{r unc taxa}
#128
6006/sum(sv.phyl.128.ord$Freq)
#132
5675/sum(sv.phyl.132.ord$Freq)
```

Nope.

General views of phylum-level taxonomy plus proteobacterial diversity.

```{r phylum barcharts}
ps_128.b.r.glom <- tax_glom(ps_128.b.r, taxrank = 'Phylum', NArm = FALSE)
ps_128.b.r.glom.ps_128df <- data.table(psmelt(ps_128.b.r.glom))
ps_128.b.r.glom.ps_128df$Phylum <- as.character(ps_128.b.r.glom.ps_128df$Phylum)
ps_128.b.r.glom.ps_128df[, median := median(Abundance, na.rm = TRUE), 
                 by = "Phylum"]
ps_128.b.r.glom.ps_128df[(median <= 0.01), Phylum := "Other"]
ps_128.b.r.glom.ps_128df.noProteo<-ps_128.b.r.glom.ps_128df[!grepl("Proteobacteria", ps_128.b.r.glom.ps_128df$Phylum),]
ps_128.b.r.ProtCl = subset_taxa(ps_128.b.r, Phylum == "Proteobacteria")
ps_128.b.r.ProtCl.glom <- tax_glom(ps_128.b.r.ProtCl, taxrank = 'Class', NArm = FALSE)
ps_128.b.r.ProtCl.glom.ps_128df <- data.table(psmelt(ps_128.b.r.ProtCl.glom))
ps_128.b.r.ProtCl.glom.ps_128df$Class <- as.character(ps_128.b.r.ProtCl.glom.ps_128df$Class)
ps_128.b.r.ProtCl.glom.ps_128df[, median := median(Abundance, na.rm = TRUE), 
                        by = "Class"]
ps_128.b.r.ProtCl.glom.ps_128df[(median <= 0.01), Class := "Other Proteobacteria"]
ps_128.b.r.ProtCl.glom.ps_128df.noP <- subset(ps_128.b.r.ProtCl.glom.ps_128df, select = -Phylum)
names(ps_128.b.r.glom.ps_128df.noProteo)[names(ps_128.b.r.glom.ps_128df.noProteo) == 'Phylum'] <- 'Taxa'
names(ps_128.b.r.ProtCl.glom.ps_128df.noP)[names(ps_128.b.r.ProtCl.glom.ps_128df.noP) == 'Class'] <- 'Taxa'
ps_128.b.r.ProteoCl.AllPhy <- rbind(ps_128.b.r.glom.ps_128df.noProteo, ps_128.b.r.ProtCl.glom.ps_128df.noP)
taxa_number_128<-length(unique(ps_128.b.r.ProteoCl.AllPhy$Taxa))
ps_128.b.r.ProteoCl.AllPhy.plot<-ggplot(ps_128.b.r.ProteoCl.AllPhy[Abundance > 0], 
                                    aes(x = Site.name, y = Abundance/3, fill = Taxa)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(nrow = taxa_number_128)) +
  ylab("Relative Abundance\n") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(taxa_number_128), 
                    na.value = "gray48")
#now for SILVA_132
ps_132.b.r.glom <- tax_glom(ps_132.b.r, taxrank = 'Phylum', NArm = FALSE)
ps_132.b.r.glom.ps_132df <- data.table(psmelt(ps_132.b.r.glom))
ps_132.b.r.glom.ps_132df$Phylum <- as.character(ps_132.b.r.glom.ps_132df$Phylum)
ps_132.b.r.glom.ps_132df[, median := median(Abundance, na.rm = TRUE), 
                 by = "Phylum"]
ps_132.b.r.glom.ps_132df[(median <= 0.01), Phylum := "Other"]
ps_132.b.r.glom.ps_132df.noProteo<-ps_132.b.r.glom.ps_132df[!grepl("Proteobacteria", ps_132.b.r.glom.ps_132df$Phylum),]
ps_132.b.r.ProtCl = subset_taxa(ps_132.b.r, Phylum == "Proteobacteria")
ps_132.b.r.ProtCl.glom <- tax_glom(ps_132.b.r.ProtCl, taxrank = 'Class', NArm = FALSE)
ps_132.b.r.ProtCl.glom.ps_132df <- data.table(psmelt(ps_132.b.r.ProtCl.glom))
ps_132.b.r.ProtCl.glom.ps_132df$Class <- as.character(ps_132.b.r.ProtCl.glom.ps_132df$Class)
ps_132.b.r.ProtCl.glom.ps_132df[, median := median(Abundance, na.rm = TRUE), 
                        by = "Class"]
ps_132.b.r.ProtCl.glom.ps_132df[(median <= 0.01), Class := "Other Proteobacteria"]
ps_132.b.r.ProtCl.glom.ps_132df.noP <- subset(ps_132.b.r.ProtCl.glom.ps_132df, select = -Phylum)
names(ps_132.b.r.glom.ps_132df.noProteo)[names(ps_132.b.r.glom.ps_132df.noProteo) == 'Phylum'] <- 'Taxa'
names(ps_132.b.r.ProtCl.glom.ps_132df.noP)[names(ps_132.b.r.ProtCl.glom.ps_132df.noP) == 'Class'] <- 'Taxa'
ps_132.b.r.ProteoCl.AllPhy <- rbind(ps_132.b.r.glom.ps_132df.noProteo, ps_132.b.r.ProtCl.glom.ps_132df.noP)
taxa_number_132<-length(unique(ps_132.b.r.ProteoCl.AllPhy$Taxa))
ps_132.b.r.ProteoCl.AllPhy.plot<-ggplot(ps_132.b.r.ProteoCl.AllPhy[Abundance > 0], 
                                    aes(x = Site.name, y = Abundance/3, fill = Taxa)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(nrow = taxa_number_132)) +
  ylab("Relative Abundance\n") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(taxa_number_132), 
                    na.value = "gray48")
```
```{r, fig.height=16,fig.width=22, message=FALSE, warning=FALSE}
ps_128.b.r.ProteoCl.AllPhy.plot + ggtitle("SILVA_128 Taxonomy") +
                             labs(subtitle = "Phyla above 1% relative abundance")
ps_132.b.r.ProteoCl.AllPhy.plot + ggtitle("SILVA_132 Taxonomy") +
                             labs(subtitle = "Phyla above 1% relative abundance")
```

Very similar patterns come up, but SILVA_132 clearly a bit more clear due to smaller phyla numbers.

##1 - Genus-level taxonomy of dominant phyla

```{r genus level tax}
ps.b.deep_128 = subset_taxa(ps_128.b.r, 
                            Phylum=="Proteobacteria" | Phylum=="Parcubacteria" | Phylum=="Omnitrophica" | Phylum=="Woesearchaeota_(DHVEG-6)")
ps.b.deep_128.glom <- tax_glom(ps.b.deep_128, taxrank = 'Genus', NArm = FALSE)
ps.b.deep_128.glom.df <- data.table(psmelt(ps.b.deep_128.glom))
colourCount_128 = length(unique(ps.b.deep_128.glom.df[Abundance > 0.03]$Genus))+1
ps.b.deep_128.glom.df.plot<-ggplot(ps.b.deep_128.glom.df[Abundance > 0.03], 
                                        aes(x = Site.name, y = Abundance/3, fill = Genus)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 40, hjust = 1)) + 
  guides(fill = guide_legend(nrow = colourCount_128)) +
  ylab("Relative Abundance\n") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(colourCount_128), 
                    na.value = "gray48")

ps.b.deep_132 = subset_taxa(ps_132.b.r, 
                            Phylum=="Epsilonbacteraeota" | Phylum=="Proteobacteria" | Phylum=="Patescibacteria" | Phylum=="Omnitrophicaeota")
ps.b.deep_132.glom <- tax_glom(ps.b.deep_132, taxrank = 'Genus', NArm = FALSE)
ps.b.deep_132.glom.df <- data.table(psmelt(ps.b.deep_132.glom))
colourCount_132 = length(unique(ps.b.deep_132.glom.df[Abundance > 0.03]$Genus))+1
ps.b.deep_132.glom.df.plot<-ggplot(ps.b.deep_132.glom.df[Abundance > 0.03], 
                                        aes(x = Site.name, y = Abundance/3, fill = Genus)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 40, hjust = 1)) + 
  guides(fill = guide_legend(nrow = colourCount_132)) +
  ylab("Relative Abundance\n") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(colourCount_132), 
                    na.value = "gray48")
```
```{r, fig.height=16,fig.width=22, message=FALSE, warning=FALSE}
ps.b.deep_128.glom.df.plot + ggtitle("SILVA_128 Taxonomy") +
                             labs(subtitle = "Genera above 3% relative abundance")
ps.b.deep_132.glom.df.plot + ggtitle("SILVA_132 Taxonomy") +
                             labs(subtitle = "Genera above 3% relative abundance")
```

'nough said I think. Not much improves with SILVA_132 aside from slight increases in classifying SILVA_128 unclassified SVs.