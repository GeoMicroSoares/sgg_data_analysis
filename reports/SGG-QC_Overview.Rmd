---
title: "SGG - Overview, Quality Control"
author: "Andr√© Soares"
date: "15 February 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r initial loadings, include=FALSE}
library(dada2); packageVersion("dada2")
library(ggplot2); packageVersion("ggplot2")
library(phyloseq); packageVersion("phyloseq")
library(data.table); packageVersion("data.table")
library(DESeq2); packageVersion("DESeq2")
library(dplyr)
library(plyr)
library(magrittr)
library(RColorBrewer)
library(phangorn)
library(DECIPHER)
library("structSSI")
library(ips)
library(msa)
library(picante)
library(igraph)
library(cowplot)
library(plotly)
```
```{r load OTU data, echo=FALSE}
SGG_otu_tab = "/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_OTU/SGG_OTU_m.txt"
SGG_otu_tab_imp<-read.csv(SGG_otu_tab, sep="\t", header = TRUE, row.names = 1, check.names = FALSE)
OTU = otu_table(SGG_otu_tab_imp, taxa_are_rows = TRUE)
OTU_t = t(OTU)
SGG_otu_tax = "/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_OTU/SGG_OTU_tax_c.txt"
SGG_otu_tax_imp<-read.csv(SGG_otu_tax, sep="\t", header = TRUE, row.names = 1)
SGG_OTU_tax<-as.matrix(SGG_otu_tax_imp)
sgg_metadata<-read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/SGG_metadata.csv", header=TRUE)
order<-rownames(OTU_t)
sgg_metadata_ord<-sgg_metadata[match(order, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord) <- sgg_metadata_ord$Sample_Code
ps_otu<-phyloseq(otu_table(OTU), 
                 tax_table(SGG_OTU_tax), 
                 sample_data(sgg_metadata_ord))
```
```{r load SV data, echo=FALSE}
SGG_SVt = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/seqtab_final.rds")
SGG_Tax = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/tax_final.rds")
ps <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord), 
               tax_table(SGG_Tax))
```

##1 - Basic information about the dataset

```{r}
#how many reads left in seqtab_bimR?
sum(rowSums(otu_table(ps)))
#How many SVs in ps?
ntaxa(otu_table(ps))
```

How does sequencing depth vary across the samples?

Is there a noticeable batch effect?

```{r seq depth}
readsumsdf_samples<-data.frame(nreads = sample_sums(ps),
                               samples = rownames(as.data.frame(sample_sums(ps))),
                               batch = sample_data(ps)$Batch,
                               site_name = sample_data(ps)$Site.name)
readsumsdf_samples_ord<-readsumsdf_samples[order(readsumsdf_samples$samples),]

samples_table <- table(as.numeric(readsumsdf_samples$samples))
samples_levels <- names(samples_table)[order(samples_table)]
samples_levels[c(121,122,123,124,125,126,127,128)] <- c("P1","P2","P3","P4","S1","S2","S3","S4")
readsumsdf_samples$samples2 <- factor(readsumsdf_samples$samples, levels = samples_levels)

op=ggplot(readsumsdf_samples, aes(x=samples2,y=nreads, 
                                  color=as.factor(batch), fill=as.factor(batch))) +
  geom_bar(stat = "identity") +
  scale_y_log10(breaks=c(0,100,500,1000,5000,10000,25000,50000,100000,200000)) +
  geom_hline(yintercept =1416,
             color="dark red",
             linetype="dashed") +
  facet_wrap(~site_name) +
  scale_fill_brewer(palette = "Set1") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())
```
```{r , fig.width=20, fig.height=12}
op
```

What's the total number of sequences by site?

```{r reads by site}
readsumsdf_samples.f <- readsumsdf_samples[ , c("nreads","site_name")]
rownames(readsumsdf_samples.f) <- NULL
df_a<-aggregate(readsumsdf_samples.f$nreads, by=list(Category=readsumsdf_samples.f$site_name), FUN=sum)
df_a$Category <- factor(df_a$Category, levels = df_a$Category[order(df_a$x)])
ggplot(df_a, aes(x=Category, y=x, fill=x)) + 
  geom_point() +
  ylab("Number of reads") +
  theme(axis.text.x = element_text(angle=30, hjust=1, vjust=1),
        axis.title.x = element_blank(),
        legend.position = "none")
```

##2 - Contaminants analysis

```{r contaminants analysis}
ps.control = subset_samples(ps, Sample_type == "Control")
ps.control.f = prune_taxa(taxa_sums(ps.control) > 0, ps.control)
plot_bar(ps.control.f, fill="Genus") +
  annotate("text", y= 150, x ="P4",label=paste("Total SVs: 12\nTotal Reads:742")
           ,hjust=0.5, size=6)
```

Ok, more reads than one would like, but do these 12 SVs play significant roles in the dataset?

```{r contaminants in the dataset}
ps.r <-  transform_sample_counts(ps, function(x) {x/sum(x)} ) 
control.taxa = names(taxa_sums(ps.control.f))
ps.control.taxa = prune_taxa(control.taxa, ps)
ps.control.glom <- tax_glom(ps.control.taxa, taxrank = 'Genus', NArm = FALSE)
ps.control.glom.psdf <- data.table(psmelt(ps.control.glom))
ps.control.glom.psdf$Month = factor(ps.control.glom.psdf$Month, 
                                    levels = c("April","August","December","Control"))
ps.control.glom.psdf$Genus <- as.character(ps.control.glom.psdf$Genus)
ps.control.glom.psdf[, median := median(Abundance, nam = TRUE), 
                     by = "Genus"]
ps.control.glom.psdf.plot<-ggplot(ps.control.glom.psdf[Abundance > 0], 
                                  aes(x = Site.name, y = Abundance/3, fill = Genus)) + 
  facet_grid(Month~.) +
  # scale_y_log10(breaks=c(10,100,1000,30000)) +
  geom_bar(stat = "identity",position = "dodge") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance\n")
ps.control.glom.psdf.plot
```

Yes, the SVs seen on controls do seem to play important roles in the dataset. However, their presence in the controls is probably due to either barcode bleeing or sampling mishandling at some point of the molecular analysis. There is no evidence pointing towards samples having been contaminated.
