---
title: "SGG - How does metadata relate to the microbiome?"
author: "André Soares"
date: "8 January 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r initial loadings, message=FALSE, warning=FALSE, include=FALSE}
library(dada2); packageVersion("dada2")
library(ggplot2); packageVersion("ggplot2")
library(phyloseq); packageVersion("phyloseq")
library(data.table); packageVersion("data.table")
library(DESeq2); packageVersion("DESeq2")
library(dplyr)
library(plyr)
library(magrittr)
library(RColorBrewer)
library(phangorn)
library(DECIPHER)
library("structSSI")
library(ips)
library(msa)
library(picante)
library(igraph)
library(cowplot)
library(plotly)
library(lemon)
library(GGally)
library(randomcoloR)
```

```{r load SV data, echo=FALSE}
SGG_SVt = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/seqtab_final.rds")
SGG_Tax = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_data_trimmed_DADA2_table/tax_final.rds")
sgg_metadata<-read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/SGG_metadata.csv", header=TRUE)
order<-rownames(SGG_SVt)
sgg_metadata_ord<-sgg_metadata[match(order, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord) <- sgg_metadata_ord$Sample_Code
ps <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord), 
               tax_table(SGG_Tax))
ps.a = subset_samples(ps, Site.name != "Taffs Well PUMPED")
ps.b = subset_samples(ps.a, Sample_type != "Control")
ps.b <- prune_taxa(taxa_sums(ps.b) > 0, ps.b)
#order months
sample_data(ps.b)$Month = factor(sample_data(ps.b)$Month, 
                                 levels = c("April","August","December"))
#to relative abundances
ps.b = subset_taxa(ps.b, Kingdom %in% c("Archaea", "Bacteria"))
ps.b.r <-  transform_sample_counts(ps.b, function(x) {x/sum(x)} ) 
```

##**1 -** Visualizing SGG metadata

```{r main metadata}
sample_data(ps.b.r)$Site.name = factor(sample_data(ps.b.r)$Site.name, 
                                          levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
metadata<-sample_data(ps.b.r)
#Temp
temp_table.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=Temp.C, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  geom_hline(yintercept = 13.4,
             color="dark red",
             linetype="dashed") +
  geom_hline(yintercept = 11,
             color="gray",
             linetype="dashed") +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=12),
        legend.position = "bottom",
        legend.title = element_text(face = "bold"),
        legend.background = element_rect(fill="gray95", size=.5, linetype="dotted")) +
  annotate("text", "Mountain Gate", 14, vjust = -1, hjust=.45, size= 4,
           label = "Average mine water temperature (Farr et al, 2016)") +
  labs(y=expression(paste("Temperature (",degree,"C)")))
#DO
do.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=`DO..sat`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  geom_line(aes(group=Month, color=Month),
            stat="smooth", method="loess", 
            alpha = 0.4, size=1.5) +
  geom_hline(yintercept = 50,
           color="gray60",
           linetype="dashed") +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=12),
        legend.position = "none") +
  labs(y="Dissolved Oxygen (%)")
#Sulfate
so4.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=`SO4..µg.ml`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  geom_line(aes(group=Month, color=Month),
            stat="smooth", method="loess", 
            alpha = 0.4, size=1.5) +
  geom_hline(yintercept = 500,
         color="gray60",
         linetype="dashed") +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=12),
        legend.position = "none") +
  labs(y=expression(paste("SO"[4]^{-2},"(",mu,"g.mL"^{-1},")"))) +
  guides(size=FALSE)
#pH
pH.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=`pH`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  geom_line(aes(group=Month, color=Month),
            stat="smooth", method="loess", 
            alpha = 0.4, size=1.5) +
  geom_hline(yintercept = 7,
           color="gray60",
           linetype="dashed") +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=12),
        legend.position = "none") +
  labs(y="pH") +
  guides(size=FALSE)
#EC
ec.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=`EC.uS.cm`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  geom_line(aes(group=Month, color=Month),
            stat="smooth", method="loess", 
            alpha = 0.4, size=1.5) +
  geom_hline(yintercept = 2000,
           color="gray60",
           linetype="dashed") +
  geom_hline(yintercept = 1000,
           color="grey80",
           linetype="dashed") +
  scale_y_continuous(breaks=c(0,500,1000,1500,2000,2500,3000)) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle = 25, hjust = 1, size= 14),
        axis.text.y = element_text(size=12),
        legend.position = "top",
        legend.title = element_text(face = "bold"),
        legend.background = element_rect(fill="gray95", size=.5, linetype="dotted")) +
  labs(y=expression(paste("EC (",mu,"S.cm"^{-1},")")))
```
```{r message=FALSE, warning=FALSE, fig.height=11, fig.width=10}
plot_grid(temp_table.plot, do.plot, so4.plot, pH.plot, ec.plot, ncol = 1, align='v', rel_heights = c(1.75,1,1,1,1.75))
```

And does sulfate 'more or less' negatively correlate with DO just to make sure?

```{r}
do.so4.plot<-ggplot(metadata, 
                        aes(x=Site.name)) +
  geom_point(aes(y=`DO..sat`,
                 fill="Dissolved Oxygen", color="Dissolved Oxygen",
                 shape=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  geom_point(aes(y=`SO4..µg.ml`/12,
                 fill="Sulfate", color="Sulfate",
                 shape=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  geom_line(aes(y=`DO..sat`,
                group=Month, 
                color="Dissolved Oxygen"),
            stat="smooth", method="loess", 
            alpha = 0.4, size=1.5) +
  geom_line(aes(y=`SO4..µg.ml`/12,
                group=Month, 
                color="Sulfate"),
        stat="smooth", method="loess", 
        alpha = 0.4, size=1.5) +
  scale_colour_manual(values = c("dodgerblue1", "firebrick2")) +
  scale_y_continuous(sec.axis = sec_axis(~.*12, name = expression(paste("SO"[4]^{-2},"(",mu,"g.mL"^{-1},")")))) +
  labs(y="Dissolved Oxygen (%)",
       colour = "Parameter") +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle=35, hjust = 1,vjust = 1),
        axis.text.y = element_text(size=12),
        legend.position = "top",
        legend.justification = "center",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13, face = "bold"),
        legend.direction = "vertical") +
  guides(fill = FALSE)
```
```{r fig.width=14, message=FALSE, warning=FALSE}
do.so4.plot
```

Yep-ish.

Now for our metals. Do they have any apparent influence on our sites? They may just model how Gallionella and Sideroxydans interact for example.

Subsetting metada to only hold metals in the data frame.

```{r}
metadata_metals = metadata[, c("Site.name", "Month", "K.µg.ml", "Mg.µg.ml", "Na.µg.ml", "X6.Li.ng.ml", "X9.Be.ng.ml", "X11.B.ng.ml",           "X27.Al.ng.ml",      "X45.Sc.ng.ml",      "X47.Ti.ng.ml",      "X51.V..He..ng.ml", "X52.Cr..He..ng.ml", "X59.Co.ng.ml",      "X60.Ni.ng.ml", "X63.Cu.ng.ml",      "X68.Zn.ng.ml",      "X69.Ga.ng.ml",      "X74.Ge.ng.ml", "X75.As..He..ng.ml", "X78.Se.ng.ml",      "X85.Rb.ng.ml",            "X89.Y.ng.ml",       "X90.Zr.ng.ml", "X93.Nb.ng.ml",      "X97.Mo.ng.ml",      "X98.Mo.ng.ml",      "X111.Cd.ng.ml",     "X114.Cd.ng.ml", "X115.In.ng.ml",     "X123.Sb.ng.ml",     "X125.Te.ng.ml", "X133.Cs.ng.ml",     "X135.Ba.ng.ml", "X139.La.ng.ml",     "X140.Ce.ng.ml",     "X141.Pr.ng.ml",     "X146.Nd.ng.ml",     "X147.Sm.ng.ml",    
"X153.Eu.ng.ml",     "X157.Gd.ng.ml",     "X159.Tb.ng.ml",     "X163.Dy.ng.ml",     "X165.Ho.ng.ml", "X166.Er.ng.ml",     "X169.Tm.ng.ml",     "X172.Yb.ng.ml",     "X175.Lu.ng.ml",     "X181.Ta.ng.ml", "X182.W.ng.ml",      "X200.Hg.ng.ml",     "X201.Hg.ng.ml",     "X202.Hg.ng.ml",     "X205.Tl.ng.ml", "X206.Pb.ng.ml",     "X207.Pb.ng.ml",     "X209.Bi.ng.ml",     "X232.Th.ng.ml",     "X238.U.ng.ml", "X55.Mn.ng.ml", "X88.Sr.ng.ml")]
sort(round(colMeans(metadata_metals[,3:ncol(metadata_metals)], na.rm = TRUE), digits = 5))
```

Let's split the data then: low, low-medium, medium and high values.

```{r fig.height=14, fig.width=16, message=FALSE, warning=FALSE}
metadata_low_metals = metadata[, c("Site.name", "Month","Time_point", "X175.Lu.ng.ml", "X169.Tm.ng.ml", "X114.Cd.ng.ml", "X159.Tb.ng.ml", "X165.Ho.ng.ml", "X209.Bi.ng.ml", "X111.Cd.ng.ml", "X172.Yb.ng.ml", "X166.Er.ng.ml", "X205.Tl.ng.ml", "X181.Ta.ng.ml", "X74.Ge.ng.ml", "X153.Eu.ng.ml", "X202.Hg.ng.ml", "X201.Hg.ng.ml", "X123.Sb.ng.ml", "X200.Hg.ng.ml", "X163.Dy.ng.ml", "X147.Sm.ng.ml", "X125.Te.ng.ml", "X157.Gd.ng.ml", "X115.In.ng.ml", "X9.Be.ng.ml", "X141.Pr.ng.ml", "X52.Cr..He..ng.ml", "X232.Th.ng.ml", "X51.V..He..ng.ml", "X146.Nd.ng.ml", "X133.Cs.ng.ml", "X182.W.ng.ml", "X90.Zr.ng.ml", "X89.Y.ng.ml", "X238.U.ng.ml", "X93.Nb.ng.ml", "X139.La.ng.ml", "X97.Mo.ng.ml", "X98.Mo.ng.ml", "X140.Ce.ng.ml", "X47.Ti.ng.ml", "X45.Sc.ng.ml")]

metadata_low_metals_long <- melt(metadata_low_metals, 
                             id=c("Site.name","Month","Time_point"))

metadata_low_metals_long$Site.name = factor(metadata_low_metals_long$Site.name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
numbers_low <- length(unique(metadata_low_metals_long$variable))
low_cols = colorRampPalette(brewer.pal(12, "Paired"))(41)

metadata_low_metals_long_plot<-ggplot(metadata_low_metals_long, 
                        aes(x=Site.name, y=value,
                            fill=variable, color=variable)) +
  geom_point(aes(fill=variable, color=variable, alpha = 0.5),
             size=4,
             position = position_dodge(width=0.5)) +
  geom_line(aes(fill=variable, color=variable, 
                group=variable, alpha=0.5)) +
  facet_grid(Month~.) +
  scale_y_log10() +
  scale_color_manual(values=low_cols) +
  scale_fill_manual(values=low_cols) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle = 35, hjust = 1, size= 14),
        axis.text.y = element_text(size=12)) +
  labs(y="Concentrations in ppm")
metadata_low_metals_long_plot
```

Hmm.

Low-medium now.

```{r fig.height=14, fig.width=16, message=FALSE, warning=FALSE}
metadata_low_medium_metals = metadata[, c("Site.name", "Month", "X63.Cu.ng.ml", "X69.Ga.ng.ml", "X78.Se.ng.ml", "X206.Pb.ng.ml", "X207.Pb.ng.ml", "X75.As..He..ng.ml", "X59.Co.ng.ml")]
metadata_low_medium_metals_long <- melt(metadata_low_medium_metals, 
                             id=c("Site.name","Month"))
metadata_low_medium_metals_long$Site.name = factor(metadata_low_medium_metals_long$Site.name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
numbers_low_medium <- length(unique(metadata_low_medium_metals_long$variable))
low_medium_cols = colorRampPalette(brewer.pal(12, "Paired"))(numbers_low_medium)

metadata_low_medium_metals_long_plot<-ggplot(metadata_low_medium_metals_long, 
                        aes(x=Site.name, y=value)) +
  geom_point(aes(fill=variable, color=variable),
             size=4,
             position = position_dodge(width=0.5)) +
  geom_line(aes(fill=variable, color=variable, 
                group=variable, alpha=0.5)) +
  facet_grid(Month~.) +
  # scale_y_sqrt() +
  scale_color_manual(values=low_medium_cols) +
  scale_fill_manual(values=low_medium_cols) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle = 35, hjust = 1, size= 14),
        axis.text.y = element_text(size=12)) +
  labs(y="Concentrations in ppm")
metadata_low_medium_metals_long_plot
```

Hmm.

Medium values.

```{r fig.height=14, fig.width=16, message=FALSE, warning=FALSE}
metadata_medium_metals = metadata[, c("Site.name", "Month", "X68.Zn.ng.ml", "X85.Rb.ng.ml", "X60.Ni.ng.ml", "X206.Pb.ng.ml", "K.µg.ml", "Mg.µg.ml", "X27.Al.ng.ml", "X11.B.ng.ml", "X135.Ba.ng.ml", "X6.Li.ng.ml", "Na.µg.ml")]
metadata_medium_metals_long <- melt(metadata_medium_metals, 
                             id=c("Site.name","Month"))
metadata_medium_metals_long$Site.name = factor(metadata_medium_metals_long$Site.name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
numbers_medium <- length(unique(metadata_medium_metals_long$variable))
medium_cols = colorRampPalette(brewer.pal(12, "Paired"))(numbers_medium)
metadata_medium_metals_long_plot<-ggplot(metadata_medium_metals_long, 
                        aes(x=Site.name, y=value)) +
  geom_point(aes(fill=variable, color=variable),
             size=4,
             position = position_dodge(width=0.5)) +
  geom_line(aes(fill=variable, color=variable, 
                group=variable, alpha=0.5)) +
  facet_grid(Month~.) +
  # scale_y_sqrt() +
  scale_color_manual(values=medium_cols) +
  scale_fill_manual(values=medium_cols) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle = 35, hjust = 1, size= 14),
        axis.text.y = element_text(size=12)) +
  labs(y="Concentrations in ppm")
metadata_medium_metals_long_plot
```

High values.

```{r fig.height=14, fig.width=16, message=FALSE, warning=FALSE}
metadata_high_metals = metadata[, c("Site.name", "Month", "X88.Sr.ng.ml", "X55.Mn.ng.ml")]
metadata_high_metals_long <- melt(metadata_high_metals, 
                             id=c("Site.name","Month"))
metadata_high_metals_long$Site.name = factor(metadata_high_metals_long$Site.name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
numbers_high <- length(unique(metadata_high_metals_long$variable))
high_cols = colorRampPalette(brewer.pal(12, "Paired"))(numbers_high)
metadata_high_metals_long_plot<-ggplot(metadata_high_metals_long, 
                        aes(x=Site.name, y=value)) +
  geom_point(aes(fill=variable, color=variable),
             size=4,
             position = position_dodge(width=0.5)) +
  geom_line(aes(fill=variable, color=variable, 
                group=variable, alpha=0.5)) +
  facet_grid(Month~.) +
  scale_color_manual(values=high_cols) +
  scale_fill_manual(values=high_cols) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle = 35, hjust = 1, size= 14),
        axis.text.y = element_text(size=12)) +
  labs(y="Concentrations in ppm")
metadata_high_metals_long_plot
```

Do certain metal concentrations correlate with microbial abundance?

```{r}
ps.b.deep_128 = subset_taxa(ps.b.r, 
                            Family=="Gallionellaceae" | Family=="Helicobacteraceae")
ps.b.deep_128.glom <- tax_glom(ps.b.deep_128, taxrank = 'Genus', NArm = FALSE)
ps.b.deep_128.glom.df <- data.table(psmelt(ps.b.deep_128.glom))
levels(ps.b.deep_128.glom.df$Genus)<-c(levels(ps.b.deep_128.glom.df$Genus),
                                     c("Unc. Gallionellaceae","Unc. Helicobacteraceae"))
ps.b.deep_128.glom.df$Genus[is.na(ps.b.deep_128.glom.df$Genus) & ps.b.deep_128.glom.df$Family=="Gallionellaceae"] <- "Unc. Gallionellaceae"
ps.b.deep_128.glom.df$Genus[is.na(ps.b.deep_128.glom.df$Genus) & ps.b.deep_128.glom.df$Family=="Helicobacteraceae"] <- "Unc. Helicobacteraceae"
# ps.b.deep_128.glom.df.unkonly.f<-subset(ps.b.deep_128.glom.df.unkonly, 
#                                                   Abundance > 0.03)

metadata_cor_main_genera = ps.b.deep_128.glom.df[, c("Genus", "Abundance", "Site.name", "Month", "Time_point","SO4..µg.ml",
                                                     "X55.Mn.ng.ml","Mg.µg.ml","X68.Zn.ng.ml","Na.µg.ml","X6.Li.ng.ml",
                                                     "X135.Ba.ng.ml","X11.B.ng.ml","X75.As..He..ng.ml","X59.Co.ng.ml",
                                                     "X63.Cu.ng.ml","X78.Se.ng.ml","X200.Hg.ng.ml","X201.Hg.ng.ml","X202.Hg.ng.ml")]
names(metadata_cor_main_genera) = c("Genus", "Abundance", "Site_name", "Month", "Time_point","SO4","Mn","Mg","Zn","Na","Li","Ba",
                                    "B","As","Co","Cu","Se","X200_Hg","X201_Hg","X202_Hg")

high_metadata_cor_main_genera = metadata_cor_main_genera[, c("Genus", "Abundance", "Site_name", "Month", "Time_point","Mn","SO4")]
high_metadata_cor_main_genera=high_metadata_cor_main_genera[complete.cases(high_metadata_cor_main_genera), ]
dm1 <- melt(high_metadata_cor_main_genera[,c("Site_name","Month","Genus","Abundance")], id=c("Site_name","Month","Abundance"))
dm1 = dm1[, c("Site_name", "Month","value","Abundance")]
colnames(dm1) <- c("Site_name", "Month", "Genus", "Abundance")
dm2 <- melt(high_metadata_cor_main_genera[,c("Site_name","Month","Mn","SO4")], id=c("Site_name","Month"))
colnames(dm2) <- c("Site_name", "Month", "metals", "metal_ppm")
high_metadata_cor_main_genera_melt <- merge(dm1, dm2, allow.cartesian=TRUE)

high_metadata_cor_main_genera_melt$Site_name = factor(high_metadata_cor_main_genera_melt$Site_name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
high_metadata_cor_main_genera_melt$Genus = factor(high_metadata_cor_main_genera_melt$Genus, 
                                                       levels = c("Gallionella","Sideroxydans","Ferriphaselus","Unc. Gallionellaceae",
                                                                  "Sulfurovum","Sulfurimonas", "Unc. Helicobacteraceae",
                                                                  "Sulfuricurvum","Sulfuriferula"))

high_metadata_cor_main_genera_melt_plot<-ggplot(high_metadata_cor_main_genera_melt, 
                        aes(x=Site_name)) +
  geom_point(aes(y=Abundance,
                 fill=Genus,
                 shape=Month,
                 size=Abundance,
                 alpha=0.5),
             color="transparent",
             position = position_dodge(width=0.5)) +
  geom_point(aes(y=metal_ppm/2000,
                 shape=Month,
                 color=metals),
             size=2,
             position = position_dodge(width=0.5)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(8, "Dark2"))(9)) +
  scale_colour_manual(values = brewer.pal(6, "Paired")) +
  scale_y_continuous(sec.axis = sec_axis(~.*2000, name = "Concentrations in ppm")) +
  scale_shape_manual(values = c(21,22,23)) +
  labs(y="Relative Abundance (%)") +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle=35, hjust = 1,vjust = 1),
        axis.text.y = element_text(size=12),
        legend.position = "right",
        legend.justification = "center",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13, face = "bold"),
        legend.direction = "vertical") +
  guides(fill = guide_legend(override.aes = list(colour=colorRampPalette(brewer.pal(8, "Dark2"))(9),
                                                 shape=15, size=3)),
         size=NULL)
#medium
#removed zinc and mg because they didn't show any relevant patterns
medium_metadata_cor_main_genera = metadata_cor_main_genera[, c("Genus", "Abundance", "Site_name", "Month", "Time_point",
                                                               "Na","Li","Ba","B")]
medium_metadata_cor_main_genera=medium_metadata_cor_main_genera[complete.cases(medium_metadata_cor_main_genera$Genus), ]
dm1 <- melt(medium_metadata_cor_main_genera[,c("Site_name","Month","Genus","Abundance")], id=c("Site_name","Month","Abundance"))
dm1 = dm1[, c("Site_name", "Month","value","Abundance")]
colnames(dm1) <- c("Site_name", "Month", "Genus", "Abundance")
dm2 <- melt(medium_metadata_cor_main_genera[,c("Site_name","Month","Na","Li","Ba","B")], id=c("Site_name","Month"))
colnames(dm2) <- c("Site_name", "Month", "metals", "metal_ppm")
medium_metadata_cor_main_genera_melt <- merge(dm1, dm2, allow.cartesian=TRUE)

medium_metadata_cor_main_genera_melt$Site_name = factor(medium_metadata_cor_main_genera_melt$Site_name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
medium_metadata_cor_main_genera_melt$Genus = factor(medium_metadata_cor_main_genera_melt$Genus, 
                                                       levels = c("Gallionella","Sideroxydans","Ferriphaselus","Unc. Gallionellaceae",
                                                                  "Sulfurovum","Sulfurimonas", "Unc. Helicobacteraceae",
                                                                  "Sulfuricurvum","Sulfuriferula"))
medium_metadata_cor_main_genera_melt_plot<-ggplot(medium_metadata_cor_main_genera_melt, 
                        aes(x=Site_name)) +
  geom_point(aes(y=Abundance,
                 fill=Genus,
                 shape=Month,
                 size=Abundance,
                 alpha=0.5),
             color="transparent",
             position = position_dodge(width=0.5)) +
  geom_point(aes(y=metal_ppm/400,
                 shape=Month,
                 color=metals),
             size=3,
             position = position_dodge(width=0.5)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(8, "Dark2"))(9)) +
  scale_colour_manual(values = brewer.pal(6, "Paired")) +
  scale_shape_manual(values = c(21,22,23)) +
  scale_y_continuous(sec.axis = sec_axis(~.*400, name = "Concentrations in ppm")) +
  labs(y="Relative Abundance (%)") +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle=35, hjust = 1,vjust = 1),
        axis.text.y = element_text(size=12),
        legend.position = "right",
        legend.justification = "center",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13, face = "bold"),
        legend.direction = "vertical") +
  guides(fill = guide_legend(override.aes = list(colour=colorRampPalette(brewer.pal(8, "Dark2"))(9),
                                                 shape=15, size=3)),
         size=NULL)
#low-medium
low_medium_metadata_cor_main_genera = metadata_cor_main_genera[, c("Genus", "Abundance", "Site_name", "Month", "Time_point",
                                                               "As","Co","Cu","Se")]
low_medium_metadata_cor_main_genera=low_medium_metadata_cor_main_genera[complete.cases(low_medium_metadata_cor_main_genera$Genus), ]
dm1 <- melt(low_medium_metadata_cor_main_genera[,c("Site_name","Month","Genus","Abundance")], id=c("Site_name","Month","Abundance"))
dm1 = dm1[, c("Site_name", "Month","value","Abundance")]
colnames(dm1) <- c("Site_name", "Month", "Genus", "Abundance")
dm2 <- melt(low_medium_metadata_cor_main_genera[,c("Site_name","Month","As","Co","Cu","Se")], id=c("Site_name","Month"))
colnames(dm2) <- c("Site_name", "Month", "metals", "metal_ppm")
low_medium_metadata_cor_main_genera_melt <- merge(dm1, dm2, allow.cartesian=TRUE)

low_medium_metadata_cor_main_genera_melt$Site_name = factor(low_medium_metadata_cor_main_genera_melt$Site_name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
low_medium_metadata_cor_main_genera_melt$Genus = factor(low_medium_metadata_cor_main_genera_melt$Genus, 
                                                       levels = c("Gallionella","Sideroxydans","Ferriphaselus","Unc. Gallionellaceae",
                                                                  "Sulfurovum","Sulfurimonas", "Unc. Helicobacteraceae",
                                                                  "Sulfuricurvum","Sulfuriferula"))
low_medium_metadata_cor_main_genera_melt_plot<-ggplot(low_medium_metadata_cor_main_genera_melt, 
                        aes(x=Site_name)) +
  geom_point(aes(y=Abundance,
                 fill=Genus,
                 shape=Month,
                 size=Abundance,
                 alpha=0.5),
             color="transparent",
             position = position_dodge(width=0.5)) +
  geom_point(aes(y=metal_ppm/50,
                 shape=Month,
                 color=metals),
             size=3,
             position = position_dodge(width=0.5)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(8, "Dark2"))(9)) +
  scale_colour_manual(values = brewer.pal(6, "Paired")) +
  scale_shape_manual(values = c(21,22,23)) +
  scale_y_continuous(sec.axis = sec_axis(~.*50, name = "Concentrations in ppm")) +
  labs(y="Relative Abundance (%)") +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle=35, hjust = 1,vjust = 1),
        axis.text.y = element_text(size=12),
        legend.position = "right",
        legend.justification = "center",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13, face = "bold"),
        legend.direction = "vertical") +
  guides(fill = guide_legend(override.aes = list(colour=colorRampPalette(brewer.pal(8, "Dark2"))(9),
                                                 shape=15, size=3)),
         size=NULL)
#low
low_metadata_cor_main_genera = metadata_cor_main_genera[, c("Genus", "Abundance", "Site_name", "Month", "Time_point",
                                                               "X200_Hg","X201_Hg","X202_Hg")]
low_metadata_cor_main_genera=low_metadata_cor_main_genera[complete.cases(low_metadata_cor_main_genera$Genus), ]
dm1 <- melt(low_metadata_cor_main_genera[,c("Site_name","Month","Genus","Abundance")], id=c("Site_name","Month","Abundance"))
dm1 = dm1[, c("Site_name", "Month","value","Abundance")]
colnames(dm1) <- c("Site_name", "Month", "Genus", "Abundance")
dm2 <- melt(low_metadata_cor_main_genera[,c("Site_name","Month","X200_Hg","X201_Hg","X202_Hg")], id=c("Site_name","Month"))
colnames(dm2) <- c("Site_name", "Month", "metals", "metal_ppm")
low_metadata_cor_main_genera_melt <- merge(dm1, dm2, allow.cartesian=TRUE)

low_metadata_cor_main_genera_melt$Site_name = factor(low_metadata_cor_main_genera_melt$Site_name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
low_metadata_cor_main_genera_melt$Genus = factor(low_metadata_cor_main_genera_melt$Genus, 
                                                       levels = c("Gallionella","Sideroxydans","Ferriphaselus","Unc. Gallionellaceae",
                                                                  "Sulfurovum","Sulfurimonas", "Unc. Helicobacteraceae",
                                                                  "Sulfuricurvum","Sulfuriferula"))
low_metadata_cor_main_genera_melt_plot<-ggplot(low_metadata_cor_main_genera_melt, 
                        aes(x=Site_name)) +
  geom_point(aes(y=Abundance,
                 fill=Genus,
                 shape=Month,
                 size=Abundance,
                 alpha=0.5),
             color="transparent",
             position = position_dodge(width=0.5)) +
  geom_point(aes(y=metal_ppm*3,
                 shape=Month,
                 color=metals),
             size=3,
             position = position_dodge(width=0.5)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(8, "Dark2"))(9)) +
  scale_colour_manual(values = brewer.pal(3, "Paired")) +
  scale_shape_manual(values = c(21,22,23)) +
  scale_y_continuous(sec.axis = sec_axis(~./3, name = "Concentrations in ppm")) +
  labs(y="Relative Abundance (%)") +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle=35, hjust = 1,vjust = 1),
        axis.text.y = element_text(size=12),
        legend.position = "right",
        legend.justification = "center",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13, face = "bold"),
        legend.direction = "vertical") +
  guides(fill = guide_legend(override.aes = list(colour=colorRampPalette(brewer.pal(8, "Dark2"))(9),
                                                 shape=15, size=3)),
         size=NULL)
```

```{r, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
high_metadata_cor_main_genera_melt_plot
```

Nothing to say here.

```{r, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
medium_metadata_cor_main_genera_melt_plot
```

Actually quite interesting, it seems barium is only high in the sulfur sites and in Taffs! Could barium concentrations be driving Ferriphaselus abundances in the dataset? Barium concentrations are also quite different in the three sulfur sites. They seem to drive the Sulfurovum peaks in Crumlin, where as in Six Bells, Na, Li and B are quite high but it seems the presence of barium kind of seems to unlock the dominance of this genus. Much lower concentrations of Na, Li and B with Ba at ~150ppm sends Sulfuricurvum to the dominant position.

It seems higher Na concentrations are related to sites lacking dominance of iron-oxidizers. Also, Ynysarwed has unusual lithium concentrations.

```{r, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
low_medium_metadata_cor_main_genera_melt_plot
```

~50ppm As + ~100ppm Li may explain lack of Gallionellaceae dominance in Ynysarwed. 

```{r, message=FALSE, warning=FALSE, fig.width=16, fig.height=8}
low_metadata_cor_main_genera_melt_plot
```

But how does the overal picture look regarding how variables relate to one another?

```{r metadata cors}
#remove all columns with one or more NA entry
#NA in DO substituted to the mean of the two values in the site
sgg_metadata<-as(sample_data(ps.b.r),"data.frame")
sgg_metadata$DO..sat[is.na(sgg_metadata$DO..sat)] <- 44.1
sgg_metadata_noNA = sgg_metadata[ , colSums(is.na(sgg_metadata)) == 0]
colnames(sgg_metadata_noNA) <- c("Sample_Code","Sample.ID","Sample_type","Site.ID","Site.name","Time_point","Month","Batch","Date", "Time",
                                 "Temperature","EC","DO","K","Na","Cl","SO4","6_Li","7_Li","7_Li_He","B","Sc","Mn","Co","Ni","Ga","As","Se",
                                 "Rb","Sr","Y","Te","Cs","Ba","La","Nd","Eu","Er","Lu","U")
sgg_metadata_noNA_april<-subset(sgg_metadata_noNA, 
                                                  Month %in% c("April"))
sgg_metadata_noNA_august<-subset(sgg_metadata_noNA, 
                                                  Month %in% c("August"))
sgg_metadata_noNA_december<-subset(sgg_metadata_noNA, 
                                                  Month %in% c("December"))
cols_to_go_april <- names(sgg_metadata_noNA_april) %in% c("Sample_Code", "Sample.ID", "Sample_type","Site.ID",
                                                "Site.name","Time_point","Month","Batch",
                               "Date","Time")
cols_to_go_august <- names(sgg_metadata_noNA_august) %in% c("Sample_Code", "Sample.ID", "Sample_type","Site.ID",
                                                        "Site.name","Time_point","Month","Batch",
                               "Date","Time")
cols_to_go_december <- names(sgg_metadata_noNA_december) %in% c("Sample_Code", "Sample.ID", "Sample_type","Site.ID",
                                                            "Site.name","Time_point","Month","Batch",
                               "Date","Time")
sgg_metadata_noNA_april_f <- sgg_metadata_noNA_april[!cols_to_go_april]
sgg_metadata_noNA_august_f <- sgg_metadata_noNA_august[!cols_to_go_august]
sgg_metadata_noNA_december_f <- sgg_metadata_noNA_december[!cols_to_go_december]

april_corr<-ggcorr(sgg_metadata_noNA_april_f, method = c("all.obs", "spearman"),
                   palette = "RdBu",
                   nbreaks = 10, hjust = 1, 
                   size=4, layout.exp = 6) + 
                   ggtitle("April")
august_corr<-ggcorr(sgg_metadata_noNA_august_f, method = c("all.obs", "spearman"), 
                    palette = "RdBu",
                    nbreaks = 10, hjust = 1, 
                    size=4, layout.exp = 6) + 
                    ggtitle("August")
december_corr<-ggcorr(sgg_metadata_noNA_december_f, method = c("all.obs", "spearman"), 
                      palette = "RdBu",
                      nbreaks = 10, hjust = 1, 
                      size=4, layout.exp = 6) + 
                      ggtitle("December")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
april_corr
august_corr
december_corr
```

**Pearson** assumes linearity between variables as well as normal distributions of data and is sensible to transformation. **Spearman** is a nonparametric measure of rank correlation as **Kendall** is, meaning they don't care about transformations. **Kendall** meaures strength of dependence between two variables. **Spearman** does not make assumptions of data distribution and measures degree of association between two variables.

There's clearly a lot of variation, but definitely there's loads more to learn on how these variables relate.

##**2 -** Does SGG Sulfate data coincide with Coal Authority data from previous years?

```{r so4 sgg ca}
swales_ca_metadata<-read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/R_previous_BGS_chem_data_SWales.csv", header=TRUE)
swales_ca_metadata$Site = factor(swales_ca_metadata$Site, 
                                          levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taffs Well"))
swales_ca_metadata$Month = factor(swales_ca_metadata$Month, 
                                          levels = c("January","February","March","April","May","June","July",
                                                     "August","September","October","November","December"))
#Sulfate from CA
swales_ca_metadata_plot<-ggplot(swales_ca_metadata, 
                        aes(x=Site, y=`SO4.ug.mL`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  facet_wrap(~Year, ncol = 1) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle = 35, hjust = 1, vjust = 1),
        axis.text.y = element_text(size=12),
        legend.position = "bottom",
        legend.justification = "center",
        legend.text=element_text(size=7)) +
  guides(fill = guide_legend(nrow = 1),
         color = guide_legend(nrow = 1)) +
  scale_y_continuous(breaks = c(0,250,500,750,1000,1250)) +
  labs(y=expression(paste("SO"[4]^{-2},"(",mu,"g.mL"^{-1},")")))

swales_ca_metadata_2016<-subset(swales_ca_metadata, 
                                                  Year %in% c("2016"))

swales_ca_metadata_2016_plot<-ggplot(swales_ca_metadata_2016, 
                        aes(x=Site, y=`SO4.ug.mL`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1, size= 12),
        axis.text.y = element_text(size=12),
        legend.position = "bottom",
        legend.justification = "center",
        legend.text=element_text(size=8)) +
  guides(fill = guide_legend(nrow = 1),
         color = guide_legend(nrow = 1)) +
  scale_y_continuous(breaks = c(0,250,500,750,1000)) +
  labs(y=expression(paste("SO"[4]^{-2},"(",mu,"g.mL"^{-1},")"))) +
  ggtitle("CA data - 2016")

#quick prep of our own data
so4.plot.cowplot=so4.plot + 
  theme(legend.position = "bottom",
        legend.justification = "center",
        axis.text.x = element_text(angle = 25, hjust = 1, size= 12)) +
  scale_y_continuous(breaks = c(0,250,500,750,1000,1250)) +
  ggtitle("SGG data - 2016")
```

```{r message=FALSE, warning=FALSE, fig.height=10, fig.width=10}
swales_ca_metadata_plot + ggtitle("Sulfate through the years - CA")
```

How does CA's 2016 data compare with ours though?

```{r message=FALSE, warning=FALSE, fig.height=8, fig.width=10}
plot_grid(swales_ca_metadata_2016_plot, so4.plot.cowplot,
          align = 'v', ncol = 1)
```

##**3 -** According to CA data, how did iron do across our sites in 2016?

```{r}
iron_theme=theme(
        axis.title.x=element_blank(),
        axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1, size= 12),
        axis.text.y = element_text(size=8),
        axis.title.y = element_text(angle = 0, size=10),
        legend.title = element_text(size=8, face = "bold"))

KONEFE_Fe_mgL_plot<-ggplot(swales_ca_metadata_2016, 
                        aes(x=Site, y=`KONEFE_Fe_mgL`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  guides(fill = guide_legend(nrow = 1),
         color = guide_legend(nrow = 1)) +
  labs(y=expression(atop("KONEFE Iron as Fe",paste("(mg.L"^{-1},")")))) +
  iron_theme +
  theme(legend.position = "bottom",
        legend.justification = "left",
        legend.text=element_text(size=8),
        axis.text.x = element_blank())

D_Fe_mgL_plot<-ggplot(swales_ca_metadata_2016, 
                        aes(x=Site, y=`D_Fe_mgL`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  guides(fill = guide_legend(nrow = 1),
         color = guide_legend(nrow = 1)) +
  labs(y=expression(atop("Iron as Fe (Dissolved)", paste("(mg.L"^{-1},")")))) +
  iron_theme +
  theme(legend.position = "none",
        axis.text.x = element_blank())

ICPWATVAR_Fe_mgL_plot<-ggplot(swales_ca_metadata_2016, 
                        aes(x=Site, y=`ICPWATVAR_Fe_mgL`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  guides(fill = guide_legend(nrow = 1),
         color = guide_legend(nrow = 1)) +
  labs(y=expression(atop("Iron as Fe (Total) ICPWATVAR", paste("(mg.L"^{-1},")")))) +
  iron_theme +
  theme(legend.position = "bottom",
        legend.justification = "left",
        legend.text=element_text(size=8),
        axis.text.x = element_blank())

Fe2_mgL_plot<-ggplot(swales_ca_metadata_2016, 
                        aes(x=Site, y=`Fe2_mgL`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=2,
             position = position_dodge(width=0.5)) +
  guides(fill = guide_legend(nrow = 1),
         color = guide_legend(nrow = 1)) +
  labs(y=expression(atop("Ferrous Iron as Fe"^{2+""}, paste("(mg.L"^{-1},")")))) +
  iron_theme +
  theme(legend.position = "none")
```

```{r message=FALSE, warning=FALSE, fig.width=8, fig.height = 10}
plot_grid(KONEFE_Fe_mgL_plot, D_Fe_mgL_plot, ICPWATVAR_Fe_mgL_plot, Fe2_mgL_plot,
          align = 'v', ncol = 1, 
          rel_heights = c(0.1,0.1,0.1,0.1))
```

```{r eval=FALSE, include=FALSE}
library(hydrogeo)
ppm <- as.data.frame(list(Ca   = metadata$Ca.µg.mL,
            Mg   = metadata$Mg.µg.ml,
            Na   = metadata$Na.µg.ml,
            K    = metadata$K.µg.ml,
            Cl   = metadata$Cl..µg.ml,
            SO4  = metadata$SO4..µg.ml))
meq <- ppm
#correct some 'stuff'
meq$Ca[is.na(meq$Ca)] <- 194.0
meq$Mg[is.na(meq$Mg)] <- 65.70
#to meq/L
meq$Ca = meq$Ca*0.05
meq$Na = meq$Na*0.04348
meq$K = meq$K*0.0256
meq$Cl = meq$Cl*0.02817
meq$SO4 = meq$SO4*0.02083
#to percents
# meq_percents <- as.matrix(meq) %*% diag(1/colSums(as.matrix(meq))*100)
meq_pc <- meq
totalCations <- meq_pc$Ca + meq_pc$Mg + meq_pc$Na + meq_pc$K
totalAnions <- meq_pc$Cl + meq_pc$SO4
meq_pc$HCO3 <- (totalCations-totalAnions)
meq_pc$Ca <- 100 * (meq_pc$Ca/totalCations)
meq_pc$Mg <- 100 * (meq_pc$Mg/totalCations)
meq_pc$Na <- 100 * (meq_pc$Na/totalCations)
meq_pc$K <- 100 * (meq_pc$K/totalCations)
totalAnions <- meq_pc$Cl + meq_pc$SO4
# didn't measure CO3, HCO3, etc, so crap
totalAnions_2 <- meq_pc$Cl + meq_pc$SO4 + meq_pc$HCO3
meq_pc$Cl <- 100 * (meq_pc$Cl/totalAnions_2)
meq_pc$SO4 <- 100 * (meq_pc$SO4/totalAnions_2)
meq_pc$HCO3 <- 100 * (meq_pc$HCO3/totalAnions_2)
#oh god oh god
apply(meq_pc[, c("Ca", "Mg", "Na", "K")], 1, FUN = sum)
apply(meq_pc[, c("Cl", "SO4", "HCO3")], 1, FUN = sum)

data <- as.data.frame(meq_pc)
colnames(data) <- c("Ca","Mg","Na","K","Cl","SO4", "HCO3")
data$Site_name <- metadata$Site.name
data$Month <- metadata$Month

piper_data <- transform_piper_data(Ca   = data$Ca,
                                   Mg   = data$Mg,
                                   Cl   = data$Cl,
                                   SO4  = data$SO4,
                                   name = data$Site_name)
ggplot_piper() + geom_point(data=piper_data,
                            aes(x,y, 
                                colour=factor(observation),
                                size = 5))+
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13))
```

So, in 2016, while most of the other sites were close to 0, it seems a LOT of iron was being detected in Ynysarwed. Are there taxonomical evidences of more iron users there? Not really as seen on ```SGG-GenTaxonomy.html```.

##**4 -** How do environmental variables relate to microbial community structure in this dataset?

An ```adonis``` test tests "how is variation attributed to different experimental" variables, using distance matrices. It analyses how variables can be sources of variation of distance matrices and depends on fitting linear models to distance matrices. AKA PERMANOVA.

*Null hypothesis:* tested metadata categories have the same centroid. 

```{r ordination metadata}
metadata<-as(sample_data(ps.b.r),"data.frame")
metadata$DO..sat[is.na(metadata$DO..sat)] <- 44.1
metadata_noNA = metadata[ , colSums(is.na(metadata)) == 0]

ps_sig <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
                   sample_data(metadata_noNA), 
                   tax_table(SGG_Tax))
sample_data(ps_sig)$Month = factor(sample_data(ps_sig)$Month, 
                                   levels = c("April","August","December","Control"))
ps_sig_ntf = subset_samples(ps_sig, Site.name != "Taffs Well PUMPED")
ps_sig_ntf_nc = subset_samples(ps_sig_ntf, Sample_type != "Control")
ps_sig_ntf_nc_noab = subset_taxa(ps_sig_ntf_nc, Kingdom %in% c("Archaea", "Bacteria"))
ps_cap_r = transform_sample_counts(ps_sig_ntf_nc_noab, function(x) x/sum(x))

set.seed(1)
# Calculate Jensen-Shannon distance matrix
ps_cap_r_jsd <- phyloseq::distance(ps_cap_r, method = "jsd")
# make a data frame from the sample_data
sampledf_cap <- data.frame(sample_data(ps_cap_r))

adonis(ps_cap_r_jsd ~ Site.name + Temp.C + Month + EC.uS.cm + DO..sat + K.µg.ml + Na.µg.ml + Cl..µg.ml + SO4..µg.ml + X6.Li.ng.ml + X7.Li.ng.ml + X7.Li..He..ng.ml + X11.B.ng.ml + X45.Sc.ng.ml + X55.Mn.ng.ml + X59.Co.ng.ml + X60.Ni.ng.ml + X69.Ga.ng.ml + X75.As..He..ng.ml + X78.Se.ng.ml + X85.Rb.ng.ml + X88.Sr.ng.ml + X89.Y.ng.ml + X125.Te.ng.ml + X133.Cs.ng.ml + X135.Ba.ng.ml + X139.La.ng.ml + X146.Nd.ng.ml + X153.Eu.ng.ml + X166.Er.ng.ml + X175.Lu.ng.ml + X238.U.ng.ml, 
       data = sampledf_cap, strata = sampledf_cap$Time_point, permutations=1e3)
```

Site ID significantly explains >80% of the variation. Does this change with a normalised metadata table?

```{r}
norm_metadata<-read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/SGG_metadata_norm.csv", header=TRUE)
#does this change with a normalised metadata table?
normalize <- function(x) {
    return ((x - min(x)) / (max(x) - min(x)))
}
norm_metadata$Sample_Code<-as.numeric(norm_metadata$Sample_Code)
norm_metadata_s <- norm_metadata[order(norm_metadata$Sample_Code),] 
norm_metadata_s$DO..sat[is.na(norm_metadata_s$DO..sat)] <- 44.1
sampledf_cap_norm <- as.data.frame(lapply(norm_metadata_s, normalize))
sampledf_cap_norm_noNA = sampledf_cap_norm[ , colSums(is.na(sampledf_cap_norm)) == 0]
#remove Sample_Code, substitute with originals
cols_to_go_sampledf_cap_norm_noNA <- names(sampledf_cap_norm_noNA) %in% c("Sample_Code")
sampledf_cap_norm_noNA_f <- sampledf_cap_norm_noNA[!cols_to_go_sampledf_cap_norm_noNA]
sampledf_cap_norm_noNA_f$Sample_Code <- norm_metadata_s$Sample_Code
sampledf_cap_norm_noNA_f <- sampledf_cap_norm_noNA_f %>% select(Sample_Code, everything())

order_jsd<-labels(ps_cap_r_jsd)
sampledf_cap_norm_noNA_f_ord<-sampledf_cap_norm_noNA_f[match(order_jsd, sampledf_cap_norm_noNA_f$Sample_Code),]
rownames(sampledf_cap_norm_noNA_f_ord) <- sampledf_cap_norm_noNA_f_ord$Sample_Code

norm_adonis = adonis(ps_cap_r_jsd ~ Site.ID + Temp.C + Month + EC.uS.cm + DO..sat + K.µg.ml + Na.µg.ml + Cl..µg.ml + SO4..µg.ml + X6.Li.ng.ml + X7.Li.ng.ml + X7.Li..He..ng.ml + X11.B.ng.ml + X45.Sc.ng.ml + X55.Mn.ng.ml + X59.Co.ng.ml + X60.Ni.ng.ml + X69.Ga.ng.ml + X75.As..He..ng.ml + X78.Se.ng.ml + X85.Rb.ng.ml + X88.Sr.ng.ml + X89.Y.ng.ml + X125.Te.ng.ml + X133.Cs.ng.ml + X135.Ba.ng.ml + X139.La.ng.ml + X146.Nd.ng.ml + X153.Eu.ng.ml + X166.Er.ng.ml + X175.Lu.ng.ml + X238.U.ng.ml, 
       data = sampledf_cap_norm_noNA_f_ord, permutations=1e3)

#Choose the 5 variables explaining the most variation
norm_adonis_df=as(norm_adonis$aov.tab, "data.frame")
head(norm_adonis_df[order(-norm_adonis_df$R2),], n=7)
```

It does! Only Temperature and EC significantly explain more than 10% of variation. Also, loads more variables seem to significantly correlate to microbial community structure!

Testing these two variables then, to understand if their ```adonis``` results are significant:

Homogeneity of dispersion test for significant categories:

*Null hypothesis*: tested metadata categories have the same dispersions (variance).
```betadisper``` calculates average distances of samples to group centroids (from metadata categories)
```permutest``` calculates ANOVAS on average distances from betadisper() to test if one or more groups is more variable than others
<!-- ### CAP, first with the non-normalised metadata. -->
```{r cap on sig metadata, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#CAP
CAP_ps_cap_r <- ordinate(ps_cap_r,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                           formula = ~ Site.name + Month + Temp.C + DO..sat + Cl..µg.ml + SO4..µg.ml+ X55.Mn.ng.ml + X89.Y.ng.ml + X139.La.ng.ml)

CAP_sig_plot_a12 <- plot_ordination(ps_cap_r,
                                    ordination = CAP_ps_cap_r, color = "Site.name", axes = c(1,2)) +
  aes(shape = Month) +
  geom_point(aes(colour = Site.name), alpha = 0.4, size = 4) +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(aes(colour = Site.name), size = 1.5)+
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13)) +
  theme(legend.position = "none")

arrowmat_CAP <- vegan::scores(CAP_ps_cap_r, display = "bp")
arrowmat_CAP<-arrowmat_CAP[!grepl("Site.name", rownames(arrowmat_CAP)),]
arrowmat_CAP<-arrowmat_CAP[!grepl("Month", rownames(arrowmat_CAP)),]
arrowdf_CAP <- data.frame(labels = rownames(arrowmat_CAP), arrowmat_CAP)
arrow_map_CAP <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP <- aes(x = 1.3 * CAP1, y = 1.3 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP = arrow(length = unit(0.02, "npc"))

CAP_sig_plot_a12 = CAP_sig_plot_a12 +
  geom_segment(mapping = arrow_map_CAP, size = .5, 
               data = arrowdf_CAP, color = "gray", arrow = arrowhead_CAP) +
  geom_text(mapping = label_map_CAP, size = 4, 
            data = arrowdf_CAP, show.legend = FALSE)

arrowmat_CAP_13 <- vegan::scores(CAP_ps_cap_r, display = "bp", choices=c(1,3))
arrowmat_CAP_13<-arrowmat_CAP_13[!grepl("Site.name", rownames(arrowmat_CAP_13)),]
arrowmat_CAP_13<-arrowmat_CAP_13[!grepl("Month", rownames(arrowmat_CAP_13)),]
arrowdf_CAP_13 <- data.frame(labels = rownames(arrowmat_CAP_13), arrowmat_CAP_13)
arrow_map_CAP_13 <- aes(xend = CAP1, yend = CAP3,
                        x = 0, y = 0,
                        shape = NULL, color = NULL,
                        label = labels)
label_map_CAP_13 <- aes(x = 1.3 * CAP1, y = 1.3 * CAP3,
                        shape = NULL, color = NULL,
                        label = labels)
arrowhead_CAP_13 = arrow(length = unit(0.02, "npc"))

CAP_sig_plot_a13 <- plot_ordination(ps_cap_r,
                                    ordination = CAP_ps_cap_r, color = "Site.name",axes = c(1,3)) +
  aes(shape = Month) +
  geom_point(aes(colour = Site.name), alpha = 0.4, size = 4) +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(aes(colour = Site.name), size = 1.5) +
  geom_segment(mapping = arrow_map_CAP_13, size = .5,
               data = arrowdf_CAP_13, color = "gray", arrow = arrowhead_CAP_13) +
  geom_text(mapping = label_map_CAP_13, size = 4,
            data = arrowdf_CAP_13, show.legend = FALSE)+
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13))

ps.b.r.CAP_sig.plot<-plot_grid(CAP_sig_plot_a12, CAP_sig_plot_a13,
                               labels=c("A","B"))
```
```{r eval=FALSE, fig.height=8, fig.width=14, include=FALSE}
ps.b.r.CAP_sig.plot
```

<!-- So, as previously seen, two major groups composed of high-S and high-Fe samples. It seems DO and SO4 drive community structure in opposite ways. Also, temperature seems to play a role in defining high-S sample groups. -->
<!-- Is this ordination's goodness of fit better than random models? i.e. are the constraints in this model significant? -->

```{r eval=FALSE, include=FALSE}
anova(CAP_ps_cap_r, perm=1e3)
```

<!-- Do these significant metadata variables have the same dispersions? -->
<!-- * Homogeneity of dispersion test for significant categories: -->
<!-- ***Null hypothesis**: tested metadata categories have the same dispersions (variance). -->
<!-- ```betadisper``` calculates average distances of samples to group centroids (from metadata categories) -->
<!-- ```permutest``` calculates ANOVAS on average distances from betadisper() to test if one or more groups is more variable than others -->
```{r betadisper, echo=TRUE}
#Temperature
beta_t <- betadisper(ps_cap_r_jsd, sampledf_cap_norm_noNA_f_ord$Temp.C)
permutest(beta_t)
#EC
beta_ec <- betadisper(ps_cap_r_jsd, sampledf_cap_norm_noNA_f_ord$EC.uS.cm)
permutest(beta_ec)
```

This means group centroids for temperature and EC are not significantly shared, thus meaning that the ```adonis``` test was meaningful.

<!-- We can only reject the null hypothesis that site names have the same dispersions (variance). However, this might mean that adonis results can't be trusted for this category. -->

<!-- Ok then, but what microbial groups are influenced by these variables? More ordination on the way. -->

```{r taxa cap on sig metadata, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ps_cap_r_april = subset_samples(ps_cap_r, Month == "April")
ps_cap_r_april_f = filter_taxa(ps_cap_r_april, function(x) sum(x) > .01, TRUE)
ps_cap_r_august = subset_samples(ps_cap_r, Month == "August")
ps_cap_r_august_f = filter_taxa(ps_cap_r_august, function(x) sum(x) > .01, TRUE)
ps_cap_r_december = subset_samples(ps_cap_r, Month == "December")
ps_cap_r_december_f = filter_taxa(ps_cap_r_december, function(x) sum(x) > .01, TRUE)
#april
CAP_ps_cap_r_april_f <- ordinate(ps_cap_r_april_f,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                        formula = ~ Site.name + Month + Temp.C + DO..sat + Cl..µg.ml + SO4..µg.ml+ X55.Mn.ng.ml + X89.Y.ng.ml + X139.La.ng.ml)

arrowmat_CAP_taxa_april <- vegan::scores(CAP_ps_cap_r_april_f, display = "bp")
arrowmat_CAP_taxa_april<-arrowmat_CAP_taxa_april[!grepl("Site.name", rownames(arrowmat_CAP_taxa_april)),]
arrowmat_CAP_taxa_april<-arrowmat_CAP_taxa_april[!grepl("Month", rownames(arrowmat_CAP_taxa_april)),]
arrowdf_CAP_taxa_april <- data.frame(labels = rownames(arrowmat_CAP_taxa_april), arrowmat_CAP_taxa_april)
arrow_map_CAP_taxa_april <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP_taxa_april <- aes(x = 1.3 * CAP1, y = 1.3 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP_taxa_april = arrow(length = unit(0.02, "npc"))

april_phyla=nrow(as.data.frame(table(tax_table(ps_cap_r_april_f)[, "Phylum"], exclude = NULL)))

CAP_april_taxa_sig_plot_a12 <- plot_ordination(ps_cap_r_april_f,
                                    ordination = CAP_ps_cap_r_april_f, 
                                    color = "Phylum",
                                    axes = c(1,2), type="taxa") 
ov_CAP_april_taxa_sig_plot_a12<-subset(CAP_april_taxa_sig_plot_a12$data,
                           Phylum %in% c("Proteobacteria","Omnitrophica","Parcubacteria"))
ov_CAP_april_taxa_sig_plot_a12$Phylum=as.character(ov_CAP_april_taxa_sig_plot_a12$Phylum)

final_CAP_april_taxa_sig_plot_a12 = CAP_april_taxa_sig_plot_a12 +
  geom_point(data = ov_CAP_april_taxa_sig_plot_a12,
             aes(x=CAP1, y=CAP2, shape = Phylum, alpha = 0.6, size = 6)) +
  geom_segment(mapping = arrow_map_CAP_taxa_april, size = .5, 
               data = arrowdf_CAP_taxa_april, color = "black", arrow = arrowhead_CAP_taxa_april) +
  geom_text(mapping = label_map_CAP_taxa_april, size = 5, fontface="bold",
            data = arrowdf_CAP_taxa_april, show.legend = FALSE) +
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(april_phyla),
                     na.value = "black") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(april_phyla),
                    na.value = "black")  +
  guides(fill = guide_legend(nrow = april_phyla/2),
         color = guide_legend(nrow= april_phyla/2),
         size = FALSE,
         shape =FALSE,
         alpha = FALSE) +
  labs(subtitle = "Using all SVs above 1% relative abundance")

#august
CAP_ps_cap_r_august_f <- ordinate(ps_cap_r_august_f,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                        formula = ~ Site.name + Month + Temp.C + DO..sat + Cl..µg.ml + SO4..µg.ml+ X55.Mn.ng.ml + X89.Y.ng.ml + X139.La.ng.ml)

arrowmat_CAP_taxa_august <- vegan::scores(CAP_ps_cap_r_august_f, display = "bp")
arrowmat_CAP_taxa_august<-arrowmat_CAP_taxa_august[!grepl("Site.name", rownames(arrowmat_CAP_taxa_august)),]
arrowmat_CAP_taxa_august<-arrowmat_CAP_taxa_august[!grepl("Month", rownames(arrowmat_CAP_taxa_august)),]
arrowdf_CAP_taxa_august <- data.frame(labels = rownames(arrowmat_CAP_taxa_august), arrowmat_CAP_taxa_august)
arrow_map_CAP_taxa_august <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP_taxa_august <- aes(x = 1.3 * CAP1, y = 1.3 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP_taxa_august = arrow(length = unit(0.02, "npc"))

august_phyla=nrow(as.data.frame(table(tax_table(ps_cap_r_august_f)[, "Phylum"], exclude = NULL)))

CAP_august_taxa_sig_plot_a12 <- plot_ordination(ps_cap_r_august_f,
                                    ordination = CAP_ps_cap_r_august_f, 
                                    color = "Phylum",
                                    axes = c(1,2), type="taxa")

ov_CAP_august_taxa_sig_plot_a12<-subset(CAP_august_taxa_sig_plot_a12$data,
                           Phylum %in% c("Proteobacteria","Omnitrophica","Parcubacteria"))
ov_CAP_august_taxa_sig_plot_a12$Phylum=as.character(ov_CAP_august_taxa_sig_plot_a12$Phylum)

final_CAP_august_taxa_sig_plot_a12 = CAP_august_taxa_sig_plot_a12 +
  geom_point(data = ov_CAP_august_taxa_sig_plot_a12,
             aes(x=CAP1, y=CAP2, shape = Phylum, alpha = 0.6, size = 6)) +
  geom_segment(mapping = arrow_map_CAP_taxa_august, size = .5, 
               data = arrowdf_CAP_taxa_august, color = "black", arrow = arrowhead_CAP_taxa_august) +
  geom_text(mapping = label_map_CAP_taxa_august, size = 5, fontface="bold",
            data = arrowdf_CAP_taxa_august, show.legend = FALSE) +
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(august_phyla),
                     na.value = "black") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(august_phyla),
                    na.value = "black")  +
  guides(fill = guide_legend(nrow = august_phyla/2),
         color = guide_legend(nrow=august_phyla/2),
         shape = guide_legend(title="Shape"),
         size = FALSE,
         alpha = FALSE)

#december
CAP_ps_cap_r_december_f <- ordinate(ps_cap_r_december_f,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                        formula = ~ Site.name + Month + Temp.C + DO..sat + Cl..µg.ml + SO4..µg.ml+ X55.Mn.ng.ml + X89.Y.ng.ml + X139.La.ng.ml)

arrowmat_CAP_taxa_december <- vegan::scores(CAP_ps_cap_r_december_f, display = "bp")
arrowmat_CAP_taxa_december<-arrowmat_CAP_taxa_december[!grepl("Site.name", rownames(arrowmat_CAP_taxa_december)),]
arrowmat_CAP_taxa_december<-arrowmat_CAP_taxa_december[!grepl("Month", rownames(arrowmat_CAP_taxa_december)),]
arrowdf_CAP_taxa_december <- data.frame(labels = rownames(arrowmat_CAP_taxa_december), arrowmat_CAP_taxa_december)
arrow_map_CAP_taxa_december <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP_taxa_december <- aes(x = 1.3 * CAP1, y = 1.3 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP_taxa_december = arrow(length = unit(0.02, "npc"))

december_phyla=nrow(as.data.frame(table(tax_table(ps_cap_r_december_f)[, "Phylum"], exclude = NULL)))

CAP_december_taxa_sig_plot_a12 <- plot_ordination(ps_cap_r_december_f,
                                    ordination = CAP_ps_cap_r_december_f, 
                                    color = "Phylum",
                                    axes = c(1,2), type="taxa")
ov_CAP_december_taxa_sig_plot_a12<-subset(CAP_december_taxa_sig_plot_a12$data,
                           Phylum %in% c("Proteobacteria","Omnitrophica","Parcubacteria"))
ov_CAP_december_taxa_sig_plot_a12$Phylum=as.character(ov_CAP_december_taxa_sig_plot_a12$Phylum)

final_CAP_december_taxa_sig_plot_a12 = CAP_december_taxa_sig_plot_a12 +
  geom_point(data = ov_CAP_december_taxa_sig_plot_a12,
             aes(x=CAP1, y=CAP2, shape = Phylum, alpha = 0.6, size = 6)) +
  geom_segment(mapping = arrow_map_CAP_taxa_december, size = .5, 
               data = arrowdf_CAP_taxa_december, color = "black", arrow = arrowhead_CAP_taxa_december) +
  geom_text(mapping = label_map_CAP_taxa_december, size = 5, fontface="bold",
            data = arrowdf_CAP_taxa_december, show.legend = FALSE) +
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(december_phyla),
                     na.value = "black") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(december_phyla),
                    na.value = "black")  +
  guides(fill = guide_legend(nrow = december_phyla/2),
         color = guide_legend(nrow= december_phyla/2),
         size = FALSE,
         shape =FALSE,
         alpha = FALSE)

ps_cap_r_month<-plot_grid(final_CAP_april_taxa_sig_plot_a12, final_CAP_august_taxa_sig_plot_a12, final_CAP_december_taxa_sig_plot_a12,
                               labels=c("April","August","December"), align = 'v', ncol = 1,
                               hjust = -1, vjust = -1, axis = 'l')

```
```{r eval=FALSE, fig.height=17, fig.width=14, include=FALSE}
ps_cap_r_month
```

### CAP with normalised metadata.

Using all significant variables for the formula, plotting only the ones explaining 5% or more variation.

```{r cap on sig norm metadata, message=FALSE, warning=FALSE}
#remove rows 73,74,75 (Taff's Well pumped samples) from norm_metadata and create new phyloseq object with normalised metadata
remove = c("73","74","75")
sampledf_cap_norm_noNA_f_ord_final <- sampledf_cap_norm_noNA_f_ord[!rownames(sampledf_cap_norm_noNA_f_ord) %in% remove, ]

sampledf_cap_norm_noNA_f_ord_final$Month_cat <- sampledf_cap$Month
sampledf_cap_norm_noNA_f_ord_final$Site.name <- sampledf_cap$Site.name

ps_cap_r_norm <- phyloseq(otu_table(ps_cap_r),
                       tax_table(ps_cap_r),
                       sample_data(sampledf_cap_norm_noNA_f_ord_final))

#CAP with significant normalised variables
CAP_ps_cap_r_norm <- ordinate(ps_cap_r_norm,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                           formula = ~ Site.ID + Temp.C + EC.uS.cm + DO..sat + K.µg.ml + Na.µg.ml + Cl..µg.ml + SO4..µg.ml + X6.Li.ng.ml + X7.Li.ng.ml + X7.Li..He..ng.ml + X11.B.ng.ml + X45.Sc.ng.ml + X55.Mn.ng.ml + X59.Co.ng.ml + X60.Ni.ng.ml + X69.Ga.ng.ml + X75.As..He..ng.ml + X88.Sr.ng.ml + X89.Y.ng.ml + X133.Cs.ng.ml + X139.La.ng.ml + X238.U.ng.ml)

CAP_norm_sig_plot_a12 <- plot_ordination(ps_cap_r_norm,
                                    ordination = CAP_ps_cap_r_norm, color = "Site.name", axes = c(1,2)) +
  aes(shape = Month_cat) +
  geom_point(aes(colour = Site.name), alpha = 0.7, size = 4) +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(aes(colour = Site.name), size = 1.5)+
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13)) +
  theme(legend.position = "none")

arrowmat_CAP_norm <- vegan::scores(CAP_ps_cap_r_norm, display = "bp")
arrowmat_CAP_norm<-subset(arrowmat_CAP_norm,
                           rownames(arrowmat_CAP_norm) %in% c("Temp.C","EC.uS.cm","Site.ID","K.µg.ml","Na.µg.ml"))
arrowdf_CAP_norm <- data.frame(labels = rownames(arrowmat_CAP_norm), arrowmat_CAP_norm)
rownames(arrowdf_CAP_norm) <- c("Site ID","Temperature","EC","K","Na")
arrowdf_CAP_norm$labels <- c("Site ID","Temperature","EC","K","Na")

arrow_map_CAP_norm <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP_norm <- aes(x = 1.1 * CAP1, y = 1.3 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP_norm = arrow(length = unit(0.02, "npc"))

CAP_norm_sig_plot_a12 = CAP_norm_sig_plot_a12 +
  geom_segment(mapping = arrow_map_CAP_norm, size = .5, 
               data = arrowdf_CAP_norm, color = "gray", arrow = arrowhead_CAP_norm) +
  geom_text(mapping = label_map_CAP_norm, size = 4, 
            data = arrowdf_CAP_norm, show.legend = FALSE)

arrowmat_CAP_norm_13 <- vegan::scores(CAP_ps_cap_r_norm, display = "bp", choices=c(1,3))
arrowmat_CAP_norm_13<-subset(arrowmat_CAP_norm_13,
                           rownames(arrowmat_CAP_norm_13) %in% c("Temp.C","EC.uS.cm","Site.ID","K.µg.ml","Na.µg.ml"))
arrowdf_CAP_norm_13 <- data.frame(labels = rownames(arrowmat_CAP_norm_13), arrowmat_CAP_norm_13)
rownames(arrowdf_CAP_norm_13) <- c("Site ID","Temperature","EC","K","Na")
arrowdf_CAP_norm_13$labels <- c("Site ID","Temperature","EC","K","Na")

arrow_map_CAP_norm_13 <- aes(xend = CAP1, yend = CAP3,
                        x = 0, y = 0,
                        shape = NULL, color = NULL,
                        label = labels)
label_map_CAP_norm_13 <- aes(x = 1.1 * CAP1, y = 1.3 * CAP3,
                        shape = NULL, color = NULL,
                        label = labels)
arrowhead_CAP_norm_13 = arrow(length = unit(0.02, "npc"))

CAP_norm_sig_plot_a13 <- plot_ordination(ps_cap_r_norm,
                                    ordination = CAP_ps_cap_r_norm, color = "Site.name",axes = c(1,3)) +
  aes(shape = Month_cat) +
  geom_point(aes(colour = Site.name), alpha = 0.7, size = 4) +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(aes(colour = Site.name), size = 1.5) +
  geom_segment(mapping = arrow_map_CAP_norm_13, size = .5,
               data = arrowdf_CAP_norm_13, color = "gray", arrow = arrowhead_CAP_norm_13) +
  geom_text(mapping = label_map_CAP_norm_13, size = 4,
            data = arrowdf_CAP_norm_13, show.legend = FALSE)+
  scale_color_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13)) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(13))

ps.b.r.CAP_norm_sig.plot<-plot_grid(CAP_norm_sig_plot_a12, CAP_norm_sig_plot_a13,
                               labels=c("A","B"))
```
```{r, fig.height=8, fig.width=14}
ps.b.r.CAP_norm_sig.plot
```

So, as previously seen, two major groups composed of high-S and high-Fe samples. Temperature seems to play a role in defining high-S sample groups, but this changes throughout the year.

Is this ordination's goodness of fit better than random models? *i.e.* are the constraints in this model significant?

```{r}
anova(CAP_ps_cap_r_norm, perm=1e3)
```

As before, but now what microbial groups are influenced by these variables? More ordination on the way.

```{r taxa cap on sig norm metadata, message=FALSE, warning=FALSE}
ps_cap_r_norm_april = subset_samples(ps_cap_r_norm, Month_cat == "April")
ps_cap_r_norm_april_f = filter_taxa(ps_cap_r_norm_april, function(x) sum(x) > .01, TRUE)
ps_cap_r_norm_august = subset_samples(ps_cap_r_norm, Month_cat == "August")
ps_cap_r_norm_august_f = filter_taxa(ps_cap_r_norm_august, function(x) sum(x) > .01, TRUE)
ps_cap_r_norm_december = subset_samples(ps_cap_r_norm, Month_cat == "December")
ps_cap_r_norm_december_f = filter_taxa(ps_cap_r_norm_december, function(x) sum(x) > .01, TRUE)

CAP_norm_ps_cap_r_norm_april_f <- ordinate(ps_cap_r_norm_april_f,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                           formula = ~ Site.ID + Temp.C + EC.uS.cm + DO..sat + K.µg.ml + Na.µg.ml + Cl..µg.ml + SO4..µg.ml + X6.Li.ng.ml + X7.Li.ng.ml + X7.Li..He..ng.ml + X11.B.ng.ml + X45.Sc.ng.ml + X55.Mn.ng.ml + X59.Co.ng.ml + X60.Ni.ng.ml + X69.Ga.ng.ml + X75.As..He..ng.ml + X88.Sr.ng.ml + X89.Y.ng.ml + X133.Cs.ng.ml + X139.La.ng.ml + X238.U.ng.ml)

CAP_norm_ps_cap_r_norm_august_f <- ordinate(ps_cap_r_norm_august_f,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                           formula = ~ Site.ID + Temp.C + EC.uS.cm + DO..sat + K.µg.ml + Na.µg.ml + Cl..µg.ml + SO4..µg.ml + X6.Li.ng.ml + X7.Li.ng.ml + X7.Li..He..ng.ml + X11.B.ng.ml + X45.Sc.ng.ml + X55.Mn.ng.ml + X59.Co.ng.ml + X60.Ni.ng.ml + X69.Ga.ng.ml + X75.As..He..ng.ml + X88.Sr.ng.ml + X89.Y.ng.ml + X133.Cs.ng.ml + X139.La.ng.ml + X238.U.ng.ml)

CAP_norm_ps_cap_r_norm_december_f <- ordinate(ps_cap_r_norm_december_f,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                           formula = ~ Site.ID + Temp.C + EC.uS.cm + DO..sat + K.µg.ml + Na.µg.ml + Cl..µg.ml + SO4..µg.ml + X6.Li.ng.ml + X7.Li.ng.ml + X7.Li..He..ng.ml + X11.B.ng.ml + X45.Sc.ng.ml + X55.Mn.ng.ml + X59.Co.ng.ml + X60.Ni.ng.ml + X69.Ga.ng.ml + X75.As..He..ng.ml + X88.Sr.ng.ml + X89.Y.ng.ml + X133.Cs.ng.ml + X139.La.ng.ml + X238.U.ng.ml)

#april
arrowmat_CAP_norm_taxa_april <- vegan::scores(CAP_norm_ps_cap_r_norm_april_f, display = "bp")
arrowmat_CAP_norm_taxa_april<-subset(arrowmat_CAP_norm_taxa_april,
                           rownames(arrowmat_CAP_norm_taxa_april) %in% c("Temp.C","EC.uS.cm","Site.ID","K.µg.ml","Na.µg.ml"))
arrowdf_CAP_norm_taxa_april <- data.frame(labels = rownames(arrowmat_CAP_norm_taxa_april), arrowmat_CAP_norm_taxa_april)
rownames(arrowmat_CAP_norm_taxa_april) <- c("Site ID","Temperature","EC","K","Na")
rownames(arrowdf_CAP_norm_taxa_april) <- c("Site ID","Temperature","EC","K","Na")
arrowdf_CAP_norm_taxa_april$labels <- c("Site ID","Temperature","EC","K","Na")
arrow_map_CAP_norm_taxa_april <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP_norm_taxa_april <- aes(x = 1.1 * CAP1, y = 1.1 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP_norm_taxa_april = arrow(length = unit(0.02, "npc"))

april_phyla=nrow(as.data.frame(table(tax_table(ps_cap_r_norm_april_f)[, "Phylum"], exclude = NULL)))

CAP_labels_april <- plot_ordination(ps_cap_r_norm_april_f,
                                    ordination = CAP_norm_ps_cap_r_norm_april_f, 
                                    axes = c(1,2), type="taxa")
CAP_april_xlabel <- CAP_labels_april$labels$x
CAP_april_ylabel <- CAP_labels_april$labels$y

CAP_norm_april_taxa_sig_plot_a12 <- plot_ordination(ps_cap_r_norm_april_f,
                                    ordination = CAP_norm_ps_cap_r_norm_april_f, 
                                    axes = c(1,2), type="taxa", justDF = TRUE) 
CAP_norm_april_taxa_sig_plot_a12$Phylum=as.character(CAP_norm_april_taxa_sig_plot_a12$Phylum)
CAP_norm_april_taxa_sig_plot_a12$Class=as.character(CAP_norm_april_taxa_sig_plot_a12$Class)
ov_CAP_norm_april_taxa_sig_plot_a12<-subset(CAP_norm_april_taxa_sig_plot_a12,
                           Phylum != "Proteobacteria")
ov_CAP_norm_april_taxa_sig_plot_a12$Phylum=as.character(ov_CAP_norm_april_taxa_sig_plot_a12$Phylum)
class_ov_CAP_norm_april_taxa_sig_plot_a12<-subset(CAP_norm_april_taxa_sig_plot_a12,
                           Class %in% c("Epsilonproteobacteria","Betaproteobacteria","Gammaproteobacteria","Deltaproteobacteria"))
class_ov_CAP_norm_april_taxa_sig_plot_a12$Class=as.character(class_ov_CAP_norm_april_taxa_sig_plot_a12$Class)

april_class <- length(unique(class_ov_CAP_norm_april_taxa_sig_plot_a12$Class))

final_CAP_norm_april_taxa_sig_plot_a12 = ggplot(data=CAP_norm_april_taxa_sig_plot_a12,
                                                aes(x=CAP1,y=CAP2)) +
  geom_point(data=ov_CAP_norm_april_taxa_sig_plot_a12,
             aes(x=CAP1, y=CAP2,
                 color = Phylum, size = 4)) +
  geom_point(data = class_ov_CAP_norm_april_taxa_sig_plot_a12,
             aes(x=CAP1, y=CAP2,
                 color = Phylum,
                 shape = Class,
                 alpha = 1, size = 4)) +
  geom_segment(mapping = arrow_map_CAP_norm_taxa_april, size = .5, 
               data = arrowdf_CAP_norm_taxa_april, 
               color = "black", arrow = arrowhead_CAP_norm_taxa_april) +
  geom_text(mapping = label_map_CAP_norm_taxa_april, 
            data = subset(arrowdf_CAP_norm_taxa_april,
                          labels %in% c("Site ID", "Temperature","K","Na")),
            size = 5, fontface="bold",
            hjust = 0,
            show.legend = FALSE) +
  geom_text(mapping = label_map_CAP_norm_taxa_april, 
            data = subset(arrowdf_CAP_norm_taxa_april,
                          labels %in% c("EC")),
            size = 5, fontface="bold",
            show.legend = FALSE,
            nudge_y = 0.05) +
  scale_color_manual(values=distinctColorPalette(length(unique(CAP_norm_april_taxa_sig_plot_a12$Phylum))),
                     na.value = "black") +
  scale_fill_manual(values=distinctColorPalette(length(unique(CAP_norm_april_taxa_sig_plot_a12$Phylum))),
                    na.value = "black")  +
  scale_shape_manual(values=c(15, 17, 18, 4)) +
  guides(fill = FALSE,
         size = FALSE,
         alpha = FALSE,
         color = guide_legend(nrow = april_phyla/2),
         shape = guide_legend(nrow = april_phyla/2)) +
  labs(subtitle = "Using all SVs above 1% relative abundance",
       title= "April",
       x = CAP_april_xlabel,
       y = CAP_april_ylabel) + 
  theme(plot.title = element_text(hjust = 0.5),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13, face = "bold"),
        legend.position = "right",
        legend.direction = "vertical",
        legend.box.margin = margin(100, 6, 6, 6))

#august
arrowmat_CAP_norm_taxa_august <- vegan::scores(CAP_norm_ps_cap_r_norm_august_f, display = "bp")
arrowmat_CAP_norm_taxa_august<-subset(arrowmat_CAP_norm_taxa_august,
                           rownames(arrowmat_CAP_norm_taxa_august) %in% c("Temp.C","EC.uS.cm","Site.ID","K.µg.ml","Na.µg.ml"))
arrowdf_CAP_norm_taxa_august <- data.frame(labels = rownames(arrowmat_CAP_norm_taxa_august), arrowmat_CAP_norm_taxa_august)
rownames(arrowmat_CAP_norm_taxa_august) <- c("Site ID","Temperature","EC","K","Na")
rownames(arrowdf_CAP_norm_taxa_august) <- c("Site ID","Temperature","EC","K","Na")
arrowdf_CAP_norm_taxa_august$labels <- c("Site ID","Temperature","EC","K","Na")
arrow_map_CAP_norm_taxa_august <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP_norm_taxa_august <- aes(x = 1.1 * CAP1, y = 1.1 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP_norm_taxa_august = arrow(length = unit(0.02, "npc"))

august_phyla=nrow(as.data.frame(table(tax_table(ps_cap_r_norm_august_f)[, "Phylum"], exclude = NULL)))

CAP_labels_august <- plot_ordination(ps_cap_r_norm_august_f,
                                    ordination = CAP_norm_ps_cap_r_norm_august_f, 
                                    axes = c(1,2), type="taxa")
CAP_august_xlabel <- CAP_labels_august$labels$x
CAP_august_ylabel <- CAP_labels_august$labels$y

CAP_norm_august_taxa_sig_plot_a12 <- plot_ordination(ps_cap_r_norm_august_f,
                                    ordination = CAP_norm_ps_cap_r_norm_august_f, 
                                    axes = c(1,2), type="taxa", justDF = TRUE) 
CAP_norm_august_taxa_sig_plot_a12$Phylum=as.character(CAP_norm_august_taxa_sig_plot_a12$Phylum)
CAP_norm_august_taxa_sig_plot_a12$Class=as.character(CAP_norm_august_taxa_sig_plot_a12$Class)
ov_CAP_norm_august_taxa_sig_plot_a12<-subset(CAP_norm_august_taxa_sig_plot_a12,
                           Phylum != "Proteobacteria")
ov_CAP_norm_august_taxa_sig_plot_a12$Phylum=as.character(ov_CAP_norm_august_taxa_sig_plot_a12$Phylum)
class_ov_CAP_norm_august_taxa_sig_plot_a12<-subset(CAP_norm_august_taxa_sig_plot_a12,
                           Class %in% c("Epsilonproteobacteria","Betaproteobacteria","Gammaproteobacteria","Deltaproteobacteria"))
class_ov_CAP_norm_august_taxa_sig_plot_a12$Class=as.character(class_ov_CAP_norm_august_taxa_sig_plot_a12$Class)

august_class <- length(unique(class_ov_CAP_norm_august_taxa_sig_plot_a12$Class))

final_CAP_norm_august_taxa_sig_plot_a12 = ggplot(data=CAP_norm_august_taxa_sig_plot_a12,
                                                aes(x=CAP1,y=CAP2)) +
  geom_point(data=ov_CAP_norm_august_taxa_sig_plot_a12,
             aes(x=CAP1, y=CAP2,
                 color = Phylum, size = 4)) +
  geom_point(data = class_ov_CAP_norm_august_taxa_sig_plot_a12,
             aes(x=CAP1, y=CAP2,
                 color = Phylum,
                 shape = Class,
                 alpha = 1, size = 4)) +
  geom_segment(mapping = arrow_map_CAP_norm_taxa_august, size = .5, 
               data = arrowdf_CAP_norm_taxa_august, 
               color = "black", arrow = arrowhead_CAP_norm_taxa_august) +
  geom_text(mapping = label_map_CAP_norm_taxa_august, 
            data = subset(arrowdf_CAP_norm_taxa_august,
                          labels %in% c("Site ID", "Temperature","EC","Na")),
            size = 5, fontface="bold",
            hjust = 0,
            show.legend = FALSE) +
  geom_text(mapping = label_map_CAP_norm_taxa_august, 
            data = subset(arrowdf_CAP_norm_taxa_august,
                          labels %in% c("K")),
            size = 5, fontface="bold",
            show.legend = FALSE,
            nudge_y = 0.05) +
  scale_color_manual(values=distinctColorPalette(length(unique(CAP_norm_august_taxa_sig_plot_a12$Phylum))),
                     na.value = "black") +
  scale_fill_manual(values=distinctColorPalette(length(unique(CAP_norm_august_taxa_sig_plot_a12$Phylum))),
                    na.value = "black")  +
  scale_shape_manual(values=c(15, 17, 18, 4)) +
  guides(fill = FALSE,
         color = guide_legend(nrow= august_phyla/2),
         size = FALSE,
         alpha = FALSE,
         shape = guide_legend(nrow = august_phyla/2)) +
  labs(title= "August",
       x = CAP_august_xlabel,
       y = CAP_august_ylabel) + 
  theme(plot.title = element_text(hjust = 0.5),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13, face = "bold"),
        legend.position = "right",
        legend.direction = "vertical",
        legend.box.margin = margin(100, 6, 6, 6))

#december
arrowmat_CAP_norm_taxa_december <- vegan::scores(CAP_norm_ps_cap_r_norm_december_f, display = "bp")
arrowmat_CAP_norm_taxa_december<-subset(arrowmat_CAP_norm_taxa_december,
                           rownames(arrowmat_CAP_norm_taxa_december) %in% c("Temp.C","EC.uS.cm","Site.ID","K.µg.ml","Na.µg.ml"))
arrowdf_CAP_norm_taxa_december <- data.frame(labels = rownames(arrowmat_CAP_norm_taxa_december), arrowmat_CAP_norm_taxa_december)
rownames(arrowmat_CAP_norm_taxa_december) <- c("Site ID","Temperature","EC","K","Na")
rownames(arrowdf_CAP_norm_taxa_december) <- c("Site ID","Temperature","EC","K","Na")
arrowdf_CAP_norm_taxa_december$labels <- c("Site ID","Temperature","EC","K","Na")
arrow_map_CAP_norm_taxa_december <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP_norm_taxa_december <- aes(x = 1.1 * CAP1, y = 1.1 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP_norm_taxa_december = arrow(length = unit(0.02, "npc"))

december_phyla=nrow(as.data.frame(table(tax_table(ps_cap_r_norm_december_f)[, "Phylum"], exclude = NULL)))

CAP_labels_december <- plot_ordination(ps_cap_r_norm_december_f,
                                    ordination = CAP_norm_ps_cap_r_norm_december_f, 
                                    axes = c(1,2), type="taxa")
CAP_december_xlabel <- CAP_labels_december$labels$x
CAP_december_ylabel <- CAP_labels_december$labels$y

CAP_norm_december_taxa_sig_plot_a12 <- plot_ordination(ps_cap_r_norm_december_f,
                                    ordination = CAP_norm_ps_cap_r_norm_december_f, 
                                    axes = c(1,2), type="taxa", justDF = TRUE) 
CAP_norm_december_taxa_sig_plot_a12$Phylum=as.character(CAP_norm_december_taxa_sig_plot_a12$Phylum)
CAP_norm_december_taxa_sig_plot_a12$Class=as.character(CAP_norm_december_taxa_sig_plot_a12$Class)
ov_CAP_norm_december_taxa_sig_plot_a12<-subset(CAP_norm_december_taxa_sig_plot_a12,
                           Phylum != "Proteobacteria")
ov_CAP_norm_december_taxa_sig_plot_a12$Phylum=as.character(ov_CAP_norm_december_taxa_sig_plot_a12$Phylum)
class_ov_CAP_norm_december_taxa_sig_plot_a12<-subset(CAP_norm_december_taxa_sig_plot_a12,
                           Class %in% c("Epsilonproteobacteria","Betaproteobacteria","Gammaproteobacteria","Deltaproteobacteria"))
class_ov_CAP_norm_december_taxa_sig_plot_a12$Class=as.character(class_ov_CAP_norm_december_taxa_sig_plot_a12$Class)

december_class <- length(unique(class_ov_CAP_norm_december_taxa_sig_plot_a12$Class))

final_CAP_norm_december_taxa_sig_plot_a12 = ggplot(data=CAP_norm_december_taxa_sig_plot_a12,
                                                aes(x=CAP1,y=CAP2)) +
  geom_point(data=ov_CAP_norm_december_taxa_sig_plot_a12,
             aes(x=CAP1, y=CAP2,
                 color = Phylum, size = 4)) +
  geom_point(data = class_ov_CAP_norm_december_taxa_sig_plot_a12,
             aes(x=CAP1, y=CAP2,
                 color = Phylum,
                 shape = Class,
                 alpha = 1, size = 4)) +
  geom_segment(mapping = arrow_map_CAP_norm_taxa_december, size = .5, 
               data = arrowdf_CAP_norm_taxa_december, 
               color = "black", arrow = arrowhead_CAP_norm_taxa_december) +
  geom_text(mapping = label_map_CAP_norm_taxa_december,
            data = arrowdf_CAP_norm_taxa_december,
            size = 5, fontface="bold",
            show.legend = FALSE) +
  scale_color_manual(values=distinctColorPalette(length(unique(CAP_norm_december_taxa_sig_plot_a12$Phylum))),
                     na.value = "black") +
  scale_fill_manual(values=distinctColorPalette(length(unique(CAP_norm_december_taxa_sig_plot_a12$Phylum))),
                    na.value = "black")  +
  scale_shape_manual(values=c(15, 17, 18, 4)) +
  guides(fill = FALSE,
         color = guide_legend(nrow = december_phyla/2),
         size = FALSE,
         alpha = FALSE,
         shape = guide_legend(nrow = december_phyla/2)) +
  labs(title= "December",
       x = CAP_december_xlabel,
       y = CAP_december_ylabel) + 
  theme(plot.title = element_text(hjust = 0.5),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13, face = "bold"),
        legend.position = "right",
        legend.direction = "vertical",
        legend.box.margin = margin(100, 6, 6, 6))

ps_cap_r_norm_Month_cat<-plot_grid(final_CAP_norm_april_taxa_sig_plot_a12, 
                                   final_CAP_norm_august_taxa_sig_plot_a12, 
                                   final_CAP_norm_december_taxa_sig_plot_a12,
                                   align = 'v', ncol = 1)
```
```{r echo=FALSE, fig.height=14, fig.width=14}
ps_cap_r_norm_Month_cat
```


```{r echo=FALSE, fig.height=7, fig.width=14}
ps.b.r.CAP_norm_sig.plot
```
It seems K, EC, Na and temperature influenced a subset of the microbial community mostly composed of Gamma- and Epsilonproteobacteria as well as Omnitrophica plus others across the year. Omintrophica and Parcubacteria seem to appear in different numbers across the year within this cluster.

So who defines this cluster? Let's select the corresponding points of the CAP and figure out.

```{r}
CAP_norm_cluster_april = subset(final_CAP_norm_april_taxa_sig_plot_a12$data,
                          CAP1 >= 0.75)
CAP_norm_cluster_august = subset(final_CAP_norm_august_taxa_sig_plot_a12$data,
                          CAP1 >= 0.75)
CAP_norm_cluster_december = subset(final_CAP_norm_december_taxa_sig_plot_a12$data,
                          CAP1 >= 0.75)

CAP_norm_cluster_april_names <- rownames(CAP_norm_cluster_april)
CAP_norm_cluster_august_names <- rownames(CAP_norm_cluster_august)
CAP_norm_cluster_december_names <- rownames(CAP_norm_cluster_december)

ps.b.r_april = subset_samples(ps.b.r, Month == "April")
ps.b.r_april_f = filter_taxa(ps.b.r_april, function(x) sum(x) > .01, TRUE)
ps.b.r_august = subset_samples(ps.b.r, Month == "August")
ps.b.r_august_f = filter_taxa(ps.b.r_august, function(x) sum(x) > .01, TRUE)
ps.b.r_december = subset_samples(ps.b.r, Month == "December")
ps.b.r_december_f = filter_taxa(ps.b.r_december, function(x) sum(x) > .01, TRUE)

ps.b.r_april_CAPcluster_taxa   <- prune_taxa(CAP_norm_cluster_april_names, ps.b.r_april_f)
ps.b.r_august_CAPcluster_taxa   <- prune_taxa(CAP_norm_cluster_august_names, ps.b.r_august_f)
ps.b.r_december_CAPcluster_taxa   <- prune_taxa(CAP_norm_cluster_december_names, ps.b.r_december_f)
```

What are the Proteobacteria-to-other-phyla proportions here?

```{r}
sv.phyl.p.april<-as.data.frame(table(tax_table(ps.b.r_april_CAPcluster_taxa)[, "Phylum"], exclude = NULL))
sv.phyl.p.april.ord <- sv.phyl.p.april[order(-sv.phyl.p.april$Freq),] 
head(sv.phyl.p.april.ord, n=10)

sv.phyl.p.august<-as.data.frame(table(tax_table(ps.b.r_august_CAPcluster_taxa)[, "Phylum"], exclude = NULL))
sv.phyl.p.august.ord <- sv.phyl.p.august[order(-sv.phyl.p.august$Freq),] 
head(sv.phyl.p.august.ord, n=10)

sv.phyl.p.december<-as.data.frame(table(tax_table(ps.b.r_december_CAPcluster_taxa)[, "Phylum"], exclude = NULL))
sv.phyl.p.december.ord <- sv.phyl.p.december[order(-sv.phyl.p.december$Freq),] 
head(sv.phyl.p.december.ord, n=10)

ps.b.r_april_CAPcluster_taxa.glom <- tax_glom(ps.b.r_april_CAPcluster_taxa, taxrank = 'Genus', NArm = FALSE)
ps.b.r_april_CAPcluster_taxa.glom.psdf <- data.table(psmelt(ps.b.r_april_CAPcluster_taxa.glom))
ps.b.r_april_CAPcluster_taxa.glom.psdf$Phylum <- as.character(ps.b.r_april_CAPcluster_taxa.glom.psdf$Phylum)
ps.b.r_april_CAPcluster_taxa.glom.psdf$Class <- as.character(ps.b.r_april_CAPcluster_taxa.glom.psdf$Class)
ps.b.r_april_CAPcluster_taxa.glom.psdf$Genus <- as.character(ps.b.r_april_CAPcluster_taxa.glom.psdf$Genus)
ps.b.r_april_CAPcluster_taxa.plot<-ggplot(ps.b.r_april_CAPcluster_taxa.glom.psdf[Abundance > 0], 
                                    aes(x = Site.name, y = Abundance/3, fill = Genus)) + 
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance\n") +
  scale_fill_manual(values=distinctColorPalette(length(unique(ps.b.r_april_CAPcluster_taxa.glom.psdf$Genus))),
                     na.value = "black")

ps.b.r_august_CAPcluster_taxa.glom <- tax_glom(ps.b.r_august_CAPcluster_taxa, taxrank = 'Genus', NArm = FALSE)
ps.b.r_august_CAPcluster_taxa.glom.psdf <- data.table(psmelt(ps.b.r_august_CAPcluster_taxa.glom))
ps.b.r_august_CAPcluster_taxa.glom.psdf$Phylum <- as.character(ps.b.r_august_CAPcluster_taxa.glom.psdf$Phylum)
ps.b.r_august_CAPcluster_taxa.glom.psdf$Class <- as.character(ps.b.r_august_CAPcluster_taxa.glom.psdf$Class)
ps.b.r_august_CAPcluster_taxa.glom.psdf$Genus <- as.character(ps.b.r_august_CAPcluster_taxa.glom.psdf$Genus)
ps.b.r_august_CAPcluster_taxa.plot<-ggplot(ps.b.r_august_CAPcluster_taxa.glom.psdf[Abundance > 0], 
                                    aes(x = Site.name, y = Abundance/3, fill = Genus)) + 
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance\n") +
  scale_fill_manual(values=distinctColorPalette(length(unique(ps.b.r_august_CAPcluster_taxa.glom.psdf$Genus))),
                     na.value = "black")

ps.b.r_december_CAPcluster_taxa.glom <- tax_glom(ps.b.r_december_CAPcluster_taxa, taxrank = 'Genus', NArm = FALSE)
ps.b.r_december_CAPcluster_taxa.glom.psdf <- data.table(psmelt(ps.b.r_december_CAPcluster_taxa.glom))
ps.b.r_december_CAPcluster_taxa.glom.psdf$Phylum <- as.character(ps.b.r_december_CAPcluster_taxa.glom.psdf$Phylum)
ps.b.r_december_CAPcluster_taxa.glom.psdf$Class <- as.character(ps.b.r_december_CAPcluster_taxa.glom.psdf$Class)
ps.b.r_december_CAPcluster_taxa.glom.psdf$Genus <- as.character(ps.b.r_december_CAPcluster_taxa.glom.psdf$Genus)
ps.b.r_december_CAPcluster_taxa.plot<-ggplot(ps.b.r_december_CAPcluster_taxa.glom.psdf[Abundance > 0], 
                                    aes(x = Site.name, y = Abundance/3, fill = Genus)) + 
  geom_bar(stat = "identity") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance\n") +
  scale_fill_manual(values=distinctColorPalette(length(unique(ps.b.r_december_CAPcluster_taxa.glom.psdf$Genus))),
                     na.value = "black")

ps.b.r_CAPcluster_taxa_plot <- plot_grid(ps.b.r_april_CAPcluster_taxa.plot, 
                                         ps.b.r_august_CAPcluster_taxa.plot, 
                                         ps.b.r_december_CAPcluster_taxa.plot,
                                         align = 'v', ncol = 1)
```
```{r, fig.height=16, fig.width=14}
ps.b.r_CAPcluster_taxa_plot
```

As expected, the genus-level analysis shows that the main Epsilonproteobacterial players are the ones modulating this shift showed by the CAP. Further, the Gammaproteobacteria noticed in that shifted cluster are represented by Thiotrix. In April, Omnitrophica follows Proteobacteria in SV presence, whilst in August and December it's Parcubacteria, both of these in numbers ~8x smaller than Proteobacterial SVs.

Importantly, this cluster is, albeit not in huge amounts, driven by temperature, K, EC and Na, bit less in December. What can this mean mostly for these environmental variables? I can see how temperature might impact given that in Crumlin, Celynen and Six Bells are amongst the warmest sites. The first two also present the highest EC values in the same figure.

Ok then, I have no idea what to do at this point, passing on to other stuff.