---
title: "SGG - All of things for the manuscript"
author: "André Soares"
date: "14 January 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r initial loadings, message=FALSE, warning=FALSE, include=FALSE}
library(dada2); packageVersion("dada2")
library(ggplot2); packageVersion("ggplot2")
library(phyloseq); packageVersion("phyloseq")
library(data.table); packageVersion("data.table")
library(dplyr)
library(plyr)
library(magrittr)
library(RColorBrewer)
library(picante)
library(igraph)
library(cowplot)
library(plotly)
library(lemon)
library(GGally)
library(randomcoloR)
library(knitr)
library(kableExtra)
library(ggpmisc)
library(ggpubr)
library(decontam)
library(phyloseq)
```

```{r load SV data, echo=FALSE}
SGG_SVt = readRDS("seqtab_final.rds")
sgg_metadata<-read.csv("SGG_hydro_and_geochemistry_v3_tidy_mM_wctls.csv", header=TRUE)
SGG_Tax = readRDS("tax_final_s132.rds")

order<-rownames(SGG_SVt)
sgg_metadata_ord<-sgg_metadata[match(order, sgg_metadata$Sample_Code),]
rownames(sgg_metadata_ord) <- sgg_metadata_ord$Sample_Code
ps <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
               sample_data(sgg_metadata_ord), 
               tax_table(SGG_Tax))
ps.a = subset_samples(ps, Site.name != "Taff's Well PUMPED")

nmds_ps.b.r_colors_by_name = c("Celynen North" = "#440a31",
                               "Crumlin Navigation" = "#aa4455",
                               "Six Bells" = "#ef7ac8",
                               "Blaenavon" = "#08243f",
                               "Cefn Hengoed" = "#4488aa",
                               "Dinas" = "#8cc5ff",
                               "Glyncastle" = "#0c4c2c",
                               "Morlais" = "#03a353",
                               "Mountain Gate" = "#89d6af",
                               "Taff Bargoed" = "#774411",
                               "Ynysarwed" = "#ff9430",
                               "Lindsay" = "#DDAA77",
                               "Taff's Well" = "#cec400")
nmds_ps.b.r_shapes_by_name = c(15,
                               16,
                               17)
```

**Basic stuff:**

- Library sizes:

```{r echo=FALSE, message=FALSE, warning=FALSE}
df <- as.data.frame(sample_data(ps)) # Put sample_data into a ggplot-friendly data.frame
df$LibrarySize <- sample_sums(ps)
df <- df[order(df$LibrarySize),]
df$Index <- seq(nrow(df))
ggplot(df, 
       aes(x=Index, y=LibrarySize, color=Sample_type)) +
  labs(x="Samples",
       y="Reads per library") +
  geom_hline(yintercept = c(50000,100000,150000),
             linetype = 2) +
  geom_point(size=2, alpha=0.5) +
  guides(color=guide_legend(title="Sample Type")) +
  scale_y_continuous(labels=function(x) format(x, big.mark = ",",
                                               scientific = FALSE))
  
```

- Number of samples:
```{r echo=FALSE, message=FALSE, warning=FALSE}
nrow(otu_table(ps))
```

- Number of true contaminants found by ```decontam``` in the full dataset by prevalence:
```{r echo=FALSE}
sample_data(ps.a)$is.neg <- sample_data(ps.a)$Sample_type == "Control"
contamdf.prev <- isContaminant(ps.a, method="prevalence", threshold = 0.5,
                               neg="is.neg")
table(contamdf.prev$contaminant)
```
- How prevalent are these contaminants throught the dataset?
```{r echo=FALSE}
ps.pa <- transform_sample_counts(ps, function(abund) 1*(abund>0))
ps.pa.neg <- prune_samples(sample_data(ps.pa)$Sample_type == "Control", ps.pa)
ps.pa.pos <- prune_samples(sample_data(ps.pa)$Sample_type == "Sample", ps.pa)
# Make data.frame of prevalence in positive and negative samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.pa.pos), pa.neg=taxa_sums(ps.pa.neg),
                      contaminant=contamdf.prev$contaminant)
ggplot(df.pa, 
       aes(x=pa.neg, y=pa.pos, color=contaminant)) + 
  geom_point(size=2, alpha=0.5) +
  guides(color=guide_legend(title="Contaminant")) +
  xlab("Prevalence (Negative Controls)") + 
  ylab("Prevalence (True Samples)")
```

How many reads are associated to these contaminants?
```{r echo=FALSE}
ps.noncontam <- prune_taxa(contamdf.prev$contaminant, ps)
sum(rowSums(otu_table(ps.noncontam)))
```
These SVs were removed for the ensuing analyses
```{r echo=FALSE}
ps.noncontam <- prune_taxa(!contamdf.prev$contaminant, ps.a)
ps.b = subset_samples(ps.noncontam, Sample_type != "Control")
ps.b = subset_samples(ps.b, Sample_type != "Taff's Well PUMPED")

ps.b <- prune_taxa(taxa_sums(ps.b) > 0, ps.b)
#order months
sample_data(ps.b)$Month = factor(sample_data(ps.b)$Month, 
                                 levels = c("April","August","December"))
sample_data(ps.b)$Site.name = factor(sample_data(ps.b)$Site.name, 
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taff's Well"))
#to relative abundances
ps.b = subset_taxa(ps.b, Kingdom %in% c("Archaea", "Bacteria"))
ps.b = subset_samples(ps.b, Site.name != "Taff's Well PUMPED")
ps.b.r <-  transform_sample_counts(ps.b, function(x) {x/sum(x)})
ps.b.r.f = filter_taxa(ps.b.r, function(x) sum(x) > .001, TRUE)
```
- Number of samples without controls, Taff's Well:
```{r echo=FALSE, message=FALSE, warning=FALSE}
nrow(otu_table(ps.b))
```
- Number of SVs:
```{r echo=FALSE, message=FALSE, warning=FALSE}
ntaxa(otu_table(ps.b.r))
```
- Number of trimmed quality filtered reads:
```{r echo=FALSE, message=FALSE, warning=FALSE}
sum(rowSums(otu_table(ps)))
```

- Total numbers following SV generation:
```{r echo=FALSE, message=FALSE, warning=FALSE}
sort(rowSums(otu_table(ps)))
```

- Total numbers following `decontam` and filtering:
```{r echo=FALSE, message=FALSE, warning=FALSE}
sort(rowSums(otu_table(ps.b)))
```

- Total numbers of Bacterial SV's and reads:
```{r echo=FALSE}
ntaxa(subset_taxa(ps.b, Kingdom == "Bacteria"))
-sum(rowSums(otu_table(subset_taxa(ps.b, Kingdom == "Bacteria"))))
```

- Total numbers of Archaeal SV's and reads:
```{r echo=FALSE}
ntaxa(subset_taxa(ps.b, Kingdom == "Archaea"))
sum(rowSums(otu_table(subset_taxa(ps.b, Kingdom == "Archaea"))))

ps.arc=subset_taxa(ps.b, Kingdom == "Archaea")
top.phyla = sort(tapply(taxa_sums(ps.arc), tax_table(ps.arc)[, "Genus"], sum), TRUE)
top.phyla = top.phyla[1:10]
# Prune to just the most-abundant 5 phyla
ps.arc2 = subset_taxa(ps.arc, Genus %in% names(top.phyla))
get_taxa_unique(ps.arc2, "Genus")
```

- Batch effect much? (Student's t-test)

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=7}
#remove samples with 0 reads
ps.batch = prune_samples(sample_sums(ps)>=1, ps)

readsumsdf_samples<-data.frame(nreads = as.numeric(sample_sums(ps.batch)),
                               samples = rownames(as.data.frame(sample_sums(ps.batch))),
                               batch = as.factor(sample_data(ps.batch)$Batch))
# readsumsdf_samples_f = readsumsdf_samples[- grep("Control", readsumsdf_samples$batch),]

my_comparisons=list(c("1","2"),c("1","3"),c("1","4"),c("1","5"),c("1","6"),c("1","7"),
                    c("2","3"), c("2","4"), c("2","5"),c("2","6"),c("2","7"),
                    c("3","4"), c("3","5"),c("3","6"),c("3","7"),
                    c("4","5"),c("4","6"),c("4","7"),
                    c("5","6"),c("5","7"),
                    c("6","7"))

ggplot(readsumsdf_samples, aes(x=batch, y=nreads,
                                 color=batch, fill=batch)) +
  geom_violin(alpha=0.3) +
  geom_jitter(shape=16, position = "jitter") +
  stat_compare_means(comparisons = my_comparisons,
                     method = "t.test",
                     symnum.args = list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05,0.01, 1),
                     symbols = c("p<0.0001", "p<0.001", "p<0.01", "p<0.05","p<0.1", "ns"))) +
  scale_y_continuous(breaks = c(0,50000,100000, 150000,200000),
                     labels=scales::comma) +
  labs(color="Batch Number") +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(vjust = 1,
                                   hjust = 1,
                                   size = 12),
        axis.title = element_blank(),
        strip.text = element_text(size = 12, margin = margin()))
```

```{r main metadata, echo=FALSE}
sample_data(ps.b.r)$Site.name = factor(sample_data(ps.b.r)$Site.name, 
                                          levels = c("Celynen North","Crumlin Navigation",
                                                     "Six Bells","Blaenavon","Cefn Hengoed",
                                                     "Dinas","Glyncastle","Morlais",
                                                     "MountainGate","Taff Bargoed",
                                                     "Ynysarwed","Lindsay","Taff's Well"))
metadata<-sample_data(ps.b.r)
#Temp
temp_table.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=Temp.C, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=1,
             position = position_dodge(width=0.5)) +
  geom_point(aes(fill=Month, color=Month),
             size=4, alpha=0.3,
             position = position_dodge(width=0.5)) +
  geom_hline(yintercept = 13.4,
             color="dark red",
             linetype="dashed") +
  scale_color_manual(values = c("chocolate1", "chartreuse3", "dodgerblue3")) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=12),
        legend.position = "bottom",
        legend.title = element_text(face = "bold"),
        legend.background = element_rect(fill="gray95", size=.5, linetype="dotted"),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20")) +
  labs(y=expression(paste("Temperature (ºC)",sep='')))
#DO
do.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=DO, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=1,
             position = position_dodge(width=0.5)) +
  geom_point(aes(fill=Month, color=Month),
             size=4, alpha=0.3,
             position = position_dodge(width=0.5)) +
  scale_color_manual(values = c("chocolate1", "chartreuse3", "dodgerblue3")) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=12),
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20")) +
  labs(y="Dissolved Oxygen (%)")
#Sulfate
so4.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=SO4, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=1,
             position = position_dodge(width=0.5)) +
  geom_point(aes(fill=Month, color=Month),
             size=4, alpha=0.3,
             position = position_dodge(width=0.5)) +
  scale_color_manual(values = c("chocolate1", "chartreuse3", "dodgerblue3")) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=12),
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20")) +
  labs(y=expression(paste("SO"[4]^{-2},"(",mu,"g mL"^{-1},")"))) +
  guides(size=FALSE)
#pH
pH.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=pH, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=1,
             position = position_dodge(width=0.5)) +
  geom_point(aes(fill=Month, color=Month),
             size=4, alpha=0.3,
             position = position_dodge(width=0.5)) +
  scale_color_manual(values = c("chocolate1", "chartreuse3", "dodgerblue3")) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size=12),
        legend.position = "none",
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20")) +
  labs(y="pH") +
  guides(size=FALSE)
#EC
ec.plot<-ggplot(metadata, 
                        aes(x=Site.name, y=`EC.uS.cm`, fill=Month)) +
  geom_point(aes(fill=Month, color=Month),
             size=1,
             position = position_dodge(width=0.5)) +
  geom_point(aes(fill=Month, color=Month),
             size=4, alpha=0.3,
             position = position_dodge(width=0.5)) +
  scale_color_manual(values = c("chocolate1", "chartreuse3", "dodgerblue3")) +
  scale_y_continuous(breaks=c(0,500,1000,1500,2000,2500,3000)) +
  theme(axis.title.x=element_blank(),
        axis.title.y = element_text(size=14),
        axis.text.x = element_text(angle = 25, hjust = 1, size= 13),
        axis.text.y = element_text(size=12),
        legend.position = "none",
        legend.title = element_text(face = "bold"),
        legend.background = element_rect(fill="gray95", size=.5, linetype="dotted"),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20")) +
  labs(y=expression(paste("EC (",mu,"S cm"^{-1},")")))
```
```{r message=FALSE, warning=FALSE, fig.height=11, fig.width=10}
plot_grid(temp_table.plot, do.plot, so4.plot, pH.plot, ec.plot, 
          ncol = 1, align='v', 
          rel_heights = c(1.4,1.1,1,1,1.4))
```

###**Figure 2a:** High-level taxonomic view of the dataset:

```{r general proteobacterial taxonomy, echo=FALSE}
ps.b.r.glom <- speedyseq::tax_glom(ps.b.r, taxrank = 'Phylum', NArm = FALSE)
# saveRDS(ps.b.r.glom, "/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_R/ps.b.r.glom.rds")
# ps.b.r.glom = readRDS("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_R/ps.b.r.glom.rds")
ps.b.r.glom.psdf <- data.table(speedyseq::psmelt(ps.b.r.glom))
ps.b.r.glom.psdf$Phylum <- as.character(ps.b.r.glom.psdf$Phylum)

ps.b.r.glom.psdf[, median := median(Abundance, na.rm = TRUE), 
                 by = "Phylum"]
ps.b.r.glom.psdf[(median <= 0.01), Phylum := "Other (<1%)"]
ps.b.r.glom.psdf[(median <= 0.01), Class := "Other"]
ps.b.r.glom.psdf$Phylum[is.na(ps.b.r.glom.psdf$Phylum)] <- "Other (<1%)"
# ps.b.r.glom.psdf$Class[is.na(ps.b.r.glom.psdf$Class)] <- "Other"
ps.b.r.glom.psdf$Phylum[is.na(ps.b.r.glom.psdf$Phylum) & ps.b.r.glom.psdf$Kingdom=="Bacteria"] <- "Unc. Bacteria"
ps.b.r.glom.psdf$Phylum[is.na(ps.b.r.glom.psdf$Phylum) & ps.b.r.glom.psdf$Kingdom=="Archaea"] <- "Unc. Archaea"
#Removing Proteobacteria from previous table
ps.b.r.glom.psdf.noProteo<-ps.b.r.glom.psdf[!grepl("Proteobacteria", ps.b.r.glom.psdf$Phylum),]
#New table, with Proteobacterial classes only
ps.b.r.ProtCl = subset_taxa(ps.b.r, Phylum == "Proteobacteria")
ps.b.r.ProtClglom <- speedyseq::tax_glom(ps.b.r.ProtCl, taxrank = 'Class', NArm = FALSE)
ps.b.r.ProtClglom.psdf <- data.table(speedyseq::psmelt(ps.b.r.ProtClglom))
ps.b.r.ProtClglom.psdf$Class <- as.character(ps.b.r.ProtClglom.psdf$Class)

ps.b.r.ProtClglom.psdf[, median := median(Abundance, na.rm = TRUE), 
                        by = "Class"]
ps.b.r.ProtClglom.psdf[(median <= 0.01), Class := "Other Proteobacteria"]
ps.b.r.ProtClglom.psdf.noP <- subset(ps.b.r.ProtClglom.psdf, select = -Phylum)

#Removing Gammaproteobacteria from previous table
ps.b.r.ProtClglom.psdf.noP<-ps.b.r.ProtClglom.psdf.noP[!grepl("Gammaproteobacteria",
                                                               ps.b.r.ProtClglom.psdf.noP$Class),]
#New table, with Proteobacterial classes only
ps.b.r.GProtCl = subset_taxa(ps.b.r, Class == "Gammaproteobacteria")
ps.b.r.GProtClglom <- speedyseq::tax_glom(ps.b.r.GProtCl, taxrank = 'Order', NArm = FALSE)
ps.b.r.GProtClglom.psdf <- data.table(speedyseq::psmelt(ps.b.r.GProtClglom))
ps.b.r.GProtClglom.psdf$Order <- as.character(ps.b.r.GProtClglom.psdf$Order)

ps.b.r.GProtClglom.psdf[, median := median(Abundance, na.rm = TRUE), 
                        by = "Order"]
ps.b.r.GProtClglom.psdf[(median <= 0.01), Order := "Other Gammaproteobacteria"]
ps.b.r.GProtClglom.psdf.noP <- subset(ps.b.r.GProtClglom.psdf, select = -Phylum)
ps.b.r.GProtClglom.psdf.noP <- subset(ps.b.r.GProtClglom.psdf.noP, select = -Class)

names(ps.b.r.glom.psdf.noProteo)[names(ps.b.r.glom.psdf.noProteo) == 'Phylum'] <- 'Taxa'
names(ps.b.r.ProtClglom.psdf.noP)[names(ps.b.r.ProtClglom.psdf.noP) == 'Class'] <- 'Taxa'
names(ps.b.r.GProtClglom.psdf.noP)[names(ps.b.r.GProtClglom.psdf.noP) == 'Order'] <- 'Taxa'

ps.b.r.ProteoClAllPhy <- rbind(ps.b.r.glom.psdf.noProteo, 
                               ps.b.r.ProtClglom.psdf.noP,
                               ps.b.r.GProtClglom.psdf.noP,
                               fill=TRUE)
ps.b.r.ProteoClAllPhy$Taxa[is.na(ps.b.r.ProteoClAllPhy$Taxa)] <- "Other (<1%)"
ps.b.r.ProteoClAllPhy$Site.name = factor(ps.b.r.ProteoClAllPhy$Site.name, 
                                    levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                               "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                               "Morlais","Mountain Gate","Taff Bargoed",
                                               "Ynysarwed","Lindsay","Taff's Well"))

ps.b.r.ProteoClAllPhy$Taxa = factor(ps.b.r.ProteoClAllPhy$Taxa, 
            levels = c("Epsilonbacteraeota",
                       "Deltaproteobacteria", 
                       "Betaproteobacteriales","Other Gammaproteobacteria",
                       "Other Proteobacteria",
                       "Actinobacteria",
                       "Nitrospirae",
                       "Bacteroidetes",
                       "Omnitrophicaeota",
                       "Patescibacteria",
                       "Other (<1%)"))
ps.b.r.ProteoClAllPhy.plot<-ggplot(ps.b.r.ProteoClAllPhy, 
                                    aes(x = Site.name, y = Abundance/3, fill = Taxa)) + 
  facet_grid(Month~.) +
  geom_bar(stat = "identity", colour="black") +
  scale_fill_manual(values = brewer.pal(11, "Paired"),
                     na.value = "gray40") +
  scale_y_continuous(expand = c(0,0),
                     labels = scales::percent,
                     breaks = c(0.25,0.5,0.75,1)) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size=16,
                                   angle = 35, hjust = 1),
        axis.title.y = element_text(size=18, face = "bold"),
        axis.text.y = element_text(size=17),
        strip.text.x = element_text(face = "bold",
                                    size = 18),
        strip.text.y = element_text(face = "bold",
                                    size = 18),
        strip.background = element_rect(size=1),
        legend.text = element_text(size= 16),
        legend.title = element_text(size=18, face="bold")) + 
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance (%)\n")
```
```{r echo=FALSE, fig.height=14, fig.width=20}
ps.b.r.ProteoClAllPhy.plot
```

<!-- % of reads affiliated to Beta- and Epsilonproteobacteria across the whole dataset. -->

<!-- ```{r echo=FALSE} -->
<!-- betaeps = ps.b %>%  -->
<!--   subset_taxa(Class == "Epsilonproteobacteria" | Class == "Betaproteobacteria")  -->
<!-- betaeps_sum = sum(rowSums(otu_table(betaeps))) -->

<!-- tots_sum=sum(rowSums(otu_table(ps.b))) -->

<!-- betaeps_sum/tots_sum*100 -->
<!-- ``` -->

<!-- ```{r echo=FALSE} -->
<!-- eps = ps.b %>%  -->
<!--   subset_taxa(Class == "Epsilonproteobacteria") -->
<!-- beta = ps.b %>%  -->
<!--   subset_taxa(Class == "Betaproteobacteria") -->
<!-- sum(rowSums(otu_table(eps)))/tots_sum*100 -->
<!-- sum(rowSums(otu_table(beta)))/tots_sum*100 -->
<!-- ``` -->

<!-- % of reads not Epsilonproteobacteria in SOB-rich sites -->

<!-- ```{r echo=FALSE} -->
<!-- eps_sobsites = ps.b %>%  -->
<!--   subset_samples(Site.name == "Crumlin Navigation" | Site.name == "Celynen North" | Site.name == "Six Bells") %>%  -->
<!--   subset_taxa(Class == "Epsilonproteobacteria")  -->
<!-- eps_sum_sobsites = sum(rowSums(otu_table(eps_sobsites))) -->

<!-- tots_sum_sobsites= ps.b %>%  -->
<!--   subset_samples(Site.name == "Crumlin Navigation" | Site.name == "Celynen North" | Site.name == "Six Bells") -->
<!-- tots_sum_sobsites = sum(rowSums(otu_table(tots_sum_sobsites))) -->

<!-- 100-eps_sum_sobsites/tots_sum_sobsites*100 -->
<!-- ``` -->

<!-- Highest abundance found for Patescibacteria across any sample: -->

<!-- ```{r echo=FALSE} -->
<!-- head(sort(ps.b.r.glom.psdf[ps.b.r.glom.psdf$Phylum == 'Patescibacteria' ,]$Abundance, decreasing = TRUE), n=1)*100 -->
<!-- ``` -->

<!-- How many Patescibacteria SV's were found? -->
<!-- ```{r echo =FALSE} -->
<!-- ntaxa(subset_taxa(ps.b, Phylum=="Patescibacteria")) -->
<!-- ``` -->

<!-- How many Patescibacterial classes were found? -->

<!-- ```{r echo=FALSE} -->
<!-- parc=subset_taxa(ps.b, Phylum=="Patescibacteria") -->
<!-- parc_df=data.table(psmelt(parc)) -->
<!-- unique(parc_df$Class) -->
<!-- ``` -->

<!-- How much of the overall Betaproteobacteria-rich sample reads are explained by Patescibacteria and Omnitrophicaeota? -->

<!-- ```{r echo=FALSE} -->
<!-- ps.b.r.top_genera.glom2 <- speedyseq::tax_glom(ps.b, taxrank = 'Genus', NArm = FALSE) -->
<!-- ps.b.r.top_genera.glom.psdf2 <- data.table(psmelt(ps.b.r.top_genera.glom2)) -->

<!-- betap = ps.b %>% -->
<!--   subset_samples(Site_type == "FeOB-rich") %>%  -->
<!--   subset_taxa(Order == "Betaproteobacteria") -->
<!-- betapab = sum(rowSums(otu_table(betap))) -->

<!-- parcomni = ps.b %>% -->
<!--   subset_samples(Site_type == "FeOB-rich") %>%  -->
<!--   subset_taxa(Phylum == "Patescibacteria" | Phylum == "Omnitrophicaeota") -->
<!-- parcomni_betapdt_ab = sum(rowSums(otu_table(parcomni))) -->

<!-- parcomni_betapdt_ab/betapab*100 -->
<!-- ``` -->

<!-- % of Patescibacteria and Omnitrophicaeota in Lindsay -->

<!-- ```{r echo=FALSE} -->
<!-- lindsay = ps.b %>% -->
<!--   subset_samples(Site.name == "Lindsay") -->
<!-- lindsayab = sum(rowSums(otu_table(lindsay))) -->

<!-- parcomni_lindsay = ps.b %>% -->
<!--   subset_samples(Site.name == "Lindsay") %>%  -->
<!--   subset_taxa(Phylum == "Patescibacteria" | Phylum == "Omnitrophicaeota") -->
<!-- parcomni_lindsay_ab = sum(rowSums(otu_table(parcomni_lindsay))) -->

<!-- parcomni_lindsay_ab/lindsayab*100 -->
<!-- ``` -->

<!-- % Sulfuriferula in Lindsay in August -->

<!-- ```{r echo=FALSE} -->
<!-- sulfurif_aug_lindsay = ps.b %>% -->
<!--   subset_samples(Site.name == "Lindsay") %>%  -->
<!--   subset_samples(Month == "August") %>% -->
<!--   subset_taxa(Genus == "Sulfuriferula") -->
<!-- sulfurif_aug_lindsay_ab = sum(rowSums(otu_table(sulfurif_aug_lindsay))) -->

<!-- aug_lindsay = ps.b %>% -->
<!--   subset_samples(Site.name == "Lindsay") %>%  -->
<!--   subset_samples(Month == "August") -->
<!-- aug_lindsay_ab = sum(rowSums(otu_table(aug_lindsay))) -->

<!-- sulfurif_aug_lindsay_ab/aug_lindsay_ab*100 -->
<!-- ``` -->

```{r echo=FALSE, fig.width=10, fig.height=5}
fast_melt=function(physeq){
  # supports "naked" otu_table as `physeq` input.
  otutab = as(otu_table(physeq), "matrix")
  if(!taxa_are_rows(physeq)){otutab <- t(otutab)}
  otudt = data.table(otutab, keep.rownames = TRUE)
  setnames(otudt, "rn", "taxaID")
  # Enforce character taxaID key
  otudt[, taxaIDchar := as.character(taxaID)]
  otudt[, taxaID := NULL]
  setnames(otudt, "taxaIDchar", "taxaID")
  # Melt count table
  mdt = melt.data.table(otudt, 
                        id.vars = "taxaID",
                        variable.name = "SampleID",
                        value.name = "count")
  # Remove zeroes, NAs
  mdt <- mdt[count > 0][!is.na(count)]
  # Calculate relative abundance
  mdt[, RelativeAbundance := count / sum(count), by = SampleID]
  if(!is.null(tax_table(physeq, errorIfNULL = FALSE))){
    # If there is a tax_table, join with it. Otherwise, skip this join.
    taxdt = data.table(as(tax_table(physeq, errorIfNULL = TRUE), "matrix"), keep.rownames = TRUE)
    setnames(taxdt, "rn", "taxaID")
    # Enforce character taxaID key
    taxdt[, taxaIDchar := as.character(taxaID)]
    taxdt[, taxaID := NULL]
    setnames(taxdt, "taxaIDchar", "taxaID")
    # Join with tax table
    setkey(taxdt, "taxaID")
    setkey(mdt, "taxaID")
    mdt <- taxdt[mdt]
  }
  return(mdt)
}

ps.b.mainp = subset_taxa(ps.b, Phylum=="Proteobacteria" | Phylum=="Actinobacteria" | Phylum=="Omnitrophicaeota" | Phylum=="Patescibacteria" | Phylum=="Nitrospira" | Phylum == "Epsilonbacteraeota")
mdt = fast_melt(ps.b.mainp)
prevdf <- cbind(mdt, tax_table(ps.b.mainp))

prevdt = mdt[, list(Prevalence = sum(count > 0), 
                    TotalCounts = sum(count)),
             by = taxaID]

addPhylum = unique(copy(mdt[, list(taxaID, Class)]))
setkey(prevdt, taxaID)
setkey(addPhylum, taxaID)
prevdt <- addPhylum[prevdt]
prevdt <- prevdt[!(is.na(prevdt$Class)),]
showPhyla = prevdt[, sum(TotalCounts), by = Class][order(-V1)][1:10]$Class
setkey(prevdt, Class)

prv_colors = c("#440a31", "#aa4455", "#ef7ac8",
               "#08243f", "#4488aa", "#8cc5ff",
               "#0c4c2c", "#03a353", "#89d6af",
               "#774411")

prevdt_showPhyla<-prevdt[showPhyla]

# prevdt_showPhyla$Class = factor(prevdt_showPhyla$Class, 
#                           levels = c("Alphaproteobacteria","Betaproteobacteria","Deltaproteobacteria","Epsilonproteobacteria",
#                                      "Gammaproteobacteria","Actinobacteria","Candidatus_Azambacteria","Candidatus_Jorgensenbacteria",
#                                      "Candidatus_Magasanikbacteria","Candidatus_Nomurabacteria"))
ggplot(prevdt_showPhyla, 
       mapping = aes(Prevalence, TotalCounts, color = Class)) + 
  geom_point(size = 4, alpha = 0.7) + 
  geom_point(size = 2) + 
  scale_y_log10(labels=scales::comma) +
  scale_color_manual(values=prv_colors) +
  geom_vline(xintercept = 20, linetype="dotted") +
  theme_minimal()
```

(Omnitrophicaeota and Nitrospira classes not in the top 10 classes)

###**?Figure 2b:** nMDS.

```{r include=FALSE, message=FALSE, warning=FALSE}
set.seed(6)
ps.b.r.nmds  <- ordinate(ps.b.r,
                         "NMDS",
                         distance="jsd",
                         k=3,
                         maxit = 1e3)

nmds_ps.b.r_colors_by_name = c("Celynen North" = "#440a31", 
                               "Crumlin Navigation" = "#aa4455", 
                               "Six Bells" = "#ef7ac8",
                               "Blaenavon" = "#08243f", 
                               "Cefn Hengoed" = "#4488aa", 
                               "Dinas" = "#8cc5ff",
                               "Glyncastle" = "#0c4c2c", 
                               "Morlais" = "#03a353", 
                               "Mountain Gate" = "#89d6af",
                               "Taff Bargoed" = "#774411", 
                               "Ynysarwed" = "#ff9430", 
                               "Lindsay" = "#DDAA77",
                               "Taff's Well" = "#cec400")

nmds_ps.b.r_shapes_by_name = c(15,
                               16,
                               17)

set.seed(10)
nmds_ps.b.r <- plot_ordination(ps.b.r, ps.b.r.nmds) + 
                               geom_point(aes(color=Site.name,
                                              shape=Month),
                                          size=7, alpha = 0.7) +
                               stat_ellipse(aes(color=Site.name,
                                                fill=Site.name),
                                            geom = "polygon",
                                            type="t",
                                            alpha=0.1,
                                            linetype = 2,
                                            show.legend = FALSE) +
  scale_shape_manual("Month",values=nmds_ps.b.r_shapes_by_name) +
  scale_color_manual("Site", values=nmds_ps.b.r_colors_by_name) +
  scale_fill_manual("Site", values=nmds_ps.b.r_colors_by_name) +
  theme_minimal()

ps.b.r.nmds.spdf = as.data.frame(stressplot(ps.b.r.nmds))
r2 = round(0.959, digits =3)
R2.exp <- paste("R^2 == ",r2)

ps.b.r.nmds.spdf.plot = ggplot(ps.b.r.nmds.spdf, aes(x, y)) + 
  geom_point(aes(x, y),
             alpha = 0.2,
             color = "deepskyblue2") + 
  geom_smooth(method='loess',
              se = 0.99,
              alpha = 0.1,
              color = "dodgerblue4",
              fill = "dodgerblue4") +
  ylab("Ordination Distance") +
  xlab("Observed Dissimilarity") +
  annotate("text", x = 0.1, y = 0.4,
           label = "Non-metric fit: ") +
  annotate("text", x = 0.22, y = 0.405,
           label = R2.exp,
           parse = TRUE) +
  theme(axis.title = element_text(size = 8),
        axis.text = element_text(size = 7),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20")) +
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,0.71)) +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,0.71))
```
```{r echo=FALSE, fig.align="center", fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
ggdraw(nmds_ps.b.r) +
  # draw_plot() +
  # annotate("rect", xmin = 0.45, xmax = 0.6, ymin = 0.1, ymax = 0.45, color = "black", fill = NA) +
  draw_plot(ps.b.r.nmds.spdf.plot, 0.55, 0.065, 0.25, 0.25) +
  draw_plot_label(c("A", "B"), c(0, 0.6), c(1, 0.3), size = 15)
```
```{r echo=FALSE, fig.align="center", fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
nmds_ps.b.r
```
```{r echo=FALSE, fig.align="center", fig.height=5, fig.width=6, message=FALSE, warning=FALSE}
ps.b.r.nmds.spdf.plot
```
###**?Figure 2b:** CAP with normalised metadata variables, groups highlighted.

Which metadata variables explains the most microbial community structure in this dataset?
adonis ~ PERMANOVA (http://cc.oulu.fi/~jarioksa/softhelp/vegan/html/adonis.html)
(Working only with variables measured for all samples)

```{r echo=FALSE, message=FALSE, warning=FALSE}
ps.b.r.adonis = subset_samples(ps.b.r, !(Sample_Code %in% c(73,74,75)))
ps_jsd <- phyloseq::distance(ps.b.r, method = "jsd")
sampledf <- as(sample_data(ps.b.r), "data.frame")
sampledf$DO[is.na(sampledf$DO)] <- 44.1
sampledf$pH[is.na(sampledf$pH)] <- 7.29

sampledf <- sampledf[ !(sampledf$Sample_Code %in% c(73,74,75)), ]

# adonis(ps_jsd ~ Site.name + Pond_L + Month + Batch + Temp.C + pH + EC.uS.cm + Ca + DO + Mg + K + Na + Cl + NO3 + X6_Li + X7_Li + X7_Li_He + X9_Be + X11_B + X27_Al + X45_Sc + X47_Ti_ + X51_V_He + X52_Cr_He + X55_Mn +   X56_Fe_He +  X59_Co +   X60_Ni +   X63_Cu +   X68_Zn +   X65_Ga +   X75_As_He +  X78_Se +  X85_Rb +   X88_Sr +   X89_Y +    X90_Zr +  X93_Nb +   X97_Mo +   X98_Mo +   X111_Cd +  X114_Cd +  X115_In +  X123_Sb +  X125_Te +  X133_Cs +  X135_Ba +  X139_La +  X140_Ce +  X141_Pr + X146_Nd +  X147_Sm +  X153_Eu +  X157_Gd +  X159_Tb +  X163_Dy +  X165_Ho + X166_Er +  X169_Tm +  X172_Yb +  X175_Lu +  X181_Ta +  X182_W +  X200_Hg +  X201_Hg +  X202_Hg +  X205_Tl +  X206_Pb +  X207_Pb +  X209_Bi + X232_Th +  X238_U,
#        data = sampledf,
#        strata = sampledf$Time_point,
#        permutations=1e3)

adonis(ps_jsd ~ Pond_L + Month + Temp.C + pH + EC.uS.cm + Ca + DO + Mg + K + Na + Cl + NO3 + X11_B,
       data = sampledf,
       strata = sampledf$Time_point,
       permutations=1e3)
```

i.e. 82.99% of the variation in the dataset is explained by site (p<0.001).

Keeping all variables with p <0.01 for the CAP: ```Site.name```,```Month```,```Temp.C```,```Cl```,```SO4```,```X27_Al```,```X47_Ti_```,```X55_Mn```,```X74_Ge```,```X89_Y```, but also others that are known to explain the Beta/Epsilonproteobacteria ratio, ```Ca```, ```Na```, ```X11_B```.

```{r include=FALSE, message=FALSE, warning=FALSE}
metadata<-as(sample_data(ps.b.r),"data.frame")
metadata$DO[is.na(metadata$DO)] <- 44.1
# metadata<-metadata[!(metadata$Sample_Code=="73"),]
# metadata<-metadata[!(metadata$Sample_Code=="74"),]
# metadata<-metadata[!(metadata$Sample_Code=="75"),]
metadata <- metadata[ !(metadata$Sample_Code %in% c(73,74,75)), ]

metadata_noNA = metadata[ , colSums(is.na(metadata)) == 0]

ps_sig <- phyloseq(otu_table(SGG_SVt, taxa_are_rows=FALSE),
                   sample_data(metadata),
                   tax_table(SGG_Tax))
sample_data(ps_sig)$Month = factor(sample_data(ps_sig)$Month,
                                   levels = c("April","August","December","Control"))
ps_sig_ntf = subset_samples(ps_sig, Site.name != "Taff's Well PUMPED")
ps_sig_ntf_nc = subset_samples(ps_sig_ntf, Sample_type != "Control")
ps_sig_ntf_nc_noab = subset_taxa(ps_sig_ntf_nc, Kingdom %in% c("Archaea", "Bacteria"))
ps_cap_r = transform_sample_counts(ps_sig_ntf_nc_noab, function(x) x/sum(x))

set.seed(1)
# Calculate Jensen-Shannon distance matrix
ps_cap_r_jsd <- phyloseq::distance(ps_cap_r, method = "jsd")
# make a data frame from the sample_data
sampledf_cap <- data.frame(sample_data(ps_cap_r))

sample_data(ps.b.r)$Site.name = factor(sample_data(ps.b.r)$Site.name,
                                          levels = c("Celynen North","Crumlin Navigation",
                                                     "Six Bells","Blaenavon","Cefn Hengoed",
                                                     "Dinas","Glyncastle","Morlais",
                                                     "Mountain Gate",
                                                     "Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taff's Well"))
norm_metadata<-sgg_metadata
order_2<-rownames(otu_table(ps_cap_r))
sgg_metadata_ord_norm<-norm_metadata[match(order_2, norm_metadata$Sample_Code),]
rownames(sgg_metadata_ord_norm) <- sgg_metadata_ord_norm$Sample_Code

sgg_metadata_ord_norm$DO[is.na(sgg_metadata_ord_norm$DO)] <- 44.1

ps_cap_r_norm <- phyloseq(otu_table(ps_cap_r),
                       tax_table(ps_cap_r),
                       sample_data(sgg_metadata_ord_norm))

#CAP with significant normalised variables
CAP_ps_cap_r_norm <- ordinate(ps_cap_r_norm,
                           method = "CAP",
                           distance = "jsd",
                           k=3, trymax=1e3, weighted=TRUE,
                           formula = ~ Pond_L + Month + Temp.C + DO + Cl + Na + Ca + Mg + X47_Ti_)

CAP_cols = c("#771155", "#AA4488", "#CC99BB",
                              "#114477", "#4477AA", "#77AADD",
                              "#777711", "#AAAA44", "#d6d600",
                              "#774411", "#AA7744", "#DDAA77",
                              "#117744")

sample_data(ps_cap_r_norm)$Month = as.character(sample_data(ps_cap_r_norm)$Month)
CAP_norm_sig_plot_a12 <- plot_ordination(ps_cap_r_norm,
                                    ordination = CAP_ps_cap_r_norm, color = "Site.name", axes = c(1,2)) +
  geom_point(aes(colour = Site.name,shape = Month), alpha = 0.7, size = 4) +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(aes(colour = Site.name), size = 1.5)+
  scale_color_manual(values = nmds_ps.b.r_colors_by_name) +
  scale_fill_manual(values = nmds_ps.b.r_colors_by_name)

arrowmat_CAP_norm <- vegan::scores(CAP_ps_cap_r_norm, display = "bp")
arrowmat_CAP_norm<-subset(arrowmat_CAP_norm,
                           rownames(arrowmat_CAP_norm) %in% c("Pond_Ltwelve","Pond_Leleven","Pond_Ltwo","Temp.C","Cl","DO","Na","Ca","Mg","X47_Ti_"))
arrowdf_CAP_norm <- data.frame(labels = rownames(arrowmat_CAP_norm), arrowmat_CAP_norm)
rownames(arrowdf_CAP_norm) <- c("Pond 12","Pond 11","Pond 2","Temp","DO","Cl","Na","Ca","Mg","Ti")
arrowdf_CAP_norm$labels <- c("Pond 12","Pond 11","Pond 2","Temp","DO","Cl","Na","Ca","Mg","Ti")

arrow_map_CAP_norm <- aes(xend = CAP1, yend = CAP2,
                     x = 0, y = 0,
                     shape = NULL, color = NULL,
                     label = labels)
label_map_CAP_norm <- aes(x = 1.1 * CAP1, y = 1.3 * CAP2,
                     shape = NULL, color = NULL,
                     label = labels)
arrowhead_CAP_norm = arrow(length = unit(0.02, "npc"))

CAP_norm_sig_plot_a12 = CAP_norm_sig_plot_a12 +
  geom_segment(mapping = arrow_map_CAP_norm, size = .5,
               data = arrowdf_CAP_norm, color = "gray", arrow = arrowhead_CAP_norm) +
  geom_text(mapping = label_map_CAP_norm, size = 4,
            data = arrowdf_CAP_norm, show.legend = FALSE)

arrowmat_CAP_norm_13 <- vegan::scores(CAP_ps_cap_r_norm, display = "bp", choices=c(1,3))
arrowmat_CAP_norm_13<-subset(arrowmat_CAP_norm_13,
                           rownames(arrowmat_CAP_norm_13) %in% c("Pond_Ltwelve","Pond_Leleven","Pond_Ltwo","Temp.C","Cl","DO","Na","Ca","Mg","X47_Ti_"))
arrowdf_CAP_norm_13 <- data.frame(labels = rownames(arrowmat_CAP_norm_13), arrowmat_CAP_norm_13)
rownames(arrowdf_CAP_norm_13) <- c("Pond 12","Pond 11","Pond 2","Temp","DO","Cl","Na","Ca","Mg","Ti")
arrowdf_CAP_norm_13$labels <-c("Pond 12","Pond 11","Pond 2","Temp","DO","Cl","Na","Ca","Mg","Ti")

arrow_map_CAP_norm_13 <- aes(xend = CAP1, yend = CAP3,
                        x = 0, y = 0,
                        shape = NULL, color = NULL,
                        label = labels)
label_map_CAP_norm_13 <- aes(x = 1.1 * CAP1, y = 1.3 * CAP3,
                        shape = NULL, color = NULL,
                        label = labels)
arrowhead_CAP_norm_13 = arrow(length = unit(0.02, "npc"))

CAP_norm_sig_plot_a13 <- plot_ordination(ps_cap_r_norm,
                                    ordination = CAP_ps_cap_r_norm, color = "Site.name",axes = c(1,3)) +
  geom_point(aes(colour = Site.name,shape = Month), alpha = 0.7, size = 4) +
  geom_polygon(aes(fill=Site.name), alpha=0.5) +
  geom_point(aes(colour = Site.name), size = 1.5) +
  geom_segment(mapping = arrow_map_CAP_norm_13, size = .5,
               data = arrowdf_CAP_norm_13, color = "gray", arrow = arrowhead_CAP_norm_13) +
  geom_text(mapping = label_map_CAP_norm_13, size = 4,
            data = arrowdf_CAP_norm_13, show.legend = FALSE)+
  scale_color_manual(values = nmds_ps.b.r_colors_by_name) +
  scale_fill_manual(values = nmds_ps.b.r_colors_by_name) +
  scale_shape_manual("Month",
                     values = nmds_ps.b.r_shapes_by_name,
                     labels = c("April","August","December"))

ps.b.r.CAP_norm_sig.plot<-plot_grid(
  CAP_norm_sig_plot_a12+
    theme_minimal() +
    theme(legend.position = "none"), 
  CAP_norm_sig_plot_a13+
    theme_minimal(),
                               labels=c("A","B"), ncol = 2)
legend <- get_legend(CAP_norm_sig_plot_a13)
ps.b.r.CAP_norm_sig.plot.legend = plot_grid(ps.b.r.CAP_norm_sig.plot, ncol = 2, rel_widths = c(1, .1))
```
```{r echo=FALSE, fig.height=6, fig.width=16}
ps.b.r.CAP_norm_sig.plot.legend
```

How good of a CAP is this? Well, only 34.7% of the variation being explained by the first two axes. Let's see how the rest does.

```{r echo=FALSE}
CAP_ps_cap_r_norm
screeplot(CAP_ps_cap_r_norm)
anova(CAP_ps_cap_r_norm, by="axis", perm.max=1e3)
anova(CAP_ps_cap_r_norm, by="terms", perm.max=1e3)
```

Good. The first 12 axes/constraints are signficant. However, some of the factors used in the CAP seem to not be significant. They are significant for the story though...

*"The test statistic is ``pseudo-F'', which is the ratio of constrained and unconstrained total Inertia (Chi-squares, variances or something similar), each divided by their respective ranks."* - http://cc.oulu.fi/~jarioksa/softhelp/vegan/html/anova.cca.html

###**Figure 2c:** Beta- to Epsilonproteobacteria ratio vs. Boron, Na, Ca values (in mM):

<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- ps.b.r.f.be = subset_taxa(ps.b.r.f,  -->
<!--                             Order == "Betaproteobacteriales" | Phylum == "Epsilonbacteraeota") -->
<!-- phyloGlom = speedyseq::tax_glom(ps.b.r.f.be, "Class") -->
<!-- glomTax = tax_table(phyloGlom)[,"Class"] -->
<!-- glomOTU = otu_table(phyloGlom) -->
<!-- glomTable = merge(glomOTU,glomTax,by=0,all=TRUE) -->
<!-- colnames(glomTable) = c("SGG_ID","Betaproteobacteria", "Epsilonproteobacteria","bah") -->
<!-- glomTable$bah = NULL -->
<!-- remove = c("TGGGGAATATTACACAATGGAGGAAACTCTGATGTAGCAACGCCGCGTGGAGGATGACACATTTCGGTGCGTAAACTCCTTTTATTAGGGAAGATAATGACGGTACCTAATGAATAAGCACCGGCTAACTCCGTGCCAGCAGCCGCGGTAATACGGAGGGTGCAAGCGTTACTCGGAATCACTGGGCGTAAAGCGCATGTAGGCGGTCTTGTAAGTTGGGTGTGAAAGCCTATGGCTCAACCATAGAACTGCACCCAAAACTACTAGACTAGAGTCTGGGAGAGGAAAATGGAATTAGTTGTGTAGGGGTAAAATCCGTAGAGATAACTAGGAATACCAAAAGCGAAGGCAATTTTCTGGAACAGTACTGACGCTCAGATGCGAAAGCGTGGGTAGCAAACA", -->
<!--            "TGGGGAATTTTGGACAATGGGCGCAAGCCTGATCCAGCCATGCCGCGTGAGTGAAGAAGGCCTTCGGGTTGTAAAGCTCTTTCGGACAGAAAGAAATCGCACAGGCTAATACTCTGTGTGGATGACGGTACTGTAAGAAGAAGCACCGGCTAACTACGTGCCAGCAGCCGCGGTAATACGTAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGTGCGCAGGCGGCTTTTTAAGACAGATGTGAAATCCCCGGGCTCAACCTGGGAACTGCATTTGTGACTGGAAGGCTAGAGTGTAGCAGAGGGGGGTAGAATTCCACGTGTAGCAGTGAAATGCGTAGAGATGTGGAGGAATACCGATGGCGAAGGCAGCCCCCTGGGCTAACACTGACGCTCATGCACGAAAGCGTGGGGAGCAAACA") -->
<!-- glomTablefinal = glomTable[-which(glomTable$SGG_ID %in% remove), ] -->
<!-- glomTablefinal$EpsBetRatio = (glomTablefinal$Epsilonproteobacteria/(glomTablefinal$Epsilonproteobacteria + glomTablefinal$Betaproteobacteria)) -->

<!-- glomTablefinal=glomTablefinal[-c(73, 74, 75), ] -->
<!-- order_3<-glomTablefinal$SGG_ID -->

<!-- sgg_metadata_ord_2<-sgg_metadata[match(order_3, sgg_metadata$Sample_Code),] -->
<!-- rownames(sgg_metadata_ord_2) <- sgg_metadata_ord_2$Sample_Code -->
<!-- sgg_metadata_ord_2_final = sgg_metadata_ord_2[, c("Site.name","Month","Na","Ca","X11_B")] -->

<!-- geochem_com_table = cbind(glomTablefinal,sgg_metadata_ord_2_final) -->

<!-- geochem_com_table$NaCaRatio = (geochem_com_table$Na/(geochem_com_table$Na + geochem_com_table$Ca)) -->
<!-- geochem_com_table$X11_B_uM = geochem_com_table$X11_B*1000 -->
<!-- geochem_com_table_naca_b_epsbet=ggplot(geochem_com_table,  -->
<!--                                        aes(x=X11_B_uM, y=NaCaRatio, -->
<!--                                            color=Site.name, size=EpsBetRatio)) + -->
<!--   geom_point(shape = 1, stroke = 2) + -->
<!--   scale_color_manual("Sites",values = nmds_ps.b.r_colors_by_name, guide = 'none') + -->
<!--   scale_size_continuous("Beta-/Epsilonprot. \nratio") + -->
<!--   ylab(expression(paste("Na/Na+Ca ratio (",mu,"M)"))) + -->
<!--   xlab(expression(paste({}^11*"B(",mu,"M)"))) + -->
<!--   theme(legend.box = "horizontal") -->
<!-- # head(geochem_com_table_naca_b_epsbet$data) -->
<!-- ``` -->

<!-- ```{r echo=FALSE, fig.align="center", fig.height=4, fig.width=7, message=FALSE, warning=FALSE} -->
<!-- geochem_com_table_naca_b_epsbet -->
<!-- ``` -->

Do diversity, richness or dominance predict the seen groupings of samples?

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=8}
p1 = plot_richness(ps.b,
              x="Site.name", color="Site.name",
              measures="Observed", title = "Richness") +
  # geom_violin() +
  # geom_jitter(shape=16, alpha=0.7,
  #              position=position_jitter(0.2)) +
  geom_point(size=4, alpha=0.3) +
  facet_wrap(~Month) +
  scale_color_manual("Sites",
                     values = nmds_ps.b.r_colors_by_name, 
                     guide = 'none') +
  theme(axis.text.x = element_text(angle = 40,
                                   vjust = 1,
                                   hjust = 1,
                                   size = 9),
        axis.title = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20"))
p2 = plot_richness(ps.b,
              x="Site.name", color="Site.name",
              measures="Shannon", title="Shannon's Diversity") +
  # geom_violin() +
  # geom_jitter(shape=16, alpha=0.7,
  #             position=position_jitter(0.2)) +
  geom_point(size=4, alpha=0.3) +
  facet_wrap(~Month) +
  scale_color_manual("Sites",
                     values = nmds_ps.b.r_colors_by_name, 
                     guide = 'none') +
  theme(axis.text.x = element_text(angle = 40,
                                   vjust = 1,
                                   hjust = 1,
                                   size = 9),
        axis.title = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20"))
p3 = plot_richness(ps.b,
              x="Site.name", color="Site.name",
              measures="Simpson", title = "Simpson's Evenness") +
  # geom_violin() +
  # geom_jitter(position=position_jitter(0.2)) +
  geom_point(size=4, alpha=0.3) +
  facet_wrap(~Month) +
  scale_color_manual("Sites",
                     values = nmds_ps.b.r_colors_by_name, 
                     guide = 'none') +
  theme(axis.text.x = element_text(angle = 40,
                                   vjust = 1,
                                   hjust = 1,
                                   size = 9),
        axis.title = element_blank(),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20"))
plot_grid(p1,p2,p3,
          nrow = 3,
          rel_heights = c(1,1,1))
```

Not at the site level, but how about if we divide them into the groups of samples we've seen for the ```CAP```?

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height=10}
my_comparisons <- list( c("FeOB-rich", "SOB-rich"))

my_comparisons2 <- list( c("April", "August"), c("April","December"),
                         c("August","December"))
p4 = plot_richness(ps.b,
              x="Site_type", color="Site_type",
              measures="Observed", title = "Richness") +
  geom_violin() +
  geom_jitter(shape=16, position=position_jitter(0.2)) + 
  # stat_compare_means(comparisons = my_comparisons)+
  stat_compare_means(comparisons = my_comparisons,
                     method = "t.test",
                     var.equal="welch",
                     label.x.npc = "right", 
                     label.y.npc = "top",
                     symnum.args = list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05,0.01, 1), 
                       symbols = c("p<0.0001", "p<0.001", "p<0.01", "p<0.05","p<0.1", "ns"))) +
  scale_y_continuous(limits = c(0,3700)) +
  scale_color_manual(values=c("gray52","gray73")) +
  facet_wrap(variable~Month, scales = "free") +
  labs(color="Site type") +
  theme(axis.text.x = element_text(angle = 20,
                                   vjust = 1,
                                   hjust = 1,
                                   size = 12),
        axis.title = element_blank(),
        strip.text = element_text(size = 12, margin = margin()),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "gray89", colour = "grey20"))
p5 = plot_richness(ps.b,
              x="Site_type", color="Site_type",
              measures="Shannon", title="Shannon's Diversity") +
  geom_violin() +
  geom_jitter(shape=16, position=position_jitter(0.2)) + 
  # stat_compare_means(comparisons = my_comparisons)+
  stat_compare_means(comparisons = my_comparisons,
                     method = "t.test",
                     var.equal="welch",
                     label.x.npc = "right", 
                     label.y.npc = "top",
                     symnum.args = list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05,0.01, 1), 
                       symbols = c("p<0.0001", "p<0.001", "p<0.01", "p<0.05","p<0.1", "ns"))) +
  scale_y_continuous(limits = c(0,8)) +
  scale_color_manual(values=c("gray52","gray73")) +
  facet_wrap(variable~Month, scales = "free") +
  labs(color="Site type") +
  theme(axis.text.x = element_text(angle = 20,
                                   vjust = 1,
                                   hjust = 1,
                                   size = 12),
        axis.title = element_blank(),
        strip.text = element_text(size = 12, margin = margin()),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "gray89", colour = "grey20"))
p6 = plot_richness(ps.b,
              x="Site_type", color="Site_type",
              measures="Simpson", title = "Simpson's Evenness") +
  geom_violin() +
  geom_jitter(shape=16, position=position_jitter(0.2)) + 
  # stat_compare_means(comparisons = my_comparisons)+
  stat_compare_means(comparisons = my_comparisons,
                     method = "t.test",
                     var.equal="welch",
                     label.x.npc = "right", 
                     label.y.npc = "top",
                     symnum.args = list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05,0.01, 1), 
                       symbols = c("p<0.0001", "p<0.001", "p<0.01", "p<0.05","p<0.1", "ns"))) +
  scale_y_continuous(limits = c(0,1.1)) +
  scale_color_manual(values=c("gray52","gray73")) +
  facet_wrap(variable~Month, scales = "free") +
  labs(color="Site type") +
  theme(axis.text.x = element_text(angle = 20,
                                   vjust = 1,
                                   hjust = 1,
                                   size = 12),
        axis.title = element_blank(),
        strip.text = element_text(size = 12, margin = margin()),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "gray89", colour = "grey20"))
plot_grid(p4,p5,p6,
          nrow = 3,
          rel_heights = c(1,1,1))
```

Does seasonality affect Beta- or Epsilonproteobacteria relative abundances?

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=4}
# geochem_com_table$Site.name = factor(geochem_com_table$Site.name, 
#                                                        levels = c("Celynen North","Crumlin Navigation","Six Bells",
#                                                                   "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
#                                                                   "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
#                                                                   "Taff's Well"))
# ggplot(geochem_com_table, 
#        aes(x=Site.name, y=EpsBetRatio,
#            color=Site.name, size=EpsBetRatio)) +
#   geom_point(shape = 1, stroke = 2) +
#   scale_color_manual("Sites",values = nmds_ps.b.r_colors_by_name, guide = 'none') +
#   scale_size_continuous("Beta-/Epsilonprot. \nratio") +
#   facet_wrap(Month~.) +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_text(angle = 40, hjust = 1),
#         legend.box = "horizontal",
#         panel.background = element_rect(fill = "white", colour = NA),
#         panel.border     = element_rect(fill = NA, colour = "grey20"),
#         panel.grid = element_line(colour = "grey92"),
#         panel.grid.minor = element_line(size = rel(0.5)),
#         strip.background = element_rect(fill = "grey85", colour = "grey20"))
```

###**Figure 3:** Genus-level view of the dataset per month and site:

```{r include=FALSE}
ps.b.r.top_genera.glom <- speedyseq::tax_glom(ps.b.r, taxrank = 'Genus', NArm = FALSE)
ps.b.r.top_genera.glom.psdf <- data.table(psmelt(ps.b.r.top_genera.glom))
ps.b.r.top_genera.glom.psdf$Genus <- as.character(ps.b.r.top_genera.glom.psdf$Genus)

ps.b.r.top_genera.glom.psdf[, mean := mean(Abundance, na.rm = FALSE),
                 by = "Genus"]

ps.b.r.top_genera.glom.psdf[(mean <= 0.01), Genus := "Other (<1%)"]

ps.b.r.top_genera.glom.psdf$Site.name = factor(ps.b.r.top_genera.glom.psdf$Site.name,
                                                       levels = c("Celynen North","Crumlin Navigation","Six Bells",
                                                                  "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
                                                                  "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
                                                                  "Taff's Well"))
ps.b.r.top_genera.glom.psdf$Genus = factor(ps.b.r.top_genera.glom.psdf$Genus,
                                                       levels = c("Gallionella","Sideroxydans","Ferriphaselus",
                                                                  "Sulfuricurvum","Sulfurovum","Thiothrix","Rhodoferax","Other (<1%)"))

tol18rainbow=c("#771155", "#AA4488", "#CC99BB", "#114477", "#4477AA", "#77AADD", 
               "#117777", "azure3")

new.labs <- c("Celynen\nNorth","Crumlin\nNavigation","Six Bells",
              "Blaenavon","Cefn\nHengoed","Dinas","Glyncastle",
              "Morlais","Mountain\nGate","Taff\nBargoed","Ynysarwed","Lindsay",
              "Taff's Well")
names(new.labs) <- c("Celynen North","Crumlin Navigation","Six Bells",
              "Blaenavon","Cefn Hengoed","Dinas","Glyncastle",
              "Morlais","Mountain Gate","Taff Bargoed","Ynysarwed","Lindsay",
              "Taff's Well")

ps.b.r.top_genera.glom.psdf.plot<-ggplot(ps.b.r.top_genera.glom.psdf,
                                    aes(x = Month, y = Abundance/3, fill = Genus)) +
  geom_bar(stat = "identity", position = "fill",
           colour = "black", size = 0.05) +
  scale_fill_manual(values = tol18rainbow,
                     na.value = "gray40") +
  scale_y_continuous(labels = scales::percent,
                     expand = c(0,0),
                     limits = c(0,1.01)) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_text(size=15),
        axis.text.y=element_text(size=14),
        axis.text.x = element_text(angle = 35, hjust = 1, size = 12),
        strip.background = element_blank(),
        strip.text = element_text(face = "bold",size = 14),
        legend.text = element_text(size=13),
        legend.title = element_text(size=15)) +
  guides(fill = guide_legend(keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance\n") +
  facet_wrap(~Site.name, nrow = 1,
             labeller = labeller(Site.name=new.labs))
```
```{r echo=FALSE, fig.height=8, fig.width=20}
ps.b.r.top_genera.glom.psdf.plot
```

<!-- How much of the sample profiles are explained by genus-level taxonomy? -->

<!-- ```{r echo=FALSE} -->
<!-- nonna_genus = ps.b %>% -->
<!--   subset_taxa(Genus != "NA") -->
<!-- nonna_genus_ab = sum(rowSums(otu_table(nonna_genus))) -->

<!-- na_genab=sum(ps.b.r.top_genera.glom.psdf2[is.na(ps.b.r.top_genera.glom.psdf2$Genus),]$Abundance) -->

<!-- na_genab/nonna_genus_ab*100 -->
<!-- ``` -->

<!-- How much of Betaproteobacteria does genus *Gallionella* explain? -->
<!-- ```{r echo=FALSE} -->
<!-- gal_gen = ps.b %>% -->
<!--   subset_taxa(Genus == "Gallionella") -->
<!-- gal_genab = sum(rowSums(otu_table(gal_gen))) -->

<!-- gal_genab/betapab*100 -->
<!-- ``` -->
<!-- ...and *Sideroxydans*? -->
<!-- ```{r echo=FALSE} -->
<!-- sid_gen = ps.b %>% -->
<!--   subset_taxa(Genus == "Sideroxydans") -->
<!-- sid_genab = sum(rowSums(otu_table(sid_gen))) -->

<!-- sid_genab/betapab*100 -->
<!-- ``` -->
<!-- *Gallionella* + *Sideroxydans* in Betaproteobacteria -->
<!-- ```{r echo=FALSE} -->
<!-- (sid_genab/betapab*100)+(gal_genab/betapab*100) -->
<!-- ``` -->

<!-- Quick one: How dominating is *Ferriphaselus* in December at Taff's Well? -->
<!-- ```{r echo=FALSE} -->
<!-- fer_dec_tw = ps.b %>% -->
<!--   subset_samples(Site.name == "Taff's Well") %>% -->
<!--   subset_samples(Month == "December") %>%  -->
<!--   subset_taxa(Genus == "Ferriphaselus") -->
<!-- fer_dec_tw_ab = sum(rowSums(otu_table(fer_dec_tw))) -->

<!-- dec_tw = ps.b %>% -->
<!--   subset_samples(Site.name == "Taff's Well") %>% -->
<!--   subset_samples(Month == "December") -->
<!-- dec_tw_ab = sum(rowSums(otu_table(dec_tw))) -->

<!-- fer_dec_tw_ab/dec_tw_ab*100 -->
<!-- ``` -->

<!-- How about Epsilonproteobacteria and *Sulfuricurvum*? -->
<!-- ```{r echo=FALSE} -->
<!-- sulfuri = ps.b %>% -->
<!--   subset_taxa(Class == "Epsilonproteobacteria") %>%  -->
<!--   subset_taxa(Genus == "Sulfuricurvum") -->
<!-- sulfuri_ab = sum(rowSums(otu_table(sulfuri))) -->

<!-- epsi = ps.b %>% -->
<!--   subset_taxa(Class == "Epsilonproteobacteria") -->
<!-- epsipab=sum(rowSums(otu_table(epsi))) -->

<!-- sulfuri_ab/epsipab*100 -->
<!-- ``` -->
<!-- ... and *Sulfurovum*? -->
<!-- ```{r echo=FALSE} -->
<!-- sulfuro = ps.b %>% -->
<!--   subset_taxa(Class == "Epsilonproteobacteria") %>%  -->
<!--   subset_taxa(Genus == "Sulfurovum") -->
<!-- sulfuro_ab = sum(rowSums(otu_table(sulfuro))) -->

<!-- sulfuro_ab/epsipab*100 -->
<!-- ``` -->
<!-- *Sulfuricurvum* + *Sulfurovum* in Epsilonproteobacteria -->
<!-- ```{r echo=FALSE} -->
<!-- (sulfuri_ab/epsipab*100)+(sulfuro_ab/epsipab*100) -->
<!-- ``` -->
<!-- What were the maximum average (across replicates) relative abundance seen for *Thiothrix*? -->
<!-- ```{r echo=FALSE} -->
<!-- mean(head(ps.b.r.top_genera.glom.psdf[ps.b.r.top_genera.glom.psdf$Genus == "Thiothrix",]$Abundance*100,n=3)) -->
<!-- sd(head(ps.b.r.top_genera.glom.psdf[ps.b.r.top_genera.glom.psdf$Genus == "Thiothrix",]$Abundance*100,n=3)) -->
<!-- print(head(ps.b.r.top_genera.glom.psdf[ps.b.r.top_genera.glom.psdf$Genus == "Thiothrix",]$Site.name,n=1), max.levels=0) -->
<!-- print(head(ps.b.r.top_genera.glom.psdf[ps.b.r.top_genera.glom.psdf$Genus == "Thiothrix",]$Month,n=1), max.levels=0) -->
<!-- ``` -->
<!-- ....and *Paucibacter*? -->
<!-- ```{r echo=FALSE} -->
<!-- mean(head(ps.b.r.top_genera.glom.psdf[ps.b.r.top_genera.glom.psdf$Genus == "Paucibacter",]$Abundance*100,n=3)) -->
<!-- sd(head(ps.b.r.top_genera.glom.psdf[ps.b.r.top_genera.glom.psdf$Genus == "Paucibacter",]$Abundance*100,n=3)) -->
<!-- print(head(ps.b.r.top_genera.glom.psdf[ps.b.r.top_genera.glom.psdf$Genus == "Paucibacter",]$Site.name,n=1), max.levels=0) -->
<!-- print(head(ps.b.r.top_genera.glom.psdf[ps.b.r.top_genera.glom.psdf$Genus == "Paucibacter",]$Month,n=1), max.levels=0) -->
<!-- ``` -->

<!-- How does geochem look overall? -->

<!-- ```{r echo=FALSE, fig.height=8, fig.width=8} -->
<!-- library(ggforce) -->
<!-- pca_table_mM=read.csv("/media/andre/B2F8C9A0F8C962E9/SGG_16S_analysis/SGG_16S_metadata/SGG_hydro_and_geochemistry_v3_tidy_mM.csv",  -->
<!--                       header=TRUE) -->

<!-- # pca_table_mM_noNA = pca_table_mM[ , colSums(is.na(pca_table_mM)) == 0] -->

<!-- pca_table_mM = pca_table_mM[!grepl("Taff's Well PUMPED", pca_table_mM$Site.name),] -->
<!-- pca_table_mM = pca_table_mM[!grepl("Control", pca_table_mM$Sample_type),] -->

<!-- pca_table_mM$NaCa_ratio = (pca_table_mM$Na/(pca_table_mM$Na + pca_table_mM$Ca)) -->

<!-- ggplot(pca_table_mM, aes(Cl, NaCa_ratio, size=Temp.C, -->
<!--                       color=Site.name, shape=Month)) + -->
<!--   geom_point(alpha=0.6) + -->
<!--   geom_vline(xintercept = 0.75, linetype="dashed") + -->
<!--   geom_hline(yintercept = 0.5, linetype="dashed") + -->
<!--   scale_x_log10() + -->
<!--   scale_color_manual("Site Name",values=nmds_ps.b.r_colors_by_name) + -->
<!--   scale_y_continuous("Na/Ca ratio") + -->
<!--   guides(colour = guide_legend(override.aes = list(size=6)), -->
<!--          shape = guide_legend(override.aes = list(size=6)), -->
<!--          size=guide_legend(title = "Temperature (C)")) + -->
<!--   theme(panel.background = element_rect(fill = "white", colour = NA), -->
<!--         panel.border     = element_rect(fill = NA, colour = "grey20"), -->
<!--         panel.grid = element_line(colour = "grey92"), -->
<!--         panel.grid.minor = element_line(size = rel(0.5)), -->
<!--         strip.background = element_rect(fill = "grey85", colour = "grey20")) -->
<!-- ``` -->

<!-- In 3D as well :D -->

<!-- ```{r echo=FALSE} -->
<!-- set.seed(417) -->
<!-- library(plotly) -->
<!-- library(magrittr) -->

<!-- shapes = c("April" = 27, -->
<!--            "August" = 29, -->
<!--            "December" = 31) -->
<!-- shapes2 = c("square", "circle", "diamond") -->

<!-- f <- list( -->
<!--   family = "Arial", -->
<!--   size = 18, -->
<!--   color = "#7f7f7f" -->
<!-- ) -->
<!-- x <- list( -->
<!--   title = "Cl (mM)", -->
<!--   titlefont = f -->
<!-- ) -->
<!-- y <- list( -->
<!--   title = "Na/Ca ratio", -->
<!--   titlefont = f -->
<!-- ) -->
<!-- z <- list( -->
<!--   title = "Temperature (ºC)", -->
<!--   titlefont = f -->
<!-- ) -->

<!-- # p =  -->
<!-- plot_ly(x=pca_table_mM$Cl, y=pca_table_mM$NaCa_ratio, z=pca_table_mM$Temp.C, -->
<!--         type="scatter3d", mode="markers",  -->
<!--         color=pca_table_mM$Site.name, -->
<!--         # fillcolor=nmds_ps.b.r_colors_by_name, -->
<!--         colors = nmds_ps.b.r_colors_by_name, -->
<!--         span = pca_table_mM$Temp.C, -->
<!--         symbol = pca_table_mM$Month, -->
<!--         symbols = shapes2, -->
<!--         opacity = 0.6) %>%  -->
<!-- layout(title = '#SGG Geochemistry across sites', -->
<!--        scene = list(xaxis=x, -->
<!--                       yaxis=y, -->
<!--                       zaxis=z)) -->

<!-- # api_create(p, filename = "SGG_3D_plot") -->
<!-- ``` -->

```{r echo=FALSE, message=FALSE, warning=FALSE}
#http://geekwentfreak.com/posts/stats/pearson_correlation_normality/
metadata_cor_main_genera = ps.b.r.top_genera.glom.psdf[, c("Genus", "Abundance", "Site.name", "Month", "Time_point","SO4",
                                                     "DO","Temp.C","pH",
                                                     "X55_Mn","Mg","X68_Zn","Na","X6_Li",
                                                     "X135_Ba","X11_B","X75_As_He","X59_Co",
                                                     "X63_Cu","X78_Se","X200_Hg","X201_Hg","X202_Hg")]
names(metadata_cor_main_genera) = c("Genus", "Abundance", "Site_name", "Month", 
                                    "Time_point","SO4","DO","Temp","pH"
                                    ,"Mn","Mg","Zn","Na","Li","Ba",
                                    "B","As","Co","Cu","Se","200_Hg","201_Hg","202_Hg")

cor_genera_geochem = as(metadata_cor_main_genera[, c("Genus", "Abundance", "Site_name", "Month",
                                                     "Temp","SO4","DO","pH",
                                                     "Mn","Mg","Zn","Na","Li","Ba",
                                                     "B","As","Co","Cu","Se","200_Hg","201_Hg","202_Hg")], "data.frame")
cor_genera_geochem_gal = subset(cor_genera_geochem, Genus=="Gallionella")
cor_genera_geochem_sid = subset(cor_genera_geochem, Genus=="Sideroxydans")
cor_genera_geochem_fer = subset(cor_genera_geochem, Genus=="Ferriphaselus")
cor_genera_geochem_sulfuri = subset(cor_genera_geochem, Genus=="Sulfuricurvum")
cor_genera_geochem_sulfuro = subset(cor_genera_geochem, Genus=="Sulfurovum")

cor_genera_geochem_gal <- cor_genera_geochem_gal[, -which(names(cor_genera_geochem_gal) %in% c("Genus","Site_name","Month"))]
cor_genera_geochem_gal_ggcorr<-ggcorr(cor_genera_geochem_gal, 
                                           method = c("complete.obs", "pearson"),
                                           label = TRUE, label_size = 3, 
                                          label_round = 2, label_alpha = TRUE,
                                           palette = "PRGn",
                                           nbreaks = 10, hjust = 1, 
                                           size=4, layout.exp = 2)

cor_genera_geochem_sid <- cor_genera_geochem_sid[, -which(names(cor_genera_geochem_sid) %in% c("Genus","Site_name","Month"))]
cor_genera_geochem_sid_ggcorr<-ggcorr(cor_genera_geochem_sid, 
                                           method = c("complete.obs", "pearson"),
                                           label = TRUE, label_size = 3, 
                                          label_round = 2, label_alpha = TRUE,
                                           palette = "PRGn",
                                           nbreaks = 10, hjust = 1, 
                                           size=4, layout.exp = 2)

cor_genera_geochem_fer <- cor_genera_geochem_fer[, -which(names(cor_genera_geochem_fer) %in% c("Genus","Site_name","Month"))]
cor_genera_geochem_fer_ggcorr<-ggcorr(cor_genera_geochem_fer, 
                                           method = c("complete.obs", "pearson"),
                                           label = TRUE, label_size = 3, 
                                           label_round = 2, label_alpha = TRUE,
                                           palette = "PRGn",
                                           nbreaks = 10, hjust = 1, 
                                           size=4, layout.exp = 2)

cor_genera_geochem_sulfuri <- cor_genera_geochem_sulfuri[, -which(names(cor_genera_geochem_sulfuri) %in% c("Genus","Site_name","Month"))]
cor_genera_geochem_sulfuri_ggcorr<-ggcorr(cor_genera_geochem_sulfuri, 
                                           method = c("complete.obs", "pearson"),
                                           label = TRUE, label_size = 3, 
                                          label_round = 2, label_alpha = TRUE,
                                           palette = "PRGn",
                                           nbreaks = 10, hjust = 1, 
                                           size=4, layout.exp = 2)

cor_genera_geochem_sulfuro <- cor_genera_geochem_sulfuro[, -which(names(cor_genera_geochem_sulfuro) %in% c("Genus","Site_name","Month"))]
cor_genera_geochem_sulfuro_ggcorr<-ggcorr(cor_genera_geochem_sulfuro, 
                                           method = c("complete.obs", "pearson"),
                                           label = TRUE, label_size = 3, 
                                          label_round = 2, label_alpha = TRUE,
                                           palette = "PRGn",
                                           nbreaks = 10, hjust = 1, 
                                           size=4, layout.exp = 2)

#THIS IS SO LAZY

pearson_gal = head(cor_genera_geochem_gal_ggcorr$data, n=18)
pearson_gal$y = "Gallionella"
pearson_gal$x = c("Temp","SO4","DO","pH",
                  "Mn","Mg","Zn","Na","Li","Ba",
                  "B","As","Co","Cu","Se","200_Hg","201_Hg","202_Hg")
pearson_sid = head(cor_genera_geochem_sid_ggcorr$data, n=18)
pearson_sid$y = "Sideroxydans"
pearson_sid$x = c("Temp","SO4","DO","pH",
                  "Mn","Mg","Zn","Na","Li","Ba",
                  "B","As","Co","Cu","Se","200_Hg","201_Hg","202_Hg")
pearson_fer = head(cor_genera_geochem_fer_ggcorr$data, n=18)
pearson_fer$y = "Ferriphaselus"
pearson_fer$x = c("Temp","SO4","DO","pH",
                  "Mn","Mg","Zn","Na","Li","Ba",
                  "B","As","Co","Cu","Se","200_Hg","201_Hg","202_Hg")
pearson_sulfuri = head(cor_genera_geochem_sulfuri_ggcorr$data, n=18)
pearson_sulfuri$y = "Sulfuricurvum"
pearson_sulfuri$x = c("Temp","SO4","DO","pH",
                  "Mn","Mg","Zn","Na","Li","Ba",
                  "B","As","Co","Cu","Se","200_Hg","201_Hg","202_Hg")
pearson_sulfuro = head(cor_genera_geochem_sulfuro_ggcorr$data, n=18)
pearson_sulfuro$y = "Sulfurovum"
pearson_sulfuro$x = c("Temp","SO4","DO","pH",
                  "Mn","Mg","Zn","Na","Li","Ba",
                  "B","As","Co","Cu","Se","200_Hg","201_Hg","202_Hg")

#this is the correlation coefs table done. now for significance
#help from https://stackoverflow.com/questions/12196756/significance-level-added-to-matrix-correlation-heatmap-using-ggplot2

# Function to get the probability into a whole matrix not half, here is Spearman you can change it to Kendall or Pearson
cor.prob.all <- function (X, dfr = nrow(X) - 2) {
R <- cor(X, use="complete.obs",method="pearson")
r2 <- R^2
Fstat <- r2 * dfr/(1 - r2)
R<- 1 - pf(Fstat, 1, dfr)
R[row(R) == col(R)] <- NA
R
}

cor_genera_geochem_gal_p=cor.prob.all(cor_genera_geochem_gal)
cor_genera_geochem_sid_p=cor.prob.all(cor_genera_geochem_sid)
cor_genera_geochem_fer_p=cor.prob.all(cor_genera_geochem_fer)
cor_genera_geochem_sulfuri_p=cor.prob.all(cor_genera_geochem_sulfuri)
cor_genera_geochem_sulfuro_p=cor.prob.all(cor_genera_geochem_sulfuro)

cor_genera_geochem_gal_p <- data.frame(row=rownames(cor_genera_geochem_gal_p),cor_genera_geochem_gal_p) # create a column called "row" 
rownames(cor_genera_geochem_gal_p) <- NULL
cor_genera_geochem_gal_p.m <- head(melt(cor_genera_geochem_gal_p),n=19)[-1,]
cor_genera_geochem_gal_p.m$value2<-cut(cor_genera_geochem_gal_p.m$value,
                                       breaks=c(-Inf, 0.001, 0.01, 0.05),label=c("***", "** ", "*  ")) 
cor_genera_geochem_gal_p.m[is.na(cor_genera_geochem_gal_p.m)] <- ""
gal_pearson_pvalue<-cbind(pearson_gal,cor_genera_geochem_gal_p.m)
cor_genera_geochem_gal <- gal_pearson_pvalue[, -which(names(gal_pearson_pvalue) %in% c("row","variable"))]
names(cor_genera_geochem_gal)[6]<-paste("valuep")
names(cor_genera_geochem_gal)[7]<-paste("signif.")

cor_genera_geochem_sid_p <- data.frame(row=rownames(cor_genera_geochem_sid_p),cor_genera_geochem_sid_p) # create a column called "row" 
rownames(cor_genera_geochem_sid_p) <- NULL
cor_genera_geochem_sid_p.m <- head(melt(cor_genera_geochem_sid_p),n=19)[-1,]
cor_genera_geochem_sid_p.m$value2<-cut(cor_genera_geochem_sid_p.m$value,
                                       breaks=c(-Inf, 0.001, 0.01, 0.05),label=c("***", "** ", "*  ")) 
cor_genera_geochem_sid_p.m[is.na(cor_genera_geochem_sid_p.m)] <- ""
sid_pearson_pvalue<-cbind(pearson_sid,cor_genera_geochem_sid_p.m)
cor_genera_geochem_sid <- sid_pearson_pvalue[, -which(names(sid_pearson_pvalue) %in% c("row","variable"))]
names(cor_genera_geochem_sid)[6]<-paste("valuep")
names(cor_genera_geochem_sid)[7]<-paste("signif.")

cor_genera_geochem_fer_p <- data.frame(row=rownames(cor_genera_geochem_fer_p),cor_genera_geochem_fer_p) # create a column called "row" 
rownames(cor_genera_geochem_fer_p) <- NULL
cor_genera_geochem_fer_p.m <- head(melt(cor_genera_geochem_fer_p),n=19)[-1,]
cor_genera_geochem_fer_p.m$value2<-cut(cor_genera_geochem_fer_p.m$value,
                                       breaks=c(-Inf, 0.001, 0.01, 0.05),label=c("***", "** ", "*  ")) 
cor_genera_geochem_fer_p.m[is.na(cor_genera_geochem_fer_p.m)] <- ""
fer_pearson_pvalue<-cbind(pearson_fer,cor_genera_geochem_fer_p.m)
cor_genera_geochem_fer <- fer_pearson_pvalue[, -which(names(fer_pearson_pvalue) %in% c("row","variable"))]
names(cor_genera_geochem_fer)[6]<-paste("valuep")
names(cor_genera_geochem_fer)[7]<-paste("signif.")

cor_genera_geochem_sulfuri_p <- data.frame(row=rownames(cor_genera_geochem_sulfuri_p),cor_genera_geochem_sulfuri_p) # create a column called "row" 
rownames(cor_genera_geochem_sulfuri_p) <- NULL
cor_genera_geochem_sulfuri_p.m <- head(melt(cor_genera_geochem_sulfuri_p),n=19)[-1,]
cor_genera_geochem_sulfuri_p.m$value2<-cut(cor_genera_geochem_sulfuri_p.m$value,
                                       breaks=c(-Inf, 0.001, 0.01, 0.05),label=c("***", "** ", "*  ")) 
cor_genera_geochem_sulfuri_p.m[is.na(cor_genera_geochem_sulfuri_p.m)] <- ""
sulfuri_pearson_pvalue<-cbind(pearson_sulfuri,cor_genera_geochem_sulfuri_p.m)
cor_genera_geochem_sulfuri <- sulfuri_pearson_pvalue[, -which(names(sulfuri_pearson_pvalue) %in% c("row","variable"))]
names(cor_genera_geochem_sulfuri)[6]<-paste("valuep")
names(cor_genera_geochem_sulfuri)[7]<-paste("signif.")

cor_genera_geochem_sulfuro_p <- data.frame(row=rownames(cor_genera_geochem_sulfuro_p),cor_genera_geochem_sulfuro_p) # create a column called "row" 
rownames(cor_genera_geochem_sulfuro_p) <- NULL
cor_genera_geochem_sulfuro_p.m <- head(melt(cor_genera_geochem_sulfuro_p),n=19)[-1,]
cor_genera_geochem_sulfuro_p.m$value2<-cut(cor_genera_geochem_sulfuro_p.m$value,
                                       breaks=c(-Inf, 0.001, 0.01, 0.05),label=c("***", "** ", "*  ")) 
cor_genera_geochem_sulfuro_p.m[is.na(cor_genera_geochem_sulfuro_p.m)] <- ""
sulfuro_pearson_pvalue<-cbind(pearson_sulfuro,cor_genera_geochem_sulfuro_p.m)
cor_genera_geochem_sulfuro <- sulfuro_pearson_pvalue[, -which(names(sulfuro_pearson_pvalue) %in% c("row","variable"))]
names(cor_genera_geochem_sulfuro)[6]<-paste("valuep")
names(cor_genera_geochem_sulfuro)[7]<-paste("signif.")

#
replot_pearson = rbind(cor_genera_geochem_gal,cor_genera_geochem_sid,cor_genera_geochem_fer,
                       cor_genera_geochem_sulfuri,cor_genera_geochem_sulfuro)
# replot_pearson$x<-pearson_gal$x


low="#af8dc3"
mid="#f7f7f7"
high="#7fbf7b"

replot_pearson$x = factor(replot_pearson$x,levels = c("Temp","DO","pH","SO4","As","B","Ba","Co","Cu",
                                                      "Li","Mg","Mn","Na","Se","Zn","200_Hg","201_Hg","202_Hg"))
replot_pearson$y = factor(replot_pearson$y,levels = c("Sulfurovum","Sulfuricurvum",
                                                      "Ferriphaselus","Sideroxydans","Gallionella"))
#maybe keeping tile size proportional to pvalue?
# replot_pearson$trans_valuep <- abs(log(replot_pearson$valuep))/45
# replot_pearson$trans_valuep[which(!is.finite(replot_pearson$trans_valuep))] <- 0
  # geom_tile(aes(fill=breaks, height=trans_valuep, width=trans_valuep)) +
  # scale_size_manual(values=c(1,3,5,7),
  #                    labels=c("<0.001", "<0.01", "<0.05",NA)) +

replot_pearson_plot <- ggplot(replot_pearson,
       aes(x, y)) +
  geom_tile(aes(fill=breaks, width=0.8, height=0.8)) +
  geom_tile(data=replot_pearson[!is.na(replot_pearson$signif.),],
            aes(color=signif., width=0.9, height=0.9), fill="transparent", size=1) +
  coord_equal() +
  geom_text(aes(label = label,
                alpha = abs(coefficient)), 
            size = 4, color = "black") +
  scale_fill_manual(values = colorRampPalette(c(low, mid, high))(length(levels(replot_pearson$breaks))),
                    drop = FALSE, 
                    labels = c("-1, -0.8","-0.8, -0.6","-0.6, -0.4","-0.4, -0.2","-0.2, 0",
                               "0, 0.2","0.2, 0.4","0.4, 0.6","0.6, 0.8","0.8, 1")) +
  scale_color_manual(values=c("gray30","gray63","gray87"),
                     labels=c("<0.001", "<0.01", "<0.05")) +
  labs(title = "Pearson coefficients",
       subtitle = "Using non-transformed relative abundances and metadata variables" ) +
  theme(title = element_text(hjust = 0),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=11,
                                   angle=30, hjust = 1),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size=11,
                                   face = "italic"),
        panel.background = element_rect(fill = "white", colour = NA),
        panel.border     = element_rect(fill = NA, colour = "grey20"),
        panel.grid = element_line(colour = "grey92"),
        panel.grid.minor = element_line(size = rel(0.5)),
        strip.background = element_rect(fill = "grey85", colour = "grey20")) +
  guides(alpha = FALSE,
         fill = guide_legend(title = "r",
                             reverse = TRUE,
                             title.theme = element_text(face="italic",
                                                        angle = 0)),
         color= guide_legend(title="Significance",
                             override.aes = list(fill="white")))
```
```{r echo=FALSE, fig.align="center", fig.width=12, fig.height=4}
replot_pearson_plot
```